<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì›¨ì´ë¸ŒA AI ì†”ë£¨ì…˜ - AI Web Designer Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <style>
    * { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
    .sidebar-bg { background-color: #003366; }
    .accent-blue { background-color: #2C96FF; }
    .accent-blue:hover { background-color: #2380e0; }
    .aspect-9-16 { aspect-ratio: 9/16; }
    .aspect-16-9 { aspect-ratio: 16/9; }
    .aspect-1-1 { aspect-ratio: 1/1; }
    .spinner { border: 3px solid rgba(44, 150, 255, 0.2); border-top-color: #2C96FF; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .design-row-label { font-size: 11px; color: #6b7280; margin-bottom: 6px; font-weight: 500; }
    .canvas-dot-grid { background-color: #e5e7eb; background-image: radial-gradient(rgba(0,0,0,0.08) 1px, transparent 1px); background-size: 20px 20px; }
    .design-card-selected { outline: 2px dashed #2C96FF !important; outline-offset: 4px; position: relative; }
    .design-card-clickable { cursor: pointer; transition: outline 0.15s ease; }
    #attachment-drop-zone.drag-over, #ai-chat-drop-zone.drag-over, #folder-view-drop-zone.drag-over { background: rgba(59, 130, 246, 0.08); outline: 2px dashed #3b82f6; outline-offset: -2px; }
    .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    #chat-container { font-size: 13px; line-height: 1.5; background-color: #ffffff !important; overflow-y: auto; overflow-x: hidden; }
    #chat-container .inline-block { font-size: inherit; word-break: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%; overflow: visible; }
    #ai-chat-messages-wrap { overflow-y: auto; overflow-x: hidden; min-height: 0; }
    #ai-chat-messages { word-break: break-word; overflow-wrap: break-word; }
    #ai-chat-messages .rounded-2xl { word-break: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%; overflow: visible; }
    #ai-chat-messages .inline-block { white-space: pre-wrap; max-width: 100%; overflow: visible; }
    .chat-bubble-user { background-color: #E6EEF3 !important; color: #1f2937; }
    .nav-item-active { background: rgba(44, 150, 255, 0.2); color: #2C96FF; border-left: 3px solid #2C96FF; }
    .nav-item-active:hover { background: rgba(44, 150, 255, 0.25); }
    .history-date-group { font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px; }
    .history-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.15s; }
    .history-item:hover { background: #f3f4f6; }
    .history-item-icon { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; }
    .history-item-icon img { width: 20px; height: 20px; object-fit: contain; }
    #contextual-sidebar { transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
    #contextual-sidebar.sidebar-collapsed { width: 0 !important; min-width: 0 !important; overflow: hidden; }
    #contextual-sidebar.sidebar-collapsed .sidebar-content { opacity: 0; pointer-events: none; }
    #contextual-sidebar.sidebar-resizing { transition: none; }
    #sidebar-resize-handle { width: 6px; cursor: col-resize; background: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 10; }
    #sidebar-resize-handle:hover { background: rgba(44, 150, 255, 0.2); }
    #sidebar-resize-handle::after { content: ''; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 2px; height: 40px; background: #d1d5db; border-radius: 1px; opacity: 0; transition: opacity 0.15s; }
    #sidebar-resize-handle:hover::after { opacity: 1; }
    #canvas-scroll-area.canvas-cardnews-mode { align-items: flex-start; justify-content: flex-start; }
    #canvas-zoom-outer.canvas-cardnews-mode { align-items: flex-start !important; justify-content: flex-start !important; }
    #canvas-zoom-wrapper.canvas-cardnews-mode { transform-origin: top left !important; }
    .sidebar-chat-area { border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    #task-list-overlay { transition: opacity 0.2s; }
    .sidebar-toggle-btn { color: #003366; transition: background-color 0.15s, color 0.15s; }
    .sidebar-toggle-btn:hover { background-color: rgba(0, 51, 102, 0.08); color: #003366; }
    .ai-chat-mode-select-option { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; width: 100%; padding: 12px 16px; text-align: left; background: transparent; border: none; cursor: pointer; transition: background 0.15s; }
    .ai-chat-mode-select-option:hover { background: #f3f4f6; }
    .ai-chat-mode-select-option .option-check { flex-shrink: 0; width: 20px; height: 20px; border-radius: 50%; background: #2C96FF; color: white; display: flex; align-items: center; justify-content: center; }
    .ai-chat-mode-select-option .option-check.hidden { display: none !important; }
    .ai-chat-mode-select-option .option-check svg { width: 12px; height: 12px; }
    .history-item-menu { opacity: 0; transition: opacity 0.15s; }
    .history-item:hover .history-item-menu { opacity: 1; }
    .history-item-menu-btn { padding: 4px; border-radius: 4px; color: #9ca3af; }
    .history-item-menu-btn:hover { background: #f3f4f6; color: #374151; }
    .history-item-dropdown { position: absolute; right: 0; top: 100%; margin-top: 2px; min-width: 140px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; padding: 4px; display: flex; }
    .history-item-dropdown-main { min-width: 140px; }
    .history-item-dropdown button { display: block; width: 100%; text-align: left; padding: 8px 12px; font-size: 13px; color: #374151; border-radius: 6px; border: none; background: none; cursor: pointer; }
    .history-item-dropdown button:hover { background: #f3f4f6; }
    .history-item-dropdown-submenu { position: absolute; right: 100%; left: auto; top: 0; margin-right: 2px; margin-left: 0; min-width: 160px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 4px; }
    .history-item-dropdown-submenu button { display: flex; align-items: center; gap: 8px; }
    .folder-items-panel { max-height: 200px; overflow-y: auto; border-top: 1px solid #e5e7eb; }
    .folder-item-row { display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer; border-radius: 8px; transition: background 0.15s; }
    .folder-item-row:hover { background: #f3f4f6; }
    .task-folder-header { display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 6px; }
    .task-folder-header:hover { background: #f3f4f6; }
    .task-folder-items { padding-left: 12px; border-left: 2px solid #e5e7eb; margin-left: 6px; }
    .task-folder-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; font-size: 13px; color: #374151; border-radius: 6px; cursor: pointer; position: relative; }
    .task-folder-menu { opacity: 0; transition: opacity 0.15s; }
    .task-folder-row:hover .task-folder-menu { opacity: 1; }
    .task-folder-row:hover { background: #f3f4f6; }
    .task-folder-row .folder-icon { font-size: 16px; }
    /* ChatGPT ìŠ¤íƒ€ì¼ í´ë” ë·° (ë©”ì¸ ì˜ì—­) */
    .folder-view-container { display: flex; flex-direction: column; flex: 1; min-height: 0; width: 100%; max-width: 42rem; margin-left: auto; margin-right: auto; }
    .folder-view-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 0 16px; border-b border-gray-100; }
    .folder-view-header-left { display: flex; align-items: center; gap: 10px; }
    .folder-view-header .folder-icon { font-size: 28px; }
    .folder-view-header h1 { font-size: 22px; font-weight: 600; color: #111827; }
    .folder-view-new-chat-btn { padding: 8px 16px; font-size: 13px; color: #374151; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; transition: background 0.15s; }
    .folder-view-new-chat-btn:hover { background: #e5e7eb; }
    .folder-view-input-wrap { padding: 16px 0; border-b border-gray-100; }
    .folder-view-input { width: 100%; padding: 14px 18px; font-size: 14px; border: none; border-radius: 12px; background: transparent; outline: none; transition: border-color 0.15s; }
    .folder-view-input:focus { outline: none; }
    .folder-view-input::placeholder { color: #9ca3af; }
    .chat-input-auto-resize { overflow-y: auto; resize: none; min-height: 44px; max-height: 200px; }
    .rules-input-auto-resize { overflow-y: auto; resize: none; min-height: 40px; max-height: 72px; }
    .folder-view-list { flex: 1; overflow-y: auto; padding: 16px 0; }
    .folder-view-item { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; padding: 16px 20px; border-radius: 12px; cursor: pointer; transition: background 0.15s; }
    .folder-view-item:hover { background: #f3f4f6; }
    .folder-view-item-main { flex: 1; min-width: 0; }
    .folder-view-item-title { font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 4px; }
    .folder-view-item-sub { font-size: 13px; color: #6b7280; line-height: 1.4; }
    .folder-view-item-date { flex-shrink: 0; font-size: 12px; color: #9ca3af; }
    /* í´ë” ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ (API ì„¤ì • UI í˜•íƒœ) */
    .folder-name-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
    .folder-name-modal-backdrop.hidden { display: none; }
    .folder-name-modal { background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; width: 90%; max-width: 320px; padding: 16px; }
    .folder-name-modal h3 { font-size: 14px; font-weight: 600; color: #1f2937; margin: 0 0 12px; text-align: left; }
    .folder-name-modal input { width: 100%; padding: 10px 16px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; box-sizing: border-box; }
    .folder-name-modal input:focus { border-color: #2C96FF; box-shadow: 0 0 0 1px #2C96FF; }
    .folder-name-modal input::placeholder { color: #9ca3af; }
    .folder-name-modal .folder-name-modal-actions { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
    .folder-name-modal .folder-name-modal-save { padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; flex: 1; background: #2C96FF; color: white; border: none; cursor: pointer; }
    .folder-name-modal .folder-name-modal-save:hover { background: #2380e0; }
    /* ì‡¼í•‘ ì˜¤ë¥˜ ëª¨ë‹¬ (API ì„¤ì • UI ìŠ¤íƒ€ì¼) */
    .shopping-error-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
    .shopping-error-modal-backdrop.hidden { display: none; }
    .shopping-error-modal { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; width: 90%; max-width: 360px; padding: 20px; }
    .shopping-error-modal h3 { font-size: 15px; font-weight: 600; color: #1f2937; margin: 0 0 12px; display: flex; align-items: center; gap: 8px; }
    .shopping-error-modal .shopping-error-body { font-size: 14px; color: #4b5563; line-height: 1.5; margin-bottom: 16px; white-space: pre-wrap; }
    .shopping-error-modal .shopping-error-actions { display: flex; justify-content: flex-end; }
    .shopping-error-modal .shopping-error-ok { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; background: #2C96FF; color: white; border: none; cursor: pointer; }
    .shopping-error-modal .shopping-error-ok:hover { background: #2380e0; }
    /* í™ˆ ë·° (ì  ìŠ¤íŒŒí¬ ìŠ¤íƒ€ì¼) */
    .home-view { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 24px; background: white; min-height: 100%; }
    .home-view-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 32px; text-align: center; }
    .home-view-input-wrap { width: 100%; max-width: 560px; margin-bottom: 24px; }
    .home-view-input { width: 100%; padding: 16px 20px; font-size: 15px; border: 1px solid #e5e7eb; border-radius: 16px; background: #f9fafb; outline: none; box-sizing: border-box; }
    .home-view-input:focus { border-color: #2C96FF; background: white; }
    .home-view-input::placeholder { color: #9ca3af; }
    /* í™ˆ ì˜ì—­ ì¹´ë“œ (4ê°œ) */
    .home-view-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 720px; width: 100%; }
    .home-view-card { display: flex; flex-direction: column; align-items: flex-start; gap: 12px; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 16px; cursor: pointer; transition: all 0.2s; text-align: left; }
    .home-view-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .home-view-card .card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .home-view-card .card-title { font-size: 16px; font-weight: 700; color: #111827; }
    .home-view-card .card-desc { font-size: 13px; color: #6b7280; line-height: 1.4; }
    .home-view-card[data-home-nav="chat"] .card-icon { background: rgba(44, 150, 255, 0.15); color: #2C96FF; }
    .home-view-card[data-home-nav="chat"]:hover { border-color: #2C96FF; }
    .home-view-card[data-home-nav="create"] .card-icon { background: rgba(139, 92, 246, 0.15); color: #7c3aed; }
    .home-view-card[data-home-nav="create"]:hover { border-color: #7c3aed; }
    .home-view-card[data-home-nav="sns-flow"] .card-icon { background: rgba(13, 148, 136, 0.15); color: #0d9488; }
    .home-view-card[data-home-nav="sns-flow"]:hover { border-color: #0d9488; }
    .home-view-card[data-home-nav="shopping"] .card-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .home-view-card[data-home-nav="shopping"]:hover { border-color: #f59e0b; }
    .home-view-create-sub { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
    .home-view-create-sub button { padding: 8px 14px; font-size: 12px; font-weight: 600; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #4b5563; cursor: pointer; transition: all 0.15s; }
    .home-view-create-sub button:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }
    .home-view-create-sub button[data-home-nav="image"] { border-color: rgba(139, 92, 246, 0.4); color: #7c3aed; }
    .home-view-create-sub button[data-home-nav="image"]:hover { background: rgba(139, 92, 246, 0.08); }
    .home-view-create-sub button[data-home-nav="cardnews"] { border-color: rgba(234, 88, 12, 0.4); color: #ea580c; }
    .home-view-create-sub button[data-home-nav="cardnews"]:hover { background: rgba(234, 88, 12, 0.08); }
    .home-view-create-sub button[data-home-nav="video"] { border-color: rgba(16, 185, 129, 0.4); color: #10b981; }
    .home-view-create-sub button[data-home-nav="video"]:hover { background: rgba(16, 185, 129, 0.08); }
  </style>
</head>
<body class="h-screen overflow-hidden bg-gray-100">
  <!-- file:// ë¡œ ì—´ì—ˆì„ ë•Œ ì•ˆë‚´ ë°°ë„ˆ (ì‡¼í•‘/ì˜ìƒ ë“± ë°±ì—”ë“œ ê¸°ëŠ¥ì´ ë™ì‘í•˜ì§€ ì•ŠìŒ) -->
  <div id="file-protocol-banner" class="hidden fixed top-0 left-0 right-0 z-[9999] bg-amber-500 text-white px-4 py-3 text-center text-sm font-medium shadow-lg">
    <span class="font-bold">âš ï¸ file:// ë¡œ ì—´ë©´ ì‡¼í•‘Â·ì˜ìƒ ë“±ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
    <span class="ml-2">â†’ í”„ë¡œì íŠ¸ í´ë”ì—ì„œ <strong>start.bat</strong> ë”ë¸”í´ë¦­ í›„ <a href="http://localhost:8000/" target="_blank" rel="noopener" class="underline font-bold ml-1">http://localhost:8000</a> ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”. (ë°°í¬ ë¶ˆí•„ìš”)</span>
  </div>
  <div class="flex flex-col h-full">
    <div class="flex flex-1 min-h-0">
      <!-- Global Nav (ìŠ¬ë¦¼ ì‚¬ì´ë“œë°”) -->
      <nav id="global-nav" class="w-14 shrink-0 flex flex-col items-center py-4 gap-2 bg-[#1e293b] border-r border-gray-700/50 relative">
        <a href="#" id="nav-logo" class="shrink-0 mb-2 block" title="ì›¨ì´ë¸ŒA">
          <img src="https://cdn.imweb.me/upload/S20251125de354b8205da7/aec9550d8ff37.png" alt="ì›¨ì´ë¸ŒA" class="h-5 w-auto">
        </a>
        <div class="flex flex-col items-center gap-2 flex-1">
          <button id="nav-sidebar-toggle" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì‘ì—… ëª©ë¡ ì ‘ê¸°/í¼ì¹˜ê¸°">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M4 12h16M4 6h16M4 18h16"/></svg>
          </button>
          <button id="nav-home" class="nav-item-active p-2.5 rounded-lg text-gray-300 hover:text-white hover:bg-white/10 transition-colors" title="í™ˆ" data-menu="home">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          </button>
          <button id="nav-chat" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="AI ì±„íŒ…" data-menu="chat">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
          </button>
          <div class="w-8 h-px bg-gray-600 my-1"></div>
          <button id="nav-image" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì´ë¯¸ì§€" data-mode="image">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          </button>
          <button id="nav-cardnews" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì¹´ë“œë‰´ìŠ¤" data-mode="html">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
          </button>
          <button id="nav-video" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì˜ìƒ" data-mode="video">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          </button>
          <div class="w-8 h-px bg-gray-600 my-1"></div>
          <button id="nav-shopping" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì‡¼í•‘" data-menu="shopping">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 2l1.5 4h9L18 2M6.5 6h11l-1 14H7.5l-1-14z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10v8M15 10v8"/>
            </svg>
          </button>
          <button id="nav-sns-flow" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="SNS ì›ìŠ¤í†±" data-menu="sns-flow">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          </button>
        </div>
        <!-- SNS ì—°ë™ Â· ì„¤ì • (ìµœí•˜ë‹¨) -->
        <div class="mt-auto pt-2 border-t border-gray-600/50 w-full flex flex-col items-center gap-1">
          <button id="nav-sns-settings" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="SNS ì—°ë™ Â· ë°œí–‰" data-menu="sns-settings">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          </button>
          <button id="api-settings-btn" class="p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="ì„¤ì • (API)" data-menu="settings">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </button>
        </div>
      </nav>

      <!-- Contextual Nav: ëŒ€í™”=ì‘ì—…ëª©ë¡ë§Œ, ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤=ë””ìì¸í”„ë¡¬í”„íŠ¸+ì‘ì—…ëª©ë¡ë²„íŠ¼(ì˜¤ë²„ë ˆì´) -->
      <aside id="contextual-sidebar" class="flex flex-col shrink-0 min-h-0 bg-white border-r border-gray-200 relative sidebar-collapsed" style="width: 300px; min-width: 240px; max-width: 500px;">
        <div id="sidebar-resize-handle" title="í¬ê¸° ì¡°ì ˆ"></div>
        <div class="sidebar-content flex flex-col flex-1 min-h-0 min-w-0">
        <!-- ì‘ì—… ëª©ë¡ (ëŒ€í™” ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
        <div id="sidebar-task-list" class="hidden flex flex-col flex-1 min-h-0">
          <div class="shrink-0 p-3 border-b border-gray-100">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-sm font-semibold text-gray-800">ì‘ì—… ëª©ë¡</h2>
              <div class="flex items-center gap-1">
                <button id="ai-chat-new-folder-btn" class="px-3 py-1.5 text-xs font-medium text-[#003366] hover:bg-[#003366]/10 rounded-lg transition-colors" title="ìƒˆ í´ë”">ğŸ“ ìƒˆ í´ë”</button>
                <button id="ai-chat-new-btn" class="px-3 py-1.5 text-xs font-medium text-[#003366] hover:bg-[#003366]/10 rounded-lg transition-colors" title="ìƒˆ ì±„íŒ…">ìƒˆ ì±„íŒ…</button>
              </div>
            </div>
            <div class="relative">
              <input type="text" id="history-search" placeholder="ì‘ì—… ê²€ìƒ‰..." class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-[#2C96FF] focus:ring-1 focus:ring-[#2C96FF] outline-none">
              <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
          </div>
          <div id="canvas-list-panel" class="flex-1 overflow-y-auto px-3 py-2 min-h-0">
            <div class="text-xs text-gray-500 px-3 py-4 text-center">ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
        <!-- ë””ìì¸ í”„ë¡¬í”„íŠ¸ (ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
        <div id="sidebar-design-prompt" class="flex flex-col flex-1 min-h-0">
          <div class="shrink-0 flex items-center gap-2 p-2 border-b border-gray-100">
            <button id="task-list-menu-btn" class="sidebar-toggle-btn p-1.5 rounded-md flex items-center gap-2 hover:bg-gray-100" title="ì‘ì—… ëª©ë¡">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 12h16M4 6h16M4 18h16"/></svg>
              <span class="text-sm font-semibold text-gray-800">ì‘ì—… ëª©ë¡</span>
            </button>
            <button id="final-prompt-preview-btn" class="ml-auto p-1.5 rounded-md text-gray-500 hover:text-gray-800 hover:bg-gray-100" title="ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
          <select id="model-select" class="hidden"><option value="gemini-2.5-pro">High Quality Mode</option></select>
          <div id="chat-container" class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-8 space-y-4 min-h-0 bg-white">
          </div>
          <div id="loading-status-bar" class="hidden shrink-0 px-4 py-2.5 bg-blue-50 text-blue-700 text-sm font-medium border-t border-blue-100">ì œì‘ ì¤‘ 0%</div>
          <div id="sidebar-design-input-area" class="p-4 border-t border-gray-200 bg-white shrink-0 sidebar-chat-area mx-2 mb-2">
            <div id="attachment-drop-zone" class="flex flex-col gap-2 rounded-lg transition-colors cursor-pointer">
              <div id="attachment-preview" class="hidden shrink-0 flex flex-wrap items-start gap-2 p-2 border border-gray-200 rounded-lg bg-gray-50">
              </div>
              <div class="flex-1 min-w-0" onclick="event.stopPropagation()">
                <textarea id="prompt-input" rows="3" class="w-full bg-white text-gray-900 border-0 rounded-lg px-4 py-3 resize-none focus:ring-0 outline-none text-sm"></textarea>
              </div>
              <input id="attachment-input" type="file" class="hidden" accept="image/*" multiple />
            </div>
          </div>
        </div>
        </div>
      </aside>

      <!-- ì‘ì—… ëª©ë¡ ì˜¤ë²„ë ˆì´ (ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤ ëª¨ë“œì—ì„œë§Œ, ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œ) - ëŒ€í™”ì°½ê³¼ ë™ì¼ ë†’ì´, ë°°ê²½ 20% ê²€ì • ì˜¤ë²„ë ˆì´ -->
      <div id="task-list-overlay" class="hidden fixed inset-0 z-40">
        <div class="absolute inset-0 bg-black/20" id="task-list-overlay-backdrop"></div>
        <div class="absolute left-14 top-0 bottom-0 w-[300px] bg-white shadow-xl flex flex-col min-h-0">
          <div class="shrink-0 p-4 border-b border-gray-100">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-sm font-semibold text-gray-800">ì‘ì—… ëª©ë¡</h2>
              <div class="flex items-center gap-1">
                <button id="task-list-new-folder-btn" class="px-3 py-1.5 text-xs font-medium text-[#003366] hover:bg-[#003366]/10 rounded-lg transition-colors" title="ìƒˆ í´ë”">ğŸ“ ìƒˆ í´ë”</button>
                <button id="task-list-close-btn" class="p-1.5 text-gray-500 hover:text-gray-700 rounded-md">âœ•</button>
              </div>
            </div>
            <div class="relative">
              <input type="text" id="history-search-overlay" placeholder="ì‘ì—… ê²€ìƒ‰..." class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-[#2C96FF] focus:ring-1 focus:ring-[#2C96FF] outline-none">
              <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
          </div>
          <div id="canvas-list-panel-overlay" class="flex-1 overflow-y-auto px-3 py-2 min-h-0">
            <div class="text-xs text-gray-500 px-3 py-4 text-center">ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      <!-- ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div id="final-prompt-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/30" id="final-prompt-modal-backdrop"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-2xl bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden">
          <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <div class="text-sm font-semibold text-gray-800">ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="flex items-center gap-2">
              <button id="final-prompt-copy-btn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ë³µì‚¬">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              </button>
              <button id="final-prompt-close-btn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ë‹«ê¸°">âœ•</button>
            </div>
          </div>
          <div class="p-4">
            <div id="final-prompt-meta" class="text-xs text-gray-500 mb-2"></div>
            <div class="mb-3">
              <div class="text-[11px] font-semibold text-gray-700 mb-1">ì €ì¥ëœ ê·œì¹™</div>
              <div id="final-prompt-rules" class="max-h-28 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-white text-[11px] text-gray-700"></div>
            </div>
            <textarea id="final-prompt-textarea" class="w-full h-[380px] p-3 text-xs border border-gray-200 rounded-lg bg-gray-50 font-mono leading-relaxed outline-none" readonly></textarea>
            <div class="mt-2 text-[11px] text-gray-500">í˜„ì¬ ì…ë ¥ê°’ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. (ê·œì¹™ í¬í•¨)</div>
          </div>
        </div>
      </div>

      <main class="flex-1 flex flex-col bg-gray-100 min-w-0">
        <!-- í™ˆ ë·° (ê¸°ë³¸ ë©”ì¸ í˜ì´ì§€) -->
        <div id="home-view" class="flex flex-col flex-1 min-h-0 overflow-y-auto">
          <div class="home-view flex-1">
            <h1 class="home-view-title">ì›¨ì´ë¸ŒA AI ìŠ¤í˜ì´ìŠ¤</h1>
            <div class="home-view-input-wrap">
              <textarea id="home-view-input" rows="1" class="home-view-input chat-input-auto-resize w-full py-3 px-4" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ê³  ë§Œë“¤ì–´ë³´ì„¸ìš”" autocomplete="off"></textarea>
            </div>
            <div class="home-view-cards">
              <div class="home-view-card" data-home-nav="chat" title="AI ëŒ€í™”">
                <span class="card-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg></span>
                <span class="card-title">AI ëŒ€í™”</span>
                <span class="card-desc">ì±„íŒ…ìœ¼ë¡œ ê¸°íšÂ·ë¬¸ì„œÂ·ì§ˆë¬¸ì„ í•œ ë²ˆì—</span>
              </div>
              <div class="home-view-card" data-home-nav="create" title="ì½˜í…ì¸  ì œì‘">
                <span class="card-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></span>
                <span class="card-title">ì½˜í…ì¸  ì œì‘</span>
                <span class="card-desc">ì´ë¯¸ì§€, ì¹´ë“œë‰´ìŠ¤, ìˆí¼ ì˜ìƒ ì œì‘</span>
                <div class="home-view-create-sub" onclick="event.stopPropagation()">
                  <button type="button" data-home-nav="image">ì´ë¯¸ì§€</button>
                  <button type="button" data-home-nav="cardnews">ì¹´ë“œë‰´ìŠ¤</button>
                  <button type="button" data-home-nav="video">ì˜ìƒ</button>
                </div>
              </div>
              <div class="home-view-card" data-home-nav="sns-flow" title="SNS ë°œí–‰">
                <span class="card-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></span>
                <span class="card-title">SNS ë°œí–‰</span>
                <span class="card-desc">ê¸°íš â†’ ìº¡ì…˜ â†’ ì˜ˆì•½Â·ì§€ê¸ˆ ë°œí–‰ê¹Œì§€ ì›ìŠ¤í†±</span>
              </div>
              <div class="home-view-card" data-home-nav="shopping" title="ì‡¼í•‘Â·ë„êµ¬">
                <span class="card-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4H6zM3 6h18M16 10a4 4 0 01-8 0"/></svg></span>
                <span class="card-title">ì‡¼í•‘Â·ë„êµ¬</span>
                <span class="card-desc">ë„¤ì´ë²„ ì‡¼í•‘ ì¸ë„¤ì¼ ìƒì„±</span>
              </div>
            </div>
          </div>
        </div>
        <!-- ì„¤ì • ë·° (ì „ì²´ í˜ì´ì§€) -->
        <div id="settings-view" class="hidden flex flex-col flex-1 min-h-0 bg-white overflow-y-auto">
          <div class="sticky top-0 z-10 shrink-0 flex items-center gap-4 px-6 py-4 border-b border-gray-200 bg-white">
            <button type="button" id="settings-back-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-gray-900" title="í™ˆìœ¼ë¡œ">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </button>
            <h1 class="text-lg font-semibold text-gray-900">ì„¤ì •</h1>
          </div>
          <div class="flex-1 p-6 max-w-2xl mx-auto w-full">
            <section class="mb-8">
              <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">API ì„¤ì •</h2>
              <div id="api-input-area" class="flex flex-col gap-3">
                <div>
                  <label class="text-xs text-gray-500 mb-1 block">Gemini API Key</label>
                  <input type="password" id="api-key-input" placeholder="Gemini API Key" class="px-4 py-2 border border-gray-300 rounded-lg w-full text-sm">
                </div>
                <div>
                  <label class="text-xs text-gray-500 mb-1 block">Replicate API Token (ì‡¼í•‘ ëˆ„ë¼)</label>
                  <input type="password" id="replicate-token-input" placeholder="r8_xxxx..." class="px-4 py-2 border border-gray-300 rounded-lg w-full text-sm">
                </div>
                <div class="flex items-center gap-2">
                  <button id="save-api-key" class="accent-blue text-white px-4 py-2 rounded-lg text-sm font-medium flex-1">ì €ì¥</button>
                  <button id="copy-api-key" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ë³µì‚¬">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                  </button>
                </div>
              </div>
            </section>
          </div>
        </div>
        <!-- SNS ì—°ë™Â·ëŒ“ê¸€Â·ì„±ê³¼ ë·° (ì„¤ì •ê³¼ ë¶„ë¦¬) -->
        <div id="sns-settings-view" class="hidden flex flex-col flex-1 min-h-0 bg-white overflow-y-auto">
          <div class="sticky top-0 z-10 shrink-0 flex items-center gap-4 px-6 py-4 border-b border-gray-200 bg-white">
            <button type="button" id="sns-settings-back-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-gray-900" title="í™ˆìœ¼ë¡œ">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </button>
            <h1 class="text-lg font-semibold text-gray-900">SNS ì—°ë™ Â· ë°œí–‰</h1>
          </div>
          <div class="flex-1 p-6 max-w-2xl mx-auto w-full">
            <section class="mb-8">
              <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">SNS ì—°ë™</h2>
              <p class="text-sm text-gray-600 mb-3">ì—°ë™í•œ ê³„ì •ìœ¼ë¡œ SNS ì›ìŠ¤í†±ì—ì„œ ë°”ë¡œ ë°œí–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. FacebookÂ·ì¸ìŠ¤íƒ€ê·¸ë¨, Threads, YouTubeë¥¼ ê°ê° ì—°ê²°í•  ìˆ˜ ìˆìœ¼ë©°, ì—¬ëŸ¬ í”Œë«í¼ì„ ë™ì‹œì— ì—°ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <div id="sns-connections-list" class="mb-3 space-y-2 text-sm"></div>
              <div class="flex flex-wrap gap-2">
                <a id="sns-connect-facebook-btn" href="#" class="px-4 py-2 rounded-lg text-sm font-medium bg-[#1877f2] text-white hover:bg-[#166fe5] transition-colors">Facebook Â· ì¸ìŠ¤íƒ€ê·¸ë¨ ì—°ê²°</a>
                <a id="sns-connect-threads-btn" href="#" class="px-4 py-2 rounded-lg text-sm font-medium bg-black text-white hover:bg-gray-800 transition-colors">Threads ì—°ê²°</a>
                <a id="sns-connect-youtube-btn" href="#" class="px-4 py-2 rounded-lg text-sm font-medium bg-[#ff0000] text-white hover:bg-[#cc0000] transition-colors">YouTube ì—°ê²°</a>
              </div>
              <p class="text-xs text-gray-500 mt-2">Facebook ì—°ê²° ì‹œ í•´ë‹¹ í˜ì´ì§€ì™€ ì—°ê²°ëœ ì¸ìŠ¤íƒ€ê·¸ë¨ ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì •ì´ í•¨ê»˜ ì¶”ê°€ë©ë‹ˆë‹¤. ThreadsÂ·YouTubeëŠ” ê°ê° Meta ì•±Â·Google Cloud ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
              <p id="sns-auth-hint" class="text-xs text-gray-500 mt-3 hidden">ì„œë²„ì— FACEBOOK_APP_ID/SECRET, THREADS_APP_ID/SECRET, GOOGLE_CLIENT_ID/SECRETë¥¼ ì„¤ì •í•˜ë©´ ì—°ê²°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </section>
            <section class="mb-8">
              <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">ëŒ“ê¸€ ê´€ë¦¬ (AI ë‹µê¸€)</h2>
              <p class="text-sm text-gray-600 mb-2">FacebookÂ·ThreadsÂ·ì¸ìŠ¤íƒ€ê·¸ë¨Â·YouTube ê²Œì‹œë¬¼ ëŒ“ê¸€ì— AIê°€ ë‹µê¸€ì„ ë‹¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ“ê¸€ë³„ë¡œ ê³µê°œ ë‹µê¸€ ë˜ëŠ” ë¹„ê³µê°œ ë‹µê¸€(DM)ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <p class="text-xs text-amber-700 mb-2">ìë™ DM(ìƒˆ ëŒ“ê¸€ ì‹œ ìë™ ë¹„ê³µê°œ ë‹µê¸€) ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ë©°, í˜„ì¬ëŠ” ëŒ“ê¸€ë³„ ìˆ˜ë™ DMë§Œ ì§€ì›í•©ë‹ˆë‹¤.</p>
              <div class="mb-2">
                <label class="text-xs text-gray-500 block mb-1">ê³„ì • ì„ íƒ</label>
                <select id="sns-comments-connection-id" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"></select>
              </div>
              <button type="button" id="sns-comments-load-posts-btn" class="mb-2 px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800">ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <div id="sns-comments-posts-list" class="mb-2 max-h-32 overflow-y-auto space-y-1 text-sm"></div>
              <div id="sns-comments-comments-list" class="space-y-2 text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
            </section>
            <section class="mb-8">
              <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">ì„±ê³¼ ë¶„ì„</h2>
              <p class="text-sm text-gray-600 mb-2">FacebookÂ·ThreadsÂ·ì¸ìŠ¤íƒ€ê·¸ë¨Â·YouTube ì—°ë™ ê³„ì •ë³„ ì¡°íšŒìˆ˜Â·ë„ë‹¬Â·ì°¸ì—¬ ë“± ì§€í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <div class="flex flex-wrap gap-2 mb-3">
                <button type="button" id="sns-insights-refresh-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800">ì„±ê³¼ ìƒˆë¡œê³ ì¹¨</button>
                <button type="button" id="sns-insights-ai-report-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-[#2C96FF] text-white hover:bg-[#2380e0]">AI ë¦¬í¬íŠ¸ ìƒì„±</button>
              </div>
              <div id="sns-insights-list" class="space-y-2 text-sm text-gray-600"></div>
              <div id="sns-insights-ai-report-result" class="mt-3 hidden space-y-2 text-sm border-t border-gray-200 pt-3"></div>
            </section>
          </div>
        </div>
        <!-- ì‡¼í•‘ ë·° (/shopping) -->
        <div id="shopping-view" class="hidden flex flex-col flex-1 min-h-0 bg-white">
          <div class="flex-1 overflow-y-auto flex flex-col items-center justify-center py-12 px-6">
            <div class="w-full max-w-2xl">
              <div class="text-center mb-8">
                <div class="text-2xl font-bold text-gray-900">ë„¤ì´ë²„ ì‡¼í•‘ ì¸ë„¤ì¼ ìƒì„± ì—”ì§„</div>
                <div class="text-sm text-gray-500 mt-2">ì´ë¯¸ì§€ URLì„ ë¶™ì—¬ë„£ê³  â€œìƒì„±â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
              </div>
              <div id="shopping-api-banner" class="hidden mb-4 p-4 rounded-xl bg-amber-50 border border-amber-200 flex items-center justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-semibold text-amber-800">âš ï¸ ì‹¤ì œ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
                  <div class="text-xs text-amber-700 mt-1">Gemini API Keyì™€ Replicate í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”. ì™¼ìª½ í•˜ë‹¨ ì„¤ì •(âš™ï¸) â†’ API ì„¤ì •ì—ì„œ ì…ë ¥ í›„ ì €ì¥í•˜ì„¸ìš”.</div>
                </div>
                <button type="button" id="shopping-open-api-btn" class="shrink-0 px-4 py-2 text-sm font-medium text-amber-800 bg-amber-200 hover:bg-amber-300 rounded-lg transition-colors">API ì„¤ì • ì—´ê¸°</button>
              </div>
              <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
                <div class="flex gap-2">
                  <input id="shopping-image-url-input" type="text" class="flex-1 px-4 py-3 text-sm border border-gray-200 rounded-xl focus:border-[#2C96FF] focus:ring-1 focus:ring-[#2C96FF] outline-none" placeholder="https://shop-phinf.pstatic.net/... ë˜ëŠ” ì´ë¯¸ì§€ ë§í¬" />
                  <button id="shopping-generate-btn" class="px-5 py-3 rounded-xl bg-[#2C96FF] text-white text-sm font-semibold hover:bg-[#2380e0] transition-colors">ìƒì„±</button>
                </div>
                <div id="shopping-loading" class="hidden mt-4 p-5 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100">
                  <div class="flex items-center gap-4">
                    <div class="spinner shrink-0" style="width:28px;height:28px;border-width:3px;border-color:#2C96FF;border-top-color:transparent;"></div>
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-semibold text-gray-800">ì›¨ì´ë¸ŒA AIê°€ ìƒí’ˆì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
                      <div id="shopping-loading-step" class="text-sm font-medium text-[#2C96FF] mt-1">ì´ë¯¸ì§€ ìˆ˜ì§‘ ì¤‘ 0%</div>
                      <div class="mt-2 h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div id="shopping-loading-bar" class="h-full bg-[#2C96FF] rounded-full transition-all duration-300" style="width:0%"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="shopping-result" class="hidden mt-4">
                  <div class="text-sm font-semibold text-gray-800 mb-2">ì™„ì„±ëœ ì¸ë„¤ì¼</div>
                  <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <div class="aspect-square w-full max-w-md mx-auto rounded-t-xl overflow-hidden bg-gray-100 flex items-center justify-center">
                      <img id="shopping-thumb-img" alt="ìƒì„±ëœ ì¸ë„¤ì¼" class="w-full h-full object-contain hidden" />
                      <div id="shopping-thumb-placeholder" class="text-sm text-gray-500">ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°</div>
                    </div>
                    <div class="p-4 flex justify-end">
                      <button id="shopping-download-btn" class="px-5 py-2.5 text-sm font-semibold text-white bg-[#2C96FF] hover:bg-[#2380e0] rounded-lg transition-colors">ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- SNS ì›ìŠ¤í†± ë·° (ê¸°íš â†’ ì¹´ë“œë‰´ìŠ¤ â†’ ìº¡ì…˜ â†’ ì˜ˆì•½) -->
        <div id="sns-flow-view" class="hidden flex flex-col flex-1 min-h-0 bg-white">
          <div class="flex-1 overflow-y-auto p-6">
            <div class="w-full max-w-3xl mx-auto">
              <h1 class="text-xl font-bold text-gray-900 mb-2">SNS ì½˜í…ì¸  ì›ìŠ¤í†±</h1>
              <p class="text-sm text-gray-500 mb-6">ê¸°íš â†’ ì¹´ë“œë‰´ìŠ¤ â†’ ìº¡ì…˜ â†’ ì˜ˆì•½ê¹Œì§€ í•œ íë¦„ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p>
              <!-- ì§„í–‰ ë‹¨ê³„ -->
              <div id="sns-flow-steps" class="flex items-center gap-2 mb-8">
                <button type="button" data-sns-step="1" class="sns-step-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors">1. ê¸°íš</button>
                <span class="text-gray-300">â†’</span>
                <button type="button" data-sns-step="2" class="sns-step-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors">2. ì¹´ë“œë‰´ìŠ¤</button>
                <span class="text-gray-300">â†’</span>
                <button type="button" data-sns-step="3" class="sns-step-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors">3. ìº¡ì…˜</button>
                <span class="text-gray-300">â†’</span>
                <button type="button" data-sns-step="4" class="sns-step-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors">4. ì˜ˆì•½</button>
              </div>
              <!-- Step 1: ê¸°íš -->
              <div id="sns-step-1" class="sns-step-panel border border-gray-200 rounded-xl p-6 bg-gray-50/50">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">ì»¨í…ì¸  ê¸°íš</h2>
                <p class="text-sm text-gray-600 mb-4">ì£¼ì œë‚˜ ë°©í–¥ì„ ì…ë ¥í•˜ë©´ AIê°€ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                <div class="flex gap-2 mb-4">
                  <input type="text" id="sns-plan-input" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-sm focus:border-[#2C96FF] focus:ring-1 focus:ring-[#2C96FF] outline-none" placeholder="ì˜ˆ: 2ì›” ê±´ê°•í•œ ì•„ì¹¨ ë£¨í‹´, ê³ ê° ê°ë™ ì‚¬ë¡€" />
                  <button type="button" id="sns-plan-generate-btn" class="px-5 py-3 rounded-xl bg-[#2C96FF] text-white text-sm font-semibold hover:bg-[#2380e0] transition-colors">ì•„ì´ë””ì–´ ìƒì„±</button>
                </div>
                <div id="sns-plan-loading" class="hidden py-4 text-sm text-[#2C96FF]">ìƒì„± ì¤‘...</div>
                <div id="sns-plan-list" class="space-y-2"></div>
              </div>
              <!-- Step 2: ì¹´ë“œë‰´ìŠ¤ -->
              <div id="sns-step-2" class="sns-step-panel hidden border border-gray-200 rounded-xl p-6 bg-gray-50/50">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">ì¹´ë“œë‰´ìŠ¤ ì œì‘</h2>
                <p class="text-sm text-gray-600 mb-4">ì„ íƒí•œ ê¸°íšìœ¼ë¡œ ì¹´ë“œë‰´ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì¹´ë“œë‰´ìŠ¤ ë©”ë‰´ì—ì„œ ì´ì–´ì„œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div id="sns-step2-selected" class="mb-4 p-3 rounded-lg bg-white border border-gray-200 text-sm text-gray-700"></div>
                <div class="flex flex-wrap gap-2">
                  <button type="button" id="sns-goto-cardnews-btn" class="px-5 py-3 rounded-xl bg-[#2C96FF] text-white text-sm font-semibold hover:bg-[#2380e0] transition-colors">ì¹´ë“œë‰´ìŠ¤ë¡œ ì´ë™í•˜ì—¬ ì œì‘</button>
                  <button type="button" id="sns-goto-video-btn" class="px-5 py-3 rounded-xl bg-[#7c3aed] text-white text-sm font-semibold hover:bg-[#6d28d9] transition-colors">ìˆí¼(ì˜ìƒ)ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì œì‘</button>
                </div>
              </div>
              <!-- Step 3: ìº¡ì…˜ -->
              <div id="sns-step-3" class="sns-step-panel hidden border border-gray-200 rounded-xl p-6 bg-gray-50/50">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">ìº¡ì…˜ Â· í•´ì‹œíƒœê·¸</h2>
                <p class="text-sm text-gray-600 mb-4">ê²Œì‹œë¬¼ ìº¡ì…˜ê³¼ í•´ì‹œíƒœê·¸ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.</p>
                <button type="button" id="sns-caption-generate-btn" class="mb-4 px-5 py-3 rounded-xl bg-[#2C96FF] text-white text-sm font-semibold hover:bg-[#2380e0] transition-colors">ìº¡ì…˜ ìƒì„±</button>
                <div id="sns-caption-loading" class="hidden py-2 text-sm text-[#2C96FF]">ìƒì„± ì¤‘...</div>
                <div id="sns-caption-result" class="hidden space-y-3">
                  <div><label class="text-xs text-gray-500 block mb-1">ìº¡ì…˜</label><textarea id="sns-caption-text" rows="4" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea></div>
                  <div><label class="text-xs text-gray-500 block mb-1">í•´ì‹œíƒœê·¸</label><input type="text" id="sns-hashtags" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="#íƒœê·¸1 #íƒœê·¸2" /></div>
                  <button type="button" id="sns-caption-copy-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">ë³µì‚¬</button>
                </div>
              </div>
              <!-- Step 4: ì˜ˆì•½ -->
              <div id="sns-step-4" class="sns-step-panel hidden border border-gray-200 rounded-xl p-6 bg-gray-50/50">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">ë°œí–‰ ì˜ˆì•½</h2>
                <p class="text-sm text-gray-600 mb-4">ì—°ë™ëœ SNSë¡œ ì§€ê¸ˆ ë°œí–‰í•˜ê±°ë‚˜, ì˜ˆì•½ ì¼ì‹œë¥¼ ë„£ì–´ ëª©ë¡ì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸(ê³„ì •)ë¥¼ ì„ íƒí•´ ë°œí–‰í•˜ì„¸ìš”.</p>
                <div class="mb-4 space-y-2">
                  <label class="text-xs text-gray-500 block">ë°œí–‰í•  ê³„ì •</label>
                  <select id="sns-publish-connection-id" class="w-full max-w-md px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
                    <option value="">ì—°ë™ëœ ê³„ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                  </select>
                  <div id="sns-youtube-video-url-wrap" class="hidden mt-2 max-w-md">
                    <label class="text-xs text-gray-500 block mb-1">YouTube ì—…ë¡œë“œí•  ì˜ìƒ URL</label>
                    <input type="url" id="sns-youtube-video-url" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white" placeholder="https://.../video.mp4" />
                    <p class="text-xs text-gray-500 mt-1">YouTubeëŠ” í˜„ì¬ <span class="font-medium">ê³µê°œ ì ‘ê·¼ ê°€ëŠ¥í•œ MP4 URL</span>ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤. (ë¡œì»¬ íŒŒì¼/ë¹„ê³µê°œ URLì€ ë¶ˆê°€)</p>
                  </div>
                  <button type="button" id="sns-publish-now-btn" class="mt-2 px-5 py-3 rounded-xl bg-[#0d9488] text-white text-sm font-semibold hover:bg-[#0f766e] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">ì§€ê¸ˆ ë°œí–‰</button>
                </div>
                <div class="mb-2">
                  <label class="text-xs text-gray-500 block mb-1">ì¶”ì²œ ì‹œê°„ (í´ë¦­ ì‹œ ì¼ì‹œ ì ìš©)</label>
                  <div id="sns-suggested-times" class="flex flex-wrap gap-2 text-sm"></div>
                  <p id="sns-suggested-reason" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div class="flex flex-wrap gap-4 mb-4">
                  <div><label class="text-xs text-gray-500 block mb-1">ì˜ˆì•½ ì¼ì‹œ</label><input type="datetime-local" id="sns-schedule-datetime" class="px-3 py-2 border border-gray-200 rounded-lg text-sm" /></div>
                  <div class="flex items-end"><button type="button" id="sns-schedule-save-btn" class="px-5 py-3 rounded-xl bg-[#2C96FF] text-white text-sm font-semibold hover:bg-[#2380e0] transition-colors">ì˜ˆì•½ ëª©ë¡ì— ì €ì¥</button></div>
                </div>
                <div id="sns-schedule-list" class="mt-4 space-y-2 text-sm text-gray-600"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- ìº”ë²„ìŠ¤ ë·° (ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤) -->
        <div id="canvas-view" class="hidden flex flex-col flex-1 min-h-0">
        <!-- ì  ìŠ¤íŒŒí¬ ìŠ¤íƒ€ì¼ ìº”ë²„ìŠ¤ í—¤ë” -->
        <div class="bg-white border-b border-gray-200 shrink-0">
          <!-- ìƒë‹¨: ì œëª© + ê¸€ë¡œë²Œ ì•¡ì…˜ -->
          <div class="h-12 flex items-center justify-between px-6">
            <div class="flex-1 flex items-center gap-1 min-w-0">
              <div class="relative">
                <button id="header-rules-btn" class="p-2 text-amber-600 hover:text-amber-700 hover:bg-amber-50 rounded-lg transition-colors" title="ì €ì¥ëœ ê·œì¹™">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span id="header-rules-count" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 text-[10px] font-bold text-white bg-amber-500 rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <div id="header-rules-popover" class="hidden absolute left-0 top-full mt-1 w-[420px] max-h-[480px] bg-white rounded-xl shadow-lg border border-gray-200 z-50 overflow-hidden flex flex-col">
                  <div class="px-3 py-2 border-b border-gray-100 font-semibold text-gray-800 text-sm">ì €ì¥ëœ ê·œì¹™</div>
                  <div id="header-rules-list" class="flex-1 overflow-y-auto p-3 space-y-1.5 min-h-0"></div>
                  <div class="p-3 border-t border-gray-100 flex gap-2 items-end">
                    <textarea id="header-rules-input" rows="1" placeholder="ê·œì¹™ ì…ë ¥ (ì˜ˆ: ë¡œê³ ëŠ” ì´ URLë¡œ)" class="rules-input-auto-resize flex-1 min-w-0 px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-amber-400 focus:ring-1 focus:ring-amber-400 outline-none" maxlength="200"></textarea>
                    <button id="header-rules-add-btn" class="shrink-0 px-3 py-2 text-sm font-medium text-amber-800 bg-amber-100 hover:bg-amber-200 rounded-lg">ì¶”ê°€</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex-1 flex items-center justify-center gap-2 min-w-0 px-4">
              <h1 id="canvas-title" class="text-center text-base font-medium text-gray-800 truncate">ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°</h1>
              <button id="canvas-title-edit-btn" class="p-1 text-gray-400 hover:text-gray-600" title="ì œëª© ìˆ˜ì •">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              </button>
              <input id="canvas-title-input" class="hidden text-base font-medium text-gray-800 border-b border-gray-300 focus:border-blue-400 outline-none bg-transparent w-[260px]" />
            </div>
            <div class="flex-1 min-w-0"></div>
          </div>
          <!-- ì´ë¯¸ì§€ ì¡°ì‘ íˆ´ë°” -->
          <div class="flex items-center justify-between px-6 py-2 border-t border-gray-100">
            <div class="flex items-center gap-1">
              <button id="tool-undo" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ë’¤ë¡œ ê°€ê¸°">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
              </button>
              <button id="tool-redo" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ì•ìœ¼ë¡œ ê°€ê¸°">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-5 5m5-5l-5-5"/></svg>
              </button>
              <div class="w-px h-5 bg-gray-200 mx-1"></div>
              <button id="tool-zoom-in" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="í™•ëŒ€">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/></svg>
              </button>
              <button id="tool-zoom-out" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="ì¶•ì†Œ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/></svg>
              </button>
            </div>
            <div class="flex items-center gap-2">
              <button id="reset-btn" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg border border-gray-200" title="ì±„íŒ…Â·ë””ìì¸ ì´ˆê¸°í™”">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
            </div>
          </div>
          <!-- ì¹´ë“œë‰´ìŠ¤ í†¤ì•¤ë§¤ë„ˆ/í•µì‹¬ìš”ì•½ ë°” ì‚­ì œë¨ -->
          <!-- ì˜ìƒ ì „ìš© íˆ´ë°”ëŠ” ì±„íŒ…ìœ¼ë¡œ ìš”ì²­ (ì‚­ì œë¨) -->
        </div>

        <!-- ìº”ë²„ìŠ¤ í´ë” ë·° (ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤ ëª¨ë“œì—ì„œ í´ë” í´ë¦­ ì‹œ) -->
        <div id="ai-canvas-folder-view" class="hidden flex-1 overflow-y-auto flex flex-col items-center py-8 px-4 bg-white">
          <div class="folder-view-container w-full">
            <div class="folder-view-header">
              <div class="folder-view-header-left">
                <button id="canvas-folder-view-back-btn" class="p-1.5 -ml-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg mr-1" title="ë’¤ë¡œ">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <span class="folder-icon">ğŸ“</span>
                <h1 id="canvas-folder-view-title">í´ë”</h1>
              </div>
              <button id="canvas-folder-view-new-btn" class="folder-view-new-chat-btn">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
            </div>
            <div id="canvas-folder-view-list" class="folder-view-list">
              <!-- í´ë” í•­ëª© ëª©ë¡ -->
            </div>
          </div>
        </div>

        <div id="canvas-scroll-area" class="flex-1 overflow-auto p-6 flex flex-col items-center justify-center canvas-dot-grid min-h-0 relative">
          <div id="canvas-pan-overlay" class="absolute inset-0 z-20 cursor-grab pointer-events-none transition-opacity" style="background:transparent;" title="ìŠ¤í˜ì´ìŠ¤ + ë“œë˜ê·¸ë¡œ ìº”ë²„ìŠ¤ ì´ë™"></div>
          <div id="canvas-zoom-outer" class="flex items-center justify-center" style="max-width:100%;max-height:100%;">
            <div id="canvas-zoom-wrapper" style="transform-origin: center center;">
              <div id="preview-wrapper" class="relative" data-ratio="1:1">
              <div id="preview-container" class="overflow-hidden">
                <iframe id="preview-iframe" class="border-0 block bg-transparent" sandbox="allow-scripts allow-same-origin" title="Generated Preview" srcdoc="" style="min-height:300px;display:block;"></iframe>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- ì  ìŠ¤íŒŒí¬ ìŠ¤íƒ€ì¼ ë””ìì¸ í¸ì§‘ íŒ¨ë„ (ì´ë¯¸ì§€ í´ë¦­ ì‹œ í‘œì‹œ) -->
        <div id="design-edit-panel" class="hidden shrink-0 bg-white border-t border-gray-200 shadow-[0_-4px 12px rgba(0,0,0,0.08)]">
          <div class="px-6 py-4">
            <div class="flex items-center gap-2 mb-4">
              <button id="edit-text-btn" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg border border-gray-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                í…ìŠ¤íŠ¸ í¸ì§‘
              </button>
              <div class="relative">
                <button id="edit-toolbox-btn" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg border border-gray-200">ë„êµ¬ ìƒì</button>
                <div id="toolbox-dropdown" class="hidden absolute bottom-full left-0 mb-1 py-2 bg-white rounded-lg shadow-lg border border-gray-200 min-w-[180px] z-20">
                  <button data-tool="bg-remove" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ë°°ê²½ ì œê±°</button>
                  <button data-tool="magic-erase" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ë§¤ì§ ì§€ìš°ê°œ</button>
                  <button data-tool="magic-draw" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ë§¤ì§ ë‹¤ì‹œ ê·¸ë¦¬ê¸°</button>
                  <button data-tool="style-lock" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">íë¦„ ë³´ì •</button>
                  <button data-tool="img-extend" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ì´ë¯¸ì§€ í™•ì¥</button>
                  <button data-tool="color-variant" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ì–¼êµ´ ë°”ê¾¸ê¸°</button>
                </div>
              </div>
              <div class="relative">
                <button id="edit-add-element-btn" class="flex items-center gap-1 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg border border-gray-200">
                  ìš”ì†Œ ì¶”ê°€
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="element-dropdown" class="hidden absolute bottom-full left-0 mb-1 py-2 bg-white rounded-lg shadow-lg border border-gray-200 min-w-[160px] z-20">
                  <button data-element="text" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">í…ìŠ¤íŠ¸ ì¶”ê°€</button>
                  <button data-element="image" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ì´ë¯¸ì§€ ì¶”ê°€</button>
                  <button data-element="draw" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">ê·¸ë¦¬ê¸°</button>
                </div>
              </div>
              <div class="relative">
                <button id="edit-export-btn" class="flex items-center gap-1 px-3 py-2 text-sm text-white bg-[#2C96FF] hover:bg-[#2380e0] rounded-lg">
                  ë‚´ë³´ë‚´ê¸°
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="export-dropdown" class="hidden absolute bottom-full left-0 mb-1 py-1 bg-white rounded-lg shadow-lg border border-gray-200 min-w-[120px] z-20">
                  <button data-export="png" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">PNG</button>
                  <button data-export="html" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">HTML</button>
                  <button data-export="pdf" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50">PDF</button>
                </div>
              </div>
              <button id="edit-delete-btn" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg" title="ì‚­ì œ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
            <div class="flex gap-2">
              <textarea id="redesign-input" rows="2" placeholder="ë¬´ì—‡ì„ í¸ì§‘í•˜ê³  ì‹¶ì€ì§€ ì„¤ëª…í•˜ì„¸ìš”" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg resize-none text-sm placeholder-gray-400"></textarea>
              <button id="redesign-send-btn" class="shrink-0 p-3 accent-blue text-white rounded-lg" title="ë¦¬ë””ìì¸ ì „ì†¡">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
              </button>
            </div>
          </div>
        </div>
        </div>

        <!-- AI ì±„íŒ… ë·° (ì œë¯¸ë‚˜ì´ ìŠ¤íƒ€ì¼) -->
        <div id="ai-chat-view" class="hidden flex flex-col flex-1 min-h-0 bg-white">
          <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ (í´ë” ë¯¸ì„ íƒ ì‹œ) -->
          <div id="ai-chat-messages-wrap" class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col items-center justify-start py-8 px-4 min-h-0">
            <div id="ai-chat-messages" class="w-full max-w-2xl space-y-6 pb-8">
              <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
            </div>
          </div>
          <!-- í´ë” ë·° (í´ë” ì„ íƒ ì‹œ, ChatGPT ìŠ¤íƒ€ì¼) -->
          <div id="ai-chat-folder-view" class="hidden flex-1 overflow-y-auto flex flex-col items-center py-8 px-4">
            <div class="folder-view-container w-full">
              <div class="folder-view-header">
                <div class="folder-view-header-left">
                  <button id="folder-view-back-btn" class="p-1.5 -ml-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg mr-1" title="ë’¤ë¡œ">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                  </button>
                  <span class="folder-icon">ğŸ“</span>
                  <h1 id="folder-view-title">í´ë”</h1>
                </div>
                <button id="folder-view-new-chat-btn" class="folder-view-new-chat-btn">ìƒˆ ì±„íŒ…</button>
              </div>
              <div id="folder-view-drop-zone" class="folder-view-input-wrap flex flex-col gap-2 p-3 bg-white rounded-2xl border border-gray-200 shadow-sm cursor-pointer">
                <div id="folder-view-attachment-preview" class="hidden flex flex-wrap gap-2 p-2 min-h-0">
                </div>
                <div class="flex items-end gap-2">
                  <div class="flex-1 min-w-0">
                    <textarea id="folder-view-input" rows="1" class="folder-view-input chat-input-auto-resize w-full py-3 px-4 bg-transparent text-gray-900 outline-none text-sm" placeholder="í´ë”ì—ì„œ ìƒˆ ì±„íŒ…" autocomplete="off"></textarea>
                  </div>
                  <button type="button" id="folder-view-send-btn" class="p-2.5 rounded-full bg-[#2C96FF] text-white hover:bg-[#2380e0] transition-colors shrink-0" title="ì „ì†¡">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  </button>
                </div>
                <input id="folder-view-file-input" type="file" class="hidden" accept="image/*,.txt" multiple>
              </div>
              <div id="folder-view-list" class="folder-view-list">
                <!-- í´ë” í•­ëª© ëª©ë¡ -->
              </div>
            </div>
          </div>
          <div id="ai-chat-input-area" class="shrink-0 pb-6 pt-4 px-4 flex justify-center">
            <div class="w-full max-w-2xl space-y-3">
              <!-- ëª¨ë¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
              <div class="relative flex justify-center">
                <div class="relative">
                  <button id="ai-chat-mode-trigger" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-[#003366] hover:bg-white/80 rounded-full border border-gray-200 bg-white shadow-sm transition-colors" type="button">
                    <span id="ai-chat-mode-label">ì‚¬ê³  ëª¨ë“œ</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                  </button>
                  <div id="ai-chat-mode-dropdown" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-72 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                    <div class="px-4 py-2 border-b border-gray-100">
                      <span class="text-sm font-semibold text-gray-800">Gemini</span>
                    </div>
                    <button class="ai-chat-mode-select-option" data-mode="fast">
                      <div>
                        <div class="font-semibold text-gray-800">ë¹ ë¥¸ ëª¨ë“œ</div>
                        <div class="text-xs text-gray-500 mt-0.5">ë¹ ë¥´ê²Œ ë‹µë³€</div>
                      </div>
                      <span class="option-check hidden" data-check="fast"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg></span>
                    </button>
                    <button class="ai-chat-mode-select-option" data-mode="thought">
                      <div>
                        <div class="font-semibold text-gray-800">ì‚¬ê³  ëª¨ë“œ</div>
                        <div class="text-xs text-gray-500 mt-0.5">ë³µì¡í•œ ë¬¸ì œ í•´ê²°</div>
                      </div>
                      <span class="option-check" data-check="thought"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg></span>
                    </button>
                    <button class="ai-chat-mode-select-option" data-mode="pro">
                      <div>
                        <div class="font-semibold text-gray-800">Pro</div>
                        <div class="text-xs text-gray-500 mt-0.5">ê³ ê¸‰ ìˆ˜í•™ ë° ì½”ë“œë¥¼ ìœ„í•´ ë” ì˜¤ë˜ ìƒê°í•©ë‹ˆë‹¤.</div>
                      </div>
                      <span class="option-check hidden" data-check="pro"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg></span>
                    </button>
                  </div>
                </div>
              </div>
              <!-- ì…ë ¥ì°½ -->
              <div id="ai-chat-drop-zone" class="flex flex-col gap-2 p-3 bg-white rounded-2xl border border-gray-200 shadow-sm">
                <div id="ai-chat-attachment-preview" class="hidden flex flex-wrap gap-2 p-2 min-h-0">
                </div>
                <div class="flex items-end gap-2">
                <div class="flex-1 min-w-0">
                  <textarea id="ai-chat-input" rows="1" class="chat-input-auto-resize w-full py-3 px-4 bg-transparent text-gray-900 outline-none text-sm"></textarea>
                </div>
                <div class="flex items-center gap-1 shrink-0">
                  <div class="relative">
                    <button id="ai-chat-rules-btn" class="p-2.5 text-amber-600 hover:text-amber-700 hover:bg-amber-50 rounded-full transition-colors" title="ì €ì¥ëœ ê·œì¹™">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                      <span id="ai-chat-rules-count" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 text-[10px] font-bold text-white bg-amber-500 rounded-full flex items-center justify-center hidden">0</span>
                    </button>
                    <div id="ai-chat-rules-popover" class="hidden absolute right-0 bottom-full mb-1 w-[420px] max-h-[480px] bg-white rounded-xl shadow-lg border border-gray-200 z-50 overflow-hidden flex flex-col">
                      <div class="px-3 py-2 border-b border-gray-100 font-semibold text-gray-800 text-sm">ì €ì¥ëœ ê·œì¹™</div>
                      <div id="ai-chat-rules-list" class="flex-1 overflow-y-auto p-3 space-y-1.5 min-h-0"></div>
                      <div class="p-3 border-t border-gray-100 flex gap-2 items-end">
                        <textarea id="ai-chat-rules-input" rows="1" placeholder="ê·œì¹™ ì…ë ¥ (ì˜ˆ: í•­ìƒ í•œêµ­ì–´ë¡œ ë‹µë³€)" class="rules-input-auto-resize flex-1 min-w-0 px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-amber-400 focus:ring-1 focus:ring-amber-400 outline-none" maxlength="200"></textarea>
                        <button id="ai-chat-rules-add-btn" class="shrink-0 px-3 py-2 text-sm font-medium text-amber-800 bg-amber-100 hover:bg-amber-200 rounded-lg">ì¶”ê°€</button>
                      </div>
                    </div>
                  </div>
                  <button id="ai-chat-send-btn" class="p-2.5 rounded-full bg-[#2C96FF] text-white hover:bg-[#2380e0] transition-colors" title="ì „ì†¡">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  </button>
                </div>
                </div>
              </div>
              <!-- ì„ íƒëœ í´ë”ì˜ í•­ëª©ë“¤ (ì±„íŒ…ì°½ ì•„ë˜) -->
              <div id="ai-chat-folder-items" class="hidden mt-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 id="ai-chat-folder-title" class="text-sm font-semibold text-gray-800"></h3>
                  <button id="ai-chat-folder-close" class="text-xs text-gray-500 hover:text-gray-700">ë‹«ê¸°</button>
                </div>
                <div id="ai-chat-folder-items-list" class="folder-items-panel bg-gray-50 rounded-lg p-2">
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- í´ë” ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ (ìƒˆ í´ë”/ì´ë¦„ ìˆ˜ì • ê³µí†µ, API ì„¤ì • UI í˜•íƒœ) -->
  <div id="folder-name-modal-backdrop" class="folder-name-modal-backdrop hidden">
    <div class="folder-name-modal" onclick="event.stopPropagation()">
      <h3 id="folder-name-modal-title">ìƒˆ í´ë” ë§Œë“¤ê¸°</h3>
      <input type="text" id="folder-name-modal-input" placeholder="í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30" autocomplete="off" class="w-full">
      <div class="folder-name-modal-actions">
        <button type="button" id="folder-name-modal-save" class="folder-name-modal-save">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‡¼í•‘ ì˜¤ë¥˜ ëª¨ë‹¬ (API ì„¤ì • UI ìŠ¤íƒ€ì¼) -->
  <div id="shopping-error-modal-backdrop" class="shopping-error-modal-backdrop hidden">
    <div class="shopping-error-modal" onclick="event.stopPropagation()">
      <h3><span style="color:#dc2626;">âš </span> ì˜¤ë¥˜</h3>
      <div id="shopping-error-body" class="shopping-error-body"></div>
      <div class="shopping-error-actions">
        <button type="button" id="shopping-error-ok" class="shopping-error-ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    (function init() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
        return;
      }

    let activeMenu = 'home';
    let sidebarCollapsed = true;
    const STORAGE_KEY = 'wava_gemini_api_key';
    const REPLICATE_STORAGE_KEY = 'wava_replicate_token';
    const LAST_VIEW_KEY = 'wava_last_view';

    const apiKeyInput = document.getElementById('api-key-input');
    const modelSelect = document.getElementById('model-select');
    const promptInput = document.getElementById('prompt-input');
    const attachmentInput = document.getElementById('attachment-input');
    const chatContainer = document.getElementById('chat-container');
    const previewIframe = document.getElementById('preview-iframe');
    const previewWrapper = document.getElementById('preview-wrapper');
    const refreshBtn = document.getElementById('refresh-btn');
    const canvasTitleInput = document.getElementById('canvas-title-input');
    const canvasTitleEditBtn = document.getElementById('canvas-title-edit-btn');
    const canvasListToggle = document.getElementById('canvas-list-toggle');
    const canvasListPanel = document.getElementById('canvas-list-panel');

    if (!chatContainer) {
      const msg = 'í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (chat-container:' + !!chatContainer + ')';
      try { document.body.insertAdjacentHTML('afterbegin', '<div style="position:fixed;top:0;left:0;right:0;z-index:99999;background:#fef3c7;color:#92400e;padding:12px;text-align:center;font-size:14px;">' + msg + '</div>'); } catch(_) { alert(msg); }
    }

    // file:// ë¡œ ì—´ì—ˆì„ ë•Œ ì•ˆë‚´ ë°°ë„ˆ í‘œì‹œ
    (function checkFileProtocol() {
      if (location.protocol === 'file:') {
        const el = document.getElementById('file-protocol-banner');
        if (el) el.classList.remove('hidden');
      }
    })();

    // ëŸ°íƒ€ì„ ì˜¤ë¥˜ê°€ ë‚˜ë©´ í™”ë©´ì— ë°”ë¡œ í‘œì‹œ(ë²„íŠ¼/ì´ë²¤íŠ¸ê°€ ì „ë¶€ ì•ˆ ë¨¹ëŠ” ì¦ìƒ ë””ë²„ê¹…ìš©)
    (function attachRuntimeErrorBanner() {
      const banner = document.createElement('div');
      banner.id = 'runtime-error-banner';
      banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#fee2e2;color:#991b1b;padding:10px 14px;font-size:12px;line-height:1.4;border-bottom:1px solid #fecaca;display:none;white-space:pre-wrap;';
      document.body.appendChild(banner);
      const show = (msg) => {
        try {
          banner.textContent = String(msg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          banner.style.display = 'block';
        } catch (_) {}
      };
      window.addEventListener('error', (e) => {
        show('[JS ì˜¤ë¥˜] ' + (e?.message || e?.error?.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
      });
      window.addEventListener('unhandledrejection', (e) => {
        const reason = e?.reason?.message || e?.reason || 'ë¹„ë™ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        show('[Promise ì˜¤ë¥˜] ' + reason);
      });
    })();

    let lastGeneratedHtml = '';
    let chatHistory = [];
    let lastBackgroundImageUrl = null;
    let designRows = [];  // [[row1 blocks], [row2 blocks]] - block: {bg, overlay} or {imageOnly:true, img}
    let canvasZoom = 1;
    let canvasTitle = 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°';
    let selectedDesign = null;  // { rowIdx, blockIdx } when a design card is clicked
    const TASK_LIST_KEYS = { chat: 'wava_task_list_chat', image: 'wava_task_list_image', cardnews: 'wava_task_list_cardnews', video: 'wava_task_list_video' };
    const TASK_FOLDERS_KEYS = { chat: 'wava_task_folders_chat', image: 'wava_task_folders_image', cardnews: 'wava_task_folders_cardnews', video: 'wava_task_folders_video' };
    let taskListChat = [];
    let taskListImage = [];
    let taskListCardnews = [];
    let taskListVideo = [];
    let taskFoldersChat = [];
    let taskFoldersImage = [];
    let taskFoldersCardnews = [];
    let taskFoldersVideo = [];
    let selectedFolderId = null;
    function getCurrentTaskList() {
      if (activeMenu === 'chat') return taskListChat;
      if (activeMenu === 'image') return taskListImage;
      if (activeMenu === 'video') return taskListVideo;
      return taskListCardnews;
    }
    function getCurrentTaskListKey() {
      return TASK_LIST_KEYS[activeMenu] || TASK_LIST_KEYS.image;
    }
    const CANVAS_HISTORY_KEY = 'wava_canvas_history';
    const DESIGN_RULES_KEY = 'wava_design_rules';
    let canvasHistory = [];
    let designRules = { cardnews: [], image: [], chat: [], video: [] };
    function isHowToCreateCardnewsRule(text) {
      if (!text || typeof text !== 'string') return false;
      const t = text.trim();
      return /ì¹´ë“œë‰´ìŠ¤.*\d+ì¥|ì¹´ë“œë‰´ìŠ¤.*ì‚¬ì´ì¦ˆ|ì¹´ë“œë‰´ìŠ¤.*ë¹„ìœ¨|ì¹´ë“œë‰´ìŠ¤.*í¬ê¸°|ì¹´ë“œë‰´ìŠ¤.*í˜•ì‹|ì¹´ë“œë‰´ìŠ¤.*ê¸°ì¤€|ì¹´ë“œë‰´ìŠ¤.*í˜•íƒœ|\d+ì¥.*ê¸°ì¤€|ì‚¬ì´ì¦ˆ.*9:16|ì‚¬ì´ì¦ˆ.*4:5|ë¹„ìœ¨.*9:16|ë¹„ìœ¨.*4:5/i.test(t);
    }
    (function loadDesignRules() {
      try {
        const raw = localStorage.getItem(DESIGN_RULES_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed.cardnews) designRules.cardnews = (parsed.cardnews || []).filter(r => !isHowToCreateCardnewsRule(r));
          if (parsed.image) designRules.image = parsed.image;
          try { localStorage.setItem(DESIGN_RULES_KEY, JSON.stringify(designRules)); } catch (_) {}
        }
      } catch (_) {}
    })();
    function getDesignRulesForMode() {
      if (activeMenu === 'cardnews') return designRules.cardnews;
      if (activeMenu === 'image') return designRules.image;
      if (activeMenu === 'chat') return designRules.chat;
      if (activeMenu === 'video') return designRules.video;
      return [];
    }
    function addDesignRule(rule) {
      const r = (rule || '').trim();
      if (!r) return;
      if (activeMenu === 'cardnews' && isHowToCreateCardnewsRule(r)) return;
      const arr = getDesignRulesForMode();
      if (arr.includes(r)) return;
      arr.push(r);
      if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory();
      else if (activeMenu === 'chat') saveChatTaskList();
      else try { localStorage.setItem(DESIGN_RULES_KEY, JSON.stringify(designRules)); } catch (_) {}
      renderDesignRulesPanel();
      renderChatRulesPanel();
    }
    function removeDesignRule(index) {
      const arr = getDesignRulesForMode();
      if (index < 0 || index >= arr.length) return;
      arr.splice(index, 1);
      if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory();
      else if (activeMenu === 'chat') saveChatTaskList();
      else try { localStorage.setItem(DESIGN_RULES_KEY, JSON.stringify(designRules)); } catch (_) {}
      renderDesignRulesPanel();
      renderChatRulesPanel();
    }
    function buildPromptWithRules(prompt) {
      const rules = getDesignRulesForMode();
      if (rules.length === 0) return prompt;
      const rulesText = rules.map(r => `- ${r}`).join('\n');
      return `[ì €ì¥ëœ ê·œì¹™ - ë°˜ë“œì‹œ ì ìš©]\n${rulesText}\n\n[ì‚¬ìš©ì ìš”ì²­]\n${prompt}`;
    }
    const DESIGN_UNDO_MAX = 50;
    let designUndoStack = [];
    let designRedoStack = [];
    function pushDesignState() {
      if (designRows.length === 0 && designUndoStack.length === 0) return;
      const state = { designRows: JSON.parse(JSON.stringify(designRows)), chatHistory: JSON.parse(JSON.stringify(chatHistory)), canvasTitle: canvasTitle, lastGeneratedHtml: lastGeneratedHtml || '' };
      designUndoStack.push(state);
      if (designUndoStack.length > DESIGN_UNDO_MAX) designUndoStack.shift();
      designRedoStack = [];
    }
    function doDesignUndo() {
      if (designUndoStack.length === 0) return;
      const state = designUndoStack.pop();
      designRedoStack.push({ designRows: JSON.parse(JSON.stringify(designRows)), chatHistory: JSON.parse(JSON.stringify(chatHistory)), canvasTitle: canvasTitle, lastGeneratedHtml: lastGeneratedHtml || '' });
      designRows = state.designRows;
      chatHistory = state.chatHistory;
      canvasTitle = state.canvasTitle;
      lastGeneratedHtml = state.lastGeneratedHtml || '';
      if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
      renderDesignChatMessages();
      if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
      else previewIframe.srcdoc = '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
      saveCanvasHistory();
    }
    function doDesignRedo() {
      if (designRedoStack.length === 0) return;
      const state = designRedoStack.pop();
      designUndoStack.push({ designRows: JSON.parse(JSON.stringify(designRows)), chatHistory: JSON.parse(JSON.stringify(chatHistory)), canvasTitle: canvasTitle, lastGeneratedHtml: lastGeneratedHtml || '' });
      designRows = state.designRows;
      chatHistory = state.chatHistory;
      canvasTitle = state.canvasTitle;
      lastGeneratedHtml = state.lastGeneratedHtml || '';
      if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
      renderDesignChatMessages();
      if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
      else previewIframe.srcdoc = '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
      saveCanvasHistory();
    }
    function renderDesignRulesPanel() {
      const listEl = document.getElementById('header-rules-list');
      const countEl = document.getElementById('header-rules-count');
      const rulesBtn = document.getElementById('header-rules-btn');
      if (!listEl) return;
      const rules = getDesignRulesForMode();
      if (countEl) { countEl.textContent = rules.length; countEl.classList.toggle('hidden', rules.length === 0); }
      listEl.innerHTML = rules.map((r, i) => `<div class="flex items-center gap-2 group py-1">
        <span class="flex-1 text-xs text-gray-700 truncate" title="${escapeHtml(r)}">${escapeHtml(r)}</span>
        <button type="button" data-rule-index="${i}" class="design-rule-delete shrink-0 p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded" title="ê·œì¹™ ì‚­ì œ">âœ•</button>
      </div>`).join('') || '<div class="text-xs text-gray-500 py-2">ì €ì¥ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
      listEl.querySelectorAll('.design-rule-delete').forEach(btn => {
        btn.addEventListener('click', () => removeDesignRule(parseInt(btn.dataset.ruleIndex, 10)));
      });
    }
    function renderChatRulesPanel() {
      const listEl = document.getElementById('ai-chat-rules-list');
      const countEl = document.getElementById('ai-chat-rules-count');
      if (!listEl) return;
      if (activeMenu !== 'chat') return;
      const rules = getDesignRulesForMode();
      if (countEl) { countEl.textContent = rules.length; countEl.classList.toggle('hidden', rules.length === 0); }
      listEl.innerHTML = rules.map((r, i) => `<div class="flex items-center gap-2 group py-1">
        <span class="flex-1 text-xs text-gray-700 truncate" title="${escapeHtml(r)}">${escapeHtml(r)}</span>
        <button type="button" data-rule-index="${i}" class="chat-rule-delete shrink-0 p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded" title="ê·œì¹™ ì‚­ì œ">âœ•</button>
      </div>`).join('') || '<div class="text-xs text-gray-500 py-2">ì €ì¥ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
      listEl.querySelectorAll('.chat-rule-delete').forEach(btn => {
        btn.addEventListener('click', () => removeDesignRule(parseInt(btn.dataset.ruleIndex, 10)));
      });
    }
    let pendingAttachments = [];
    let pendingDesignPrompt = null;  // { prompt, effectivePrompt, attachments, options } - í™•ì¸ ëŒ€ê¸° ì¤‘ì¸ ë””ìì¸ ìš”ì²­
    const STATUS_LABELS = { bg: 'ê¸°íšì¤‘', design: 'ì œì‘ ì¤‘', overlay: 'ì œì‘ ì¤‘', final: 'ì™„ë£Œ ì¤‘' };
    const loadingStatusBar = document.getElementById('loading-status-bar');

    function updateLoadingStatus(step, pct) {
      const label = STATUS_LABELS[step] || 'ì œì‘ ì¤‘';
      const text = pct != null ? `${label} ${pct}%` : label;
      if (loadingStatusBar) {
        loadingStatusBar.textContent = text;
        if (pct != null && pct > 0) loadingStatusBar.classList.remove('hidden');
      }
    }
    function showLoadingBar() {
    }
    function hideLoadingBar() {
      if (loadingStatusBar) loadingStatusBar.classList.add('hidden');
    }

    const SYSTEM_INSTRUCTION = `You are an expert web designer creating PREMIUM ad creatives. Output ONLY the TEXT/OVERLAY HTML in markdown code blocks. NO <html>, <head>, <body>. The system provides the background.
QUALITY RULES: 1. font-family: 'Pretendard', sans-serif; 2. When "ì´ë¯¸ì§€ ì¶”ê°€", add bottom section with {{IMAGE_1}}, {{IMAGE_2}} in a grid.
CRITICAL - EXACT TEXT: ALL text/copy provided by the user (L1, L2, L3, CTA, headlines, etc.) MUST be reproduced CHARACTER-FOR-CHARACTER. NEVER add any text, slogan, or element not explicitly in the user request. Never paraphrase. Never substitute similar Korean chars (ì¸í„°ë„·â‰ ì¸í…Œë¡œ, í˜„ê¸ˆâ‰ í˜•ê¸ˆ, ìš”ê¸ˆâ‰ ìœ ë£¸, ì„¤ê³„â‰ ì‹¤í—˜). Copy exactly. Zero tolerance for extra text.
MULTI-VARIATION MODE: When asked for "ì—¬ëŸ¬ ì‹œì•ˆ" or "3ê°€ì§€" etc., output 3 DIFFERENT variations. Each in its own code block: \`\`\`html ... \`\`\` \`\`\`html ... \`\`\` \`\`\`html ... \`\`\`. Different layouts/colors each.
MODIFICATION MODE: Change ONLY the requested part. Output the modified overlay HTML only (single block).
ADDITION MODE: Output NEW overlay. If user wants "ë‹¤ë¥¸ ë²„ì „/ë¹„êµ/ì¶”ê°€" without new copy, REUSE the exact same text from the reference. Only vary layout/colors. Never invent new text.`;

    function maskApiKey(key) {
      if (!key || key.length < 8) return 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      return 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + key.slice(-4);
    }
    function showApiSavedState() {
      const key = apiKeyInput.value.trim() || localStorage.getItem(STORAGE_KEY);
      const repInput = document.getElementById('replicate-token-input');
      const rep = repInput?.value.trim() || localStorage.getItem(REPLICATE_STORAGE_KEY);
      const btn = document.getElementById('api-settings-btn');
      if (key || rep) {
        if (btn) btn.title = 'API ì„¤ì •' + (key ? ' (Gemini ' + maskApiKey(key) + ')' : '') + (rep ? ' (Replicate ì €ì¥ë¨)' : '');
      }
    }
    function showApiInputState() {
      if (typeof switchView === 'function') switchView('settings');
    }
    document.getElementById('save-api-key')?.addEventListener('click', () => {
      const key = apiKeyInput.value.trim();
      const repInput = document.getElementById('replicate-token-input');
      const repToken = repInput ? repInput.value.trim() : '';
      if (!key && !repToken) { alert('Gemini API Key ë˜ëŠ” Replicate í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if (key) localStorage.setItem(STORAGE_KEY, key);
      if (repInput) localStorage.setItem(REPLICATE_STORAGE_KEY, repToken);
      showApiSavedState();
      if (typeof window.updateShoppingApiBanner === 'function') window.updateShoppingApiBanner();
    });
    document.getElementById('api-settings-btn')?.addEventListener('click', () => {
      switchView('settings');
    });
    document.getElementById('nav-sns-settings')?.addEventListener('click', () => {
      switchView('sns-settings');
    });
    document.getElementById('settings-back-btn')?.addEventListener('click', () => {
      switchView('home');
    });
    document.getElementById('sns-settings-back-btn')?.addEventListener('click', () => {
      switchView('home');
    });
    window.loadSnsInsights = async function() {
      const listEl = document.getElementById('sns-insights-list');
      if (!listEl) return;
      const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
      listEl.innerHTML = '<p class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
      try {
        const r = await fetch(apiBase + '/api/sns/insights');
        const data = await r.json().catch(() => ({}));
        const conns = data.connections || [];
        if (conns.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500">ì—°ë™ëœ ê³„ì •ì´ ì—†ê±°ë‚˜ ì„±ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          listEl.innerHTML = conns.map(function(c) {
            const name = (c.name || c.platform || '').replace(/</g, '&lt;');
            const platform = (c.platform || '').replace(/</g, '&lt;');
            const m = c.metrics || {};
            const parts = [];
            if (m.page_fans != null) parts.push('íŒ”ë¡œì›Œ: ' + m.page_fans);
            if (m.page_impressions != null) parts.push('ë…¸ì¶œ: ' + m.page_impressions);
            if (m.page_engaged_users != null) parts.push('ì°¸ì—¬: ' + m.page_engaged_users);
            if (m.impressions != null) parts.push('ë…¸ì¶œ: ' + m.impressions);
            if (m.reach != null) parts.push('ë„ë‹¬: ' + m.reach);
            if (m.profile_views != null) parts.push('í”„ë¡œí•„ì¡°íšŒ: ' + m.profile_views);
            if (m._error) parts.push('(ì˜¤ë¥˜)');
            const metricsStr = parts.length ? parts.join(' Â· ') : '(ì§€í‘œ ì—†ìŒ)';
            return '<div class="p-2 rounded-lg bg-gray-50 border border-gray-200"><div class="font-medium text-gray-800">' + name + ' <span class="text-xs text-gray-500">' + platform + '</span></div><div class="text-xs mt-1">' + metricsStr + '</div></div>';
          }).join('');
        }
      } catch (_) {
        listEl.innerHTML = '<p class="text-gray-500">ì„±ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„œë²„ ì—°ê²° í™•ì¸)</p>';
      }
    };
    document.getElementById('sns-insights-refresh-btn')?.addEventListener('click', function() {
      if (typeof window.loadSnsInsights === 'function') window.loadSnsInsights();
      document.getElementById('sns-insights-ai-report-result')?.classList.add('hidden');
    });
    document.getElementById('sns-insights-ai-report-btn')?.addEventListener('click', async function() {
      var resultEl = document.getElementById('sns-insights-ai-report-result');
      if (!resultEl) return;
      var btn = this;
      var apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
      var key = (apiKeyInput && apiKeyInput.value) ? apiKeyInput.value.trim() : (localStorage.getItem(STORAGE_KEY) || '');
      if (!key) { alert('Gemini API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
      btn.disabled = true;
      resultEl.innerHTML = 'AI ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...';
      resultEl.classList.remove('hidden');
      try {
        var r = await fetch(apiBase + '/api/sns/insights/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gemini_api_key: key })
        });
        var data = await r.json().catch(function() { return {}; });
        var reports = data.reports || [];
        if (!reports.length) { resultEl.innerHTML = 'ì—°ë™ ê³„ì •ì´ ì—†ê±°ë‚˜ ìƒì„±í•  ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'; }
        else {
          resultEl.innerHTML = reports.map(function(x) {
            var name = (x.name || '').replace(/</g, '&lt;');
            var report = (x.report || '').replace(/</g, '&lt;').replace(/\n/g, '<br>');
            return '<div class="p-2 rounded-lg bg-blue-50 border border-blue-100"><div class="font-medium text-gray-800">' + name + '</div><div class="text-gray-700 mt-1">' + report + '</div></div>';
          }).join('');
        }
      } catch (e) {
        resultEl.innerHTML = 'ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + (e.message || e);
      }
      btn.disabled = false;
    });
    // í˜ì´ì§€ ë¡œë“œ ì‹œ #settings + sns_connected / sns_error ìˆìœ¼ë©´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™ í›„ ë©”ì‹œì§€
    (function checkSettingsHash() {
      const hash = window.location.hash || '';
      const params = new URLSearchParams(window.location.search);
      if (hash !== '#settings' && !params.has('sns_connected') && !params.has('sns_error')) return;
      switchView('settings');
      if (params.has('sns_connected')) {
        const name = params.get('name') || 'ì—°ë™ë¨';
        alert('SNS ì—°ë™ ì™„ë£Œ: ' + decodeURIComponent(name));
        window.history.replaceState('', '', window.location.pathname + '#settings');
      }
      if (params.has('sns_error')) {
        const msg = params.get('sns_error') || 'ì—°ë™ ì‹¤íŒ¨';
        alert('SNS ì—°ë™ ì˜¤ë¥˜: ' + decodeURIComponent(msg));
        window.history.replaceState('', '', window.location.pathname + '#settings');
      }
      if (typeof window.loadSnsConnections === 'function') window.loadSnsConnections();
    })();
    window.loadSnsConnections = async function() {
      const listEl = document.getElementById('sns-connections-list');
      const fbBtn = document.getElementById('sns-connect-facebook-btn');
      const threadsBtn = document.getElementById('sns-connect-threads-btn');
      const youtubeBtn = document.getElementById('sns-connect-youtube-btn');
      const hint = document.getElementById('sns-auth-hint');
      const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
      if (fbBtn) fbBtn.href = apiBase + '/api/sns/auth/facebook';
      if (threadsBtn) threadsBtn.href = apiBase + '/api/sns/auth/threads';
      if (youtubeBtn) youtubeBtn.href = apiBase + '/api/sns/auth/youtube';
      if (!listEl) return;
      try {
        const r = await fetch(apiBase + '/api/sns/connections');
        const data = await r.json().catch(() => ({}));
        const conns = data.connections || [];
        if (conns.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-sm">ì—°ë™ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ë³„ë¡œ ì—¬ëŸ¬ ê³„ì •ì„ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
          if (hint) hint.classList.remove('hidden');
        } else {
          if (hint) hint.classList.add('hidden');
          listEl.innerHTML = conns.map(function(c) {
            const id = (c.id || '').replace(/</g, '&lt;');
            const name = (c.name || c.platform || '').replace(/</g, '&lt;');
            const platform = (c.platform || '').replace(/</g, '&lt;');
            return '<div class="flex justify-between items-center p-2 rounded-lg bg-gray-50 border border-gray-200"><span class="font-medium">' + name + '</span><span class="text-xs text-gray-500">' + platform + '</span><button type="button" class="sns-disconnect-btn px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded" data-connection-id="' + id + '" data-name="' + (name.replace(/"/g, '&quot;')) + '">ì—°ë™ í•´ì œ</button></div>';
          }).join('');
          listEl.querySelectorAll('.sns-disconnect-btn').forEach(function(btn) {
            btn.addEventListener('click', async function() {
              const cid = btn.dataset.connectionId;
              const name = (btn.dataset.name || 'ì´ ê³„ì •').replace(/&quot;/g, '"');
              if (!cid || !confirm(name + ' ì—°ë™ì„ í•´ì œí• ê¹Œìš”?')) return;
              try {
                const res = await fetch(apiBase + '/api/sns/disconnect/' + encodeURIComponent(cid), { method: 'POST' });
                if (res.ok) window.loadSnsConnections(); else alert('í•´ì œ ì‹¤íŒ¨');
              } catch (e) { alert('í•´ì œ ì‹¤íŒ¨: ' + (e.message || e)); }
            });
          });
        }
        } catch (e) {
        listEl.innerHTML = '<p class="text-red-600 text-sm">ì—°ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.)</p>';
        if (hint) hint.classList.remove('hidden');
      }
      var commentSel = document.getElementById('sns-comments-connection-id');
      if (commentSel && conns && conns.length) {
        var fbConns = conns.filter(function(c) { return c.platform === 'facebook'; });
        commentSel.innerHTML = fbConns.length ? fbConns.map(function(c) { return '<option value="' + (c.id || '').replace(/"/g, '&quot;') + '">' + (c.name || c.platform || '').replace(/</g, '&lt;') + '</option>'; }).join('') : '<option value="">Facebook ê³„ì • ì—†ìŒ</option>';
      }
    };
    (function initSnsCommentsUi() {
      const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
      document.getElementById('sns-comments-load-posts-btn')?.addEventListener('click', async function() {
        var sel = document.getElementById('sns-comments-connection-id');
        var list = document.getElementById('sns-comments-posts-list');
        var commentsList = document.getElementById('sns-comments-comments-list');
        var cid = sel?.value?.trim();
        if (!cid || !list) return;
        list.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        commentsList.innerHTML = '';
        try {
          var r = await fetch(apiBase + '/api/sns/posts?connection_id=' + encodeURIComponent(cid) + '&limit=10');
          var data = await r.json().catch(function() { return {}; });
          var posts = data.posts || [];
          if (!posts.length) { list.innerHTML = 'ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
          list.innerHTML = posts.map(function(p) {
            var msg = (p.message || '').slice(0, 40).replace(/</g, '&lt;');
            var pid = (p.id || '').replace(/"/g, '&quot;');
            return '<button type="button" class="sns-post-item block w-full text-left px-2 py-1 rounded border border-gray-200 hover:bg-gray-50 text-xs" data-post-id="' + pid + '" data-post-message="' + (p.message || '').slice(0, 200).replace(/"/g, '&quot;').replace(/</g, '&lt;') + '">' + msg + 'â€¦</button>';
          }).join('');
          list.querySelectorAll('.sns-post-item').forEach(function(btn) {
            btn.addEventListener('click', async function() {
              var postId = btn.dataset.postId;
              var postMessage = btn.dataset.postMessage || '';
              if (!postId || !commentsList) return;
              commentsList.innerHTML = 'ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
              try {
                var r2 = await fetch(apiBase + '/api/sns/comments?connection_id=' + encodeURIComponent(cid) + '&post_id=' + encodeURIComponent(postId));
                var data2 = await r2.json().catch(function() { return {}; });
                var comments = data2.comments || [];
                if (!comments.length) { commentsList.innerHTML = 'ëŒ“ê¸€ ì—†ìŒ'; return; }
                commentsList.innerHTML = comments.map(function(c) {
                  var fromName = (c.from && c.from.name) ? c.from.name : 'ìµëª…';
                  var msg = (c.message || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                  var cid2 = (c.id || '').replace(/"/g, '&quot;');
                  return '<div class="p-2 rounded bg-gray-50 border border-gray-200"><div class="text-gray-800">' + fromName + ': ' + msg + '</div><div class="mt-1 flex gap-1"><button type="button" class="sns-ai-reply-btn px-2 py-1 text-xs bg-[#2C96FF] text-white rounded hover:bg-[#2380e0]" data-comment-id="' + cid2 + '" data-comment-text="' + msg + '" data-post-message="' + postMessage + '">AI ë‹µê¸€</button><button type="button" class="sns-ai-dm-btn px-2 py-1 text-xs bg-[#0d9488] text-white rounded hover:bg-[#0f766e]" data-comment-id="' + cid2 + '" data-comment-text="' + msg + '" data-post-message="' + postMessage + '">ë¹„ê³µê°œ ë‹µê¸€(DM)</button></div></div>';
                }).join('');
                function attachAiReply(btn, isPrivate) {
                  var commentId = btn.dataset.commentId;
                  var commentText = btn.dataset.commentText || '';
                  var postMsg = btn.dataset.postMessage || '';
                  if (!commentId) return;
                  btn.disabled = true;
                  btn.textContent = 'ìƒì„± ì¤‘...';
                  var key = (apiKeyInput && apiKeyInput.value) ? apiKeyInput.value.trim() : (localStorage.getItem(STORAGE_KEY) || '');
                  var url = isPrivate ? (apiBase + '/api/sns/comments/ai-private-reply') : (apiBase + '/api/sns/comments/ai-reply');
                  fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ connection_id: cid, comment_id: commentId, comment_text: commentText, post_message: postMsg, gemini_api_key: key || undefined })
                  }).then(function(res) { return res.json().catch(function() { return {}; }).then(function(result) {
                    if (res.ok && result.ok) { btn.textContent = isPrivate ? 'DM ì™„ë£Œ' : 'ë‹µê¸€ ì™„ë£Œ'; } else { alert(result.detail || result.error || 'ì‹¤íŒ¨'); btn.textContent = isPrivate ? 'ë¹„ê³µê°œ ë‹µê¸€(DM)' : 'AI ë‹µê¸€'; btn.disabled = false; }
                  }); }).catch(function(e) { alert(e.message || e); btn.textContent = isPrivate ? 'ë¹„ê³µê°œ ë‹µê¸€(DM)' : 'AI ë‹µê¸€'; btn.disabled = false; });
                }
                commentsList.querySelectorAll('.sns-ai-reply-btn').forEach(function(b) {
                  b.addEventListener('click', function() { attachAiReply(b, false); });
                });
                commentsList.querySelectorAll('.sns-ai-dm-btn').forEach(function(b) {
                  b.addEventListener('click', function() { attachAiReply(b, true); });
                });
              } catch (_) { commentsList.innerHTML = 'ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; }
            });
          });
        } catch (e) { list.innerHTML = 'ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; }
      });
    })();
    if (localStorage.getItem(STORAGE_KEY)) {
      apiKeyInput.value = localStorage.getItem(STORAGE_KEY);
      const repInput = document.getElementById('replicate-token-input');
      if (repInput) repInput.value = localStorage.getItem(REPLICATE_STORAGE_KEY) || '';
      showApiSavedState();
    } else {
      document.getElementById('api-settings-btn').title = 'API ì„¤ì •';
    }
    loadCanvasHistory();
    renderCanvasHistory();

    document.getElementById('copy-api-key')?.addEventListener('click', async () => {
      const key = apiKeyInput.value;
      if (key) {
        try {
          await navigator.clipboard.writeText(key);
          document.getElementById('copy-api-key').title = 'ë³µì‚¬ë¨!';
        } catch {
          apiKeyInput.select();
          document.execCommand('copy');
        }
        setTimeout(() => { document.getElementById('copy-api-key').title = 'ë³µì‚¬'; }, 2000);
      }
    });

    function getCurrentAspectRatio() {
      if (activeMenu === 'cardnews' && designRows?.flat().some(b => b?.cardnewsSlide)) return '4:5';
      return '1:1';
    }
    function getDimensionsForRatio(ratio) {
      const sizes = { '1:1': [1080, 1080], '9:16': [1080, 1920], '16:9': [1920, 1080], '4:5': [1080, 1350] };
      const [w, h] = sizes[ratio] || sizes['1:1'];
      return { width: w, height: h };
    }
    function isModificationRequest(text) {
      return /ìˆ˜ì •|ë³€ê²½|ë°”ê¿”|ì‚­ì œ|ì œê±°|ìƒ‰ìƒ|ìƒ‰ê¹”|í¬ê¸°|í°íŠ¸|ë°”ê¿”ì¤˜|ìˆ˜ì •í•´|ë³€ê²½í•´|ì‚­ì œí•´|ì œê±°í•´|ì§€ì›Œ/i.test(text);
    }
    function isAdditionRequest(text) {
      return /ì¶”ê°€|ë”\s*ë§Œë“¤|ì´ë¯¸ì§€\s*ì¶”ê°€|ì¶”ê°€\s*ì œì‘|ì¶”ê°€í•´|ë”\s*í•´ì¤˜|ë˜\s*ë§Œë“¤|ì´ì–´ì„œ|ë²„ì „\s*ì¶”ê°€|ìƒˆ\s*ë²„ì „|ë‹¤ë¥¸\s*ë²„ì „|ë²„ì „\s*ë§Œë“¤|í•˜ë‚˜\s*ë”|ë‹¤ì‹œ\s*ë§Œë“¤|ë‹¤ì‹œ\s*ìƒì„±|ìƒˆë¡œ\s*ìƒì„±|ìƒˆë¡œ\s*ë§Œë“¤|ì‹ ê·œ\s*(?:ë¡œ\s*)?ìƒì„±|ë¹„êµ|ë‚˜ë€íˆ|ì•„ë˜ì—\s*ì¶”ê°€|ê¸°ì¡´.*ì¶”ê°€|ì¶”ê°€.*ì•„ë˜/i.test(text);
    }
    function needsBackgroundRegeneration(text) {
      return /ë°°ê²½|ì´ë¯¸ì§€|ì‚¬ì§„|ì˜¤ë¸Œì íŠ¸|ë©”ì¸\s*ì˜¤ë¸Œì íŠ¸|ë°°ì¹˜|ì‹¤ì‚¬|í˜„ê¸ˆ|ë­‰ì¹˜|ê°ì²´|ë¹„ì£¼ì–¼|ë¹„ì£¼ì–¼\s*ìš”ì†Œ/i.test(text);
    }
    function isConfirmationRequest(text) {
      if (!text || text.length > 60) return false;
      const t = text.trim();
      return /^(ì˜ˆ|ë„¤|ì‘|ê·¸ë˜|ì¢‹ì•„|ì¢‹ì•„ìš”|í™•ì¸|ìƒì„±í•´|ë§Œë“¤ì–´|í•´ì¤˜|ê·¸ë ‡ê²Œ\s*í•´|ì§„í–‰í•´|ì‹œì‘í•´)/i.test(t) ||
        /(ìƒì„±í•´\s*ì¤˜|ë§Œë“¤ì–´\s*ì¤˜|í•´\s*ì¤˜|ê·¸ë ‡ê²Œ\s*í•´ì¤˜|ì§„í–‰í•´\s*ì¤˜)/i.test(t);
    }
    function isDesignRequest(text) {
      if (!text || text.length < 3) return false;
      const isQuestion = /\?|ì–´ë–¤|ë¬´ì—‡|ì–´ë–»ê²Œ|ì™œ|ë­|ì•Œë ¤|ì„¤ëª…í•´|ì¡°ì–¸|ì¶”ì²œ|ì¢‹ì„ê¹Œ|ê°€ëŠ¥í•´/i.test(text);
      const genKeywords = /L1|L2|L3|CTA|ì‹œì•ˆ|ë¸Œë¦¬í”„|ë§Œë“¤ì–´|ìƒì„±|ì œì‘|3ì•ˆ|3ê°€ì§€|ë°°ê²½\s*ì œê±°|ë§¤ì§|ìš”ì†Œ\s*ì¶”ê°€|ìˆ˜ì •í•´|ë³€ê²½í•´|ì‚­ì œí•´|ì œê±°í•´/i;
      const hasModify = isModificationRequest(text);
      const hasAdd = isAdditionRequest(text);
      const hasMulti = getMultiRequestCount(text) >= 2;
      if (hasModify || hasAdd || hasMulti) return true;
      if (genKeywords.test(text)) return true;
      if (isQuestion && !genKeywords.test(text)) return false;
      if (text.length > 150 && /ê¸°íš|í†¤ì•¤ë§¤ë„ˆ|ì»¨ì…‰|ìŠ¤íƒ€ì¼|ë””ìì¸\s*ë¸Œë¦¬í”„/i.test(text)) return true;
      return false;
    }
    function getMultiRequestCount(text) {
      const m = text.match(/(?:í•œë²ˆì—\s*)?(\d)\s*ê°œ\s*(?:ë™ì‹œì—\s*)?(?:ì‘ì—…|ë§Œë“¤|í•´ì¤˜)/i);
      if (m) return Math.min(5, Math.max(2, parseInt(m[1], 10)));
      const m3 = text.match(/(\d)\s*ì•ˆ\s*(?:ìœ¼ë¡œ\s*)?(?:ìƒì„±|ë§Œë“¤|í•´ì¤˜)/i);
      if (m3) return Math.min(5, Math.max(2, parseInt(m3[1], 10)));
      if (/ì„¸\s*ê°€ì§€\s*(?:ë™ì‹œì—|í•œë²ˆì—|ì‘ì—…)/i.test(text)) return 3;
      if (/ë‘\s*ê°€ì§€\s*(?:ë™ì‹œì—|í•œë²ˆì—|ì‘ì—…)/i.test(text)) return 2;
      if (/ë„¤\s*ê°€ì§€\s*(?:ë™ì‹œì—|í•œë²ˆì—|ì‘ì—…)/i.test(text)) return 4;
      const m2 = text.match(/(\d)\s*ê°œ\s*(?:ë™ì‹œì—|í•œë²ˆì—)/i);
      if (m2) return Math.min(5, Math.max(2, parseInt(m2[1], 10)));
      return 0;
    }
    function getImageRequestCount(text) {
      if (!text) return 0;
      const m1 = text.match(/(\d)\s*ì¥\s*(?:ìƒì„±|ë§Œë“¤|í•´ì¤˜|ì´ë¯¸ì§€)/i) || text.match(/(?:ì´ë¯¸ì§€|ìƒì„±)\s*(\d)\s*ì¥/i);
      if (m1) return Math.min(5, Math.max(1, parseInt(m1[1], 10)));
      if (/í•œ\s*ì¥|1\s*ì¥|í•œ\s*ê°œ|1\s*ê°œ|í•œ\s*ì¥ë§Œ|1\s*ì¥ë§Œ/i.test(text)) return 1;
      const multi = getMultiRequestCount(text);
      if (multi >= 2) return multi;
      return 0;
    }
    function getCardnewsSlideCount(text) {
      if (!text) return 5;
      const m = text.match(/(\d+)\s*ì¥\s*(?:ì¹´ë“œë‰´ìŠ¤|ìŠ¬ë¼ì´ë“œ|ìƒì„±|ë§Œë“¤|í•´ì¤˜|ìœ¼ë¡œ)/i) || text.match(/(?:ì¹´ë“œë‰´ìŠ¤|ìŠ¬ë¼ì´ë“œ)\s*(\d+)\s*ì¥/i) || text.match(/(\d+)\s*ì¥\s*ìœ¼ë¡œ\s*(?:ë§Œë“¤|í•´ì¤˜)/i);
      if (m) return Math.min(10, Math.max(3, parseInt(m[1], 10)));
      return 5;
    }
    function isAdStyleRequest(text) {
      return /L1|L2|L3|CTA|ë¸Œë¦¬í”„|ë””ìì¸\s*ë¸Œë¦¬í”„|ê´‘ê³ |ë°°ë„ˆ|ë¬¸êµ¬|ìŠ¬ë¡œê±´|íƒ€ì´í‹€|í—¤ë“œë¼ì¸|ìì„¸íˆ\s*ë³´ê¸°|ì§€ê¸ˆ\s*ì‹œì‘/i.test(text);
    }

    function buildFinalPromptPreview(prompt) {
      const raw = (prompt || '').trim();
      if (!raw) return { meta: 'ì…ë ¥ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.', finalPrompt: '' };

      // ì˜ìƒ: prompt ì¡°ë¦½ â†’ ê·œì¹™ ì ìš©
      if (activeMenu === 'video') {
        const finalPrompt = buildPromptWithRules(generateVideoPrompt({ prompt: raw, product: raw, action: '', background: '', movement: '' }));
        return { meta: 'ëª¨ë“œ: ì˜ìƒ (ê·œì¹™ + í”„ë¡¬í”„íŠ¸ ë¹Œë” ì ìš©)', finalPrompt };
      }

      // ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤: sendToGeminiì—ì„œ ì‚¬ìš©í•˜ëŠ” effectivePrompt ë¡œì§ì„ ìµœëŒ€í•œ ë™ì¼í•˜ê²Œ ì¬í˜„
      const isModifyEarly = isModificationRequest(raw);
      const isAddEarly = isAdditionRequest(raw);
      const hasExistingDesigns = designRows.length > 0 && designRows.flat().length > 0;
      const allowImageModifyEarly = selectedDesign && isImageOnlyMode() && hasExistingDesigns;
      const isRegenerateRequest = isImageOnlyMode() && (isModifyEarly || isAddEarly) && hasExistingDesigns && !allowImageModifyEarly;

      let effectivePrompt = raw;
      if (isRegenerateRequest) {
        const firstUser = chatHistory.filter(m => m.role === 'user')[0]?.text || canvasTitle;
        effectivePrompt = `${firstUser}\n\n[ìˆ˜ì • ìš”ì²­] ${raw}`;
      } else if (isImageOnlyMode() && raw.length < 300 && /ë¸Œë¦¬í”„|í•˜ê¸°|3ì•ˆ|ì‹œì•ˆ|ìƒì„±/i.test(raw)) {
        const userMsgs = chatHistory.filter(m => m.role === 'user');
        const prevWithBrief = [...userMsgs].reverse().find(m => m.text && (m.text.includes('ë””ìì¸ ë¸Œë¦¬í”„') || m.text.includes('L1') || m.text.includes('L2') || m.text.length > 200));
        if (prevWithBrief?.text) effectivePrompt = prevWithBrief.text + '\n\n[ìš”ì²­] ' + raw;
      }

      if (activeMenu === 'cardnews' || activeMenu === 'image') effectivePrompt = buildPromptWithRules(effectivePrompt);
      return { meta: `ëª¨ë“œ: ${activeMenu === 'cardnews' ? 'ì¹´ë“œë‰´ìŠ¤' : 'ì´ë¯¸ì§€'} (ê·œì¹™ ìë™ ì ìš©)`, finalPrompt: effectivePrompt };
    }
    function parseMultiRequests(text, n) {
      const parts = text.split(/\s*(?=[1-5][.)]\s*)/).filter(s => s.trim());
      const cleaned = parts.map(s => s.replace(/^[1-5][.)]\s*/, '').trim()).filter(Boolean);
      const valid = cleaned.filter(p => p.length > 3 && !/^\d\s*ê°œ\s*ì‘ì—…/i.test(p));
      if (valid.length >= n) return valid.slice(0, n);
      const byNewline = text.split(/\n\s*[-â€“â€”]\s*\n|\n{2,}/).map(s => s.trim()).filter(s => s.length > 3);
      if (byNewline.length >= n) return byNewline.slice(0, n);
      return null;
    }

    const canvasView = document.getElementById('canvas-view');
    const aiChatView = document.getElementById('ai-chat-view');
    const homeView = document.getElementById('home-view');
    const shoppingView = document.getElementById('shopping-view');
    const snsFlowView = document.getElementById('sns-flow-view');
    const settingsView = document.getElementById('settings-view');
    const snsSettingsView = document.getElementById('sns-settings-view');
    const contextualSidebar = document.getElementById('contextual-sidebar');
    let snsFlowCurrentStep = 1;
    let snsFlowState = { ideas: [], selectedIdea: null, caption: '', hashtags: '' };
    function switchView(menu) {
      const prevMenu = activeMenu;
      if (prevMenu === 'chat') saveChatTaskList();
      if (prevMenu === 'image' || prevMenu === 'cardnews' || prevMenu === 'video') {
        saveCanvasHistory();
      }
      activeMenu = menu;
      try { localStorage.setItem(LAST_VIEW_KEY, menu); } catch (_) {}
      document.querySelectorAll('#global-nav [data-mode], #global-nav [data-menu]').forEach(el => {
        el.classList.remove('nav-item-active');
        el.classList.add('text-gray-400');
      });
      if (menu === 'home') {
        sidebarCollapsed = true;
        homeView?.classList.remove('hidden');
        shoppingView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.add('hidden');
        contextualSidebar?.classList.add('sidebar-collapsed');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°');
        snsSettingsView?.classList.add('hidden');
        const btn = document.getElementById('nav-home');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
      } else if (menu === 'settings') {
        sidebarCollapsed = true;
        homeView?.classList.add('hidden');
        shoppingView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.add('hidden');
        snsSettingsView?.classList.add('hidden');
        settingsView?.classList.remove('hidden');
        contextualSidebar?.classList.add('sidebar-collapsed');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°');
        const btn = document.getElementById('api-settings-btn');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        document.getElementById('nav-sns-settings')?.classList.remove('nav-item-active');
        document.getElementById('nav-sns-settings')?.classList.add('text-gray-400');
      } else if (menu === 'sns-settings') {
        sidebarCollapsed = true;
        homeView?.classList.add('hidden');
        shoppingView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        snsSettingsView?.classList.remove('hidden');
        contextualSidebar?.classList.add('sidebar-collapsed');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°');
        const btn = document.getElementById('nav-sns-settings');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        document.getElementById('api-settings-btn')?.classList.remove('nav-item-active');
        document.getElementById('api-settings-btn')?.classList.add('text-gray-400');
        if (typeof window.loadSnsConnections === 'function') window.loadSnsConnections();
      } else if (menu === 'chat') {
        selectedFolderId = null;
        sidebarCollapsed = false;
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ ì ‘ê¸°');
        homeView?.classList.add('hidden');
        shoppingView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        snsSettingsView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.remove('hidden');
        contextualSidebar?.classList.remove('sidebar-collapsed');
        document.getElementById('sidebar-task-list')?.classList.remove('hidden');
        document.getElementById('sidebar-design-prompt')?.classList.add('hidden');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        document.getElementById('ai-canvas-folder-view')?.classList.add('hidden');
        document.getElementById('canvas-scroll-area')?.classList.remove('hidden');
        const btn = document.getElementById('nav-chat');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        loadAllTaskLists();
        const currChat = taskListChat.find(i => i.id === 'current');
        aiChatHistory = Array.isArray(currChat?.messages) ? JSON.parse(JSON.stringify(currChat.messages)) : [];
        designRules.chat = Array.isArray(currChat?.designRules) ? [...currChat.designRules] : [];
        renderAiChatMessages();
        renderCanvasHistory();
        renderFolderItemsInChat();
        renderChatRulesPanel();
      } else if (menu === 'shopping') {
        sidebarCollapsed = true;
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°');
        homeView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        snsSettingsView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.add('hidden');
        shoppingView?.classList.remove('hidden');
        contextualSidebar?.classList.add('sidebar-collapsed');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        const btn = document.getElementById('nav-shopping');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        if (typeof window.updateShoppingApiBanner === 'function') window.updateShoppingApiBanner();
      } else if (menu === 'sns-flow') {
        sidebarCollapsed = true;
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°');
        homeView?.classList.add('hidden');
        shoppingView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        snsSettingsView?.classList.add('hidden');
        canvasView?.classList.add('hidden');
        aiChatView?.classList.add('hidden');
        snsFlowView?.classList.remove('hidden');
        contextualSidebar?.classList.add('sidebar-collapsed');
        document.getElementById('task-list-overlay')?.classList.add('hidden');
        const btn = document.getElementById('nav-sns-flow');
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        if (typeof window.renderSnsFlowStep === 'function') window.renderSnsFlowStep(snsFlowCurrentStep);
      } else {
        sidebarCollapsed = false;
        document.getElementById('nav-sidebar-toggle')?.setAttribute('title', 'ì‘ì—… ëª©ë¡ ì ‘ê¸°');
        homeView?.classList.add('hidden');
        shoppingView?.classList.add('hidden');
        snsFlowView?.classList.add('hidden');
        settingsView?.classList.add('hidden');
        document.getElementById('sidebar-task-list')?.classList.add('hidden');
        document.getElementById('sidebar-design-prompt')?.classList.remove('hidden');
        settingsView?.classList.add('hidden');
        snsSettingsView?.classList.add('hidden');
        contextualSidebar?.classList.remove('sidebar-collapsed');
        canvasHistory = menu === 'image' ? taskListImage : (menu === 'video' ? taskListVideo : taskListCardnews);
        renderCanvasHistory();
        canvasView?.classList.remove('hidden');
        aiChatView?.classList.add('hidden');
        const btn = menu === 'image' ? document.getElementById('nav-image') : (menu === 'video' ? document.getElementById('nav-video') : document.getElementById('nav-cardnews'));
        if (btn) { btn.classList.add('nav-item-active'); btn.classList.remove('text-gray-400'); }
        document.getElementById('cardnews-toolbar')?.classList.add('hidden');
        // video-toolbar removed
        if (menu === 'video') {
          setVideoModeUi(true);
          const curr = canvasHistory.find(i => i.id === 'current');
          canvasTitle = curr?.title || 'ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°';
          designRows = [];
          chatHistory = Array.isArray(curr?.chatHistory) && curr.chatHistory.length > 0 ? JSON.parse(JSON.stringify(curr.chatHistory)) : [];
          designRules.video = Array.isArray(curr?.designRules) ? [...curr.designRules] : [];
          currentVideoJobId = curr?.videoJobId || null;
          if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
          if (currentVideoJobId) startVideoPolling(currentVideoJobId);
          else setVideoPreviewHtml('<div style="color:#9ca3af;font-size:14px;font-weight:600;">ì˜ìƒ ìƒì„± ëŒ€ê¸°</div>');
          canvasScrollArea?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-outer')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-wrapper')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('design-edit-panel')?.classList.add('hidden');
          renderDesignChatMessages();
        } else {
          setVideoModeUi(false);
          const curr = canvasHistory.find(i => i.id === 'current');
          if (curr) {
            canvasTitle = curr.title;
            designRows = Array.isArray(curr.designRows) ? JSON.parse(JSON.stringify(curr.designRows)) : [];
            chatHistory = Array.isArray(curr.chatHistory) && curr.chatHistory.length > 0 ? JSON.parse(JSON.stringify(curr.chatHistory)) : [];
            const rules = Array.isArray(curr.designRules) ? curr.designRules : [];
            if (menu === 'cardnews') { designRules.cardnews = [...rules]; document.getElementById('cardnews-toolbar')?.classList.remove('hidden'); }
            else designRules.image = [...rules];
          } else {
            canvasTitle = menu === 'cardnews' ? 'ì¹´ë“œë‰´ìŠ¤ ë¯¸ë¦¬ë³´ê¸°' : 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°';
            designRows = [];
            chatHistory = [];
            if (menu === 'cardnews') { designRules.cardnews = []; document.getElementById('cardnews-toolbar')?.classList.remove('hidden'); }
            else designRules.image = [];
          }
          if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
          renderDesignChatMessages();
          if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
          else {
            previewIframe.srcdoc = buildRowsDisplayHtml() || '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
            canvasScrollArea?.classList.remove('canvas-cardnews-mode');
            document.getElementById('canvas-zoom-outer')?.classList.remove('canvas-cardnews-mode');
            document.getElementById('canvas-zoom-wrapper')?.classList.remove('canvas-cardnews-mode');
          }
        }
        if (promptInput) promptInput.placeholder = menu === 'cardnews' ? 'ì¹´ë“œë‰´ìŠ¤ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê±´ê°•í•œ ì•„ì¹¨ ì‹ì‚¬ ìŠµê´€, 5ì¥ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜)' : (menu === 'video' ? 'ì œí’ˆëª…, ë°°ê²½ ë¶„ìœ„ê¸°, í–‰ë™(ì˜ˆ: ì œí’ˆ ì‚¬ìš©í•˜ëŠ” ëª¨ìŠµ)ì„ ì…ë ¥í•˜ì„¸ìš”' : 'ë””ìì¸ ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”');
        const attachmentPreview = document.getElementById('attachment-preview');
        if (attachmentPreview && (menu === 'image' || menu === 'cardnews')) {
          const hasImageAttachments = pendingAttachments.some(a => a.type?.startsWith('image/'));
          attachmentPreview.classList.toggle('hidden', !hasImageAttachments);
        }
        renderDesignRulesPanel();
        renderFolderItemsInCanvas();
      }
    }

    // ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°(ì˜ìƒ/ì´ë¯¸ì§€/ì¹´ë“œë‰´ìŠ¤ ê³µí†µ)
    (function initFinalPromptPreview() {
      const btn = document.getElementById('final-prompt-preview-btn');
      const modal = document.getElementById('final-prompt-modal');
      const backdrop = document.getElementById('final-prompt-modal-backdrop');
      const closeBtn = document.getElementById('final-prompt-close-btn');
      const copyBtn = document.getElementById('final-prompt-copy-btn');
      const ta = document.getElementById('final-prompt-textarea');
      const metaEl = document.getElementById('final-prompt-meta');
      const rulesEl = document.getElementById('final-prompt-rules');
      const open = () => {
        if (!modal || !ta) return;
        const raw = (promptInput?.value || '').trim();
        const { meta, finalPrompt } = buildFinalPromptPreview(raw);
        ta.value = finalPrompt || '';
        if (metaEl) metaEl.textContent = meta || '';
        if (rulesEl) {
          const rules = getDesignRulesForMode();
          rulesEl.innerHTML = (Array.isArray(rules) && rules.length)
            ? rules.map(r => `<div class="flex items-start gap-2 py-0.5"><span class="text-gray-400">-</span><span class="flex-1 break-words">${escapeHtml(String(r || '').trim())}</span></div>`).join('')
            : '<div class="text-gray-400">ì €ì¥ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        modal.classList.remove('hidden');
      };
      const close = () => modal?.classList.add('hidden');
      btn?.addEventListener('click', (e) => { e.stopPropagation(); open(); });
      backdrop?.addEventListener('click', close);
      closeBtn?.addEventListener('click', close);
      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(ta?.value || '');
          copyBtn.title = 'ë³µì‚¬ë¨!';
          setTimeout(() => { copyBtn.title = 'ë³µì‚¬'; }, 1200);
        } catch (_) {}
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) close();
      });
    })();
    function autoResizeChatInput(el) {
      if (!el) return;
      try {
        el.style.height = 'auto';
        const h = Math.max(44, Math.min(el.scrollHeight, 200));
        el.style.height = h + 'px';
      } catch (_) {}
    }
    function autoResizeRulesInput(el) {
      if (!el) return;
      try {
        el.style.height = 'auto';
        const h = Math.max(40, Math.min(el.scrollHeight, 72));
        el.style.height = h + 'px';
      } catch (_) {}
    }
    function initChatInputAutoResize() {
      try {
        ['home-view-input', 'folder-view-input', 'ai-chat-input'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', () => autoResizeChatInput(el));
          el.addEventListener('focus', () => autoResizeChatInput(el));
        });
      } catch (_) {}
    }
    initChatInputAutoResize();
    (function initRulesInputAutoResize() {
      ['header-rules-input', 'ai-chat-rules-input'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => autoResizeRulesInput(el));
        el.addEventListener('focus', () => autoResizeRulesInput(el));
      });
    })();
    document.getElementById('nav-home')?.addEventListener('click', () => switchView('home'));
    document.getElementById('nav-logo')?.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
    document.body.addEventListener('click', (e) => {
      const homeView = document.getElementById('home-view');
      if (!homeView?.contains(e.target)) return;
      const card = e.target.closest('.home-view-card[data-home-nav]');
      const subBtn = e.target.closest('.home-view-create-sub button[data-home-nav]');
      if (subBtn) {
        const nav = subBtn.getAttribute('data-home-nav');
        if (nav) switchView(nav);
        return;
      }
      if (card) {
        const nav = card.getAttribute('data-home-nav');
        if (nav && nav !== 'create') switchView(nav);
      }
    });

    // SNS ì›ìŠ¤í†±: ë‹¨ê³„ ì „í™˜ + ê¸°íš/ìº¡ì…˜ ìƒì„±
    (function initSnsFlow() {
      window.renderSnsFlowStep = function(step) {
        snsFlowCurrentStep = step;
        document.querySelectorAll('.sns-step-btn').forEach(b => {
          const s = parseInt(b.dataset.snsStep, 10);
          if (s === step) { b.classList.add('bg-[#2C96FF]', 'text-white'); b.classList.remove('bg-gray-100', 'text-gray-600'); }
          else { b.classList.remove('bg-[#2C96FF]', 'text-white'); b.classList.add('bg-gray-100', 'text-gray-600'); }
        });
        document.querySelectorAll('.sns-step-panel').forEach((p, i) => { p.classList.toggle('hidden', i + 1 !== step); });
        const step2Sel = document.getElementById('sns-step2-selected');
        if (step2Sel && snsFlowState.selectedIdea) step2Sel.textContent = snsFlowState.selectedIdea;
        if (step === 4) {
          if (typeof window.refreshSnsScheduleList === 'function') window.refreshSnsScheduleList();
          if (typeof window.refreshSnsPublishAccounts === 'function') window.refreshSnsPublishAccounts();
          if (typeof window.refreshSnsSuggestedTimes === 'function') window.refreshSnsSuggestedTimes();
        }
      };
      window.refreshSnsSuggestedTimes = async function() {
        var el = document.getElementById('sns-suggested-times');
        var reasonEl = document.getElementById('sns-suggested-reason');
        var dtEl = document.getElementById('sns-schedule-datetime');
        var sel = document.getElementById('sns-publish-connection-id');
        if (!el) return;
        var apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
        try {
          var cid = (sel && sel.value ? String(sel.value).trim() : '');
          var url = apiBase + '/api/sns/schedule/suggested-times' + (cid ? ('?connection_id=' + encodeURIComponent(cid)) : '');
          var r = await fetch(url);
          var data = await r.json().catch(function() { return {}; });
          var suggested = data.suggested || [];
          var reason = data.reason || '';
          if (reasonEl) reasonEl.textContent = reason;
          if (!suggested.length) { el.innerHTML = ''; return; }
          el.innerHTML = suggested.map(function(s) {
            var dt = (s.datetime || '').slice(0, 16);
            var label = (s.label || dt).replace(/</g, '&lt;');
            return '<button type="button" class="sns-suggested-time-btn px-3 py-1.5 rounded-lg text-sm bg-gray-100 hover:bg-gray-200 text-gray-800" data-datetime="' + (dt.replace(/"/g, '&quot;')) + '">' + label + '</button>';
          }).join('');
          el.querySelectorAll('.sns-suggested-time-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var dt = btn.dataset.datetime;
              if (dt && dtEl) dtEl.value = dt;
            });
          });
        } catch (_) { el.innerHTML = ''; if (reasonEl) reasonEl.textContent = ''; }
      };
      window.refreshSnsScheduleList = async function() {
        const list = document.getElementById('sns-schedule-list');
        if (!list) return;
        const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
        list.innerHTML = '<p class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        try {
          const r = await fetch(apiBase + '/api/sns/schedule?include_posted=true');
          const data = await r.json().catch(() => ({}));
          const arr = data.items || [];
          if (arr.length === 0) {
            list.innerHTML = '<p class="text-gray-500">ì˜ˆì•½ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ ì§€ì • ì‹œê°„ì— ìë™ ë°œí–‰ë©ë‹ˆë‹¤.</p>';
          } else {
            list.innerHTML = arr.map(function(x) {
              const at = (x.scheduled_at || '').slice(0, 16).replace('T', ' ');
              const status = x.status || 'pending';
              const statusLabel = status === 'posted' ? ' (ë°œí–‰ë¨)' : (status === 'failed' ? ' (ì‹¤íŒ¨)' : '');
              const cap = (x.caption || '').slice(0, 28);
              const id = (x.id || '').replace(/"/g, '&quot;');
              const canDel = status === 'pending';
              return '<div class="flex justify-between items-center p-2 rounded-lg bg-white border border-gray-200"><span>' + at + statusLabel + ' ' + cap + 'â€¦</span>' + (canDel ? '<button type="button" class="sns-schedule-del text-red-600 text-xs" data-id="' + id + '">ì‚­ì œ</button>' : '') + '</div>';
            }).join('');
            list.querySelectorAll('.sns-schedule-del').forEach(function(btn) {
              btn.addEventListener('click', async function() {
                const id = btn.dataset.id;
                if (!id || !confirm('ì´ ì˜ˆì•½ì„ ì‚­ì œí• ê¹Œìš”?')) return;
                try {
                  const res = await fetch(apiBase + '/api/sns/schedule/' + encodeURIComponent(id), { method: 'DELETE' });
                  if (res.ok) window.refreshSnsScheduleList(); else alert('ì‚­ì œ ì‹¤íŒ¨');
                } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
              });
            });
          }
        } catch (_) {
          list.innerHTML = '<p class="text-gray-500">ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„œë²„ ì—°ê²° í™•ì¸)</p>';
        }
      };
      window.refreshSnsPublishAccounts = async function() {
        const sel = document.getElementById('sns-publish-connection-id');
        const btn = document.getElementById('sns-publish-now-btn');
        if (!sel) return;
        const ytWrap = document.getElementById('sns-youtube-video-url-wrap');
        const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
        sel.innerHTML = '<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
        if (btn) btn.disabled = true;
        var conns = [];
        try {
          const r = await fetch(apiBase + '/api/sns/connections');
          const data = await r.json().catch(() => ({}));
          conns = data.connections || [];
          if (conns.length === 0) {
            sel.innerHTML = '<option value="">ì—°ë™ëœ ê³„ì • ì—†ìŒ (ì„¤ì •ì—ì„œ ì—°ê²°)</option>';
          } else {
            sel.innerHTML = conns.map(function(c) {
              const id = (c.id || '').replace(/"/g, '&quot;');
              const nm = (c.name || c.platform || c.id || '').replace(/</g, '&lt;');
              const pf = (c.platform || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
              return '<option value="' + id + '" data-platform="' + pf + '">' + nm + ' (' + pf + ')</option>';
            }).join('');
          }
        } catch (_) {
          sel.innerHTML = '<option value="">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>';
        }
        if (btn) btn.disabled = conns.length === 0;
        try {
          const pf = sel?.selectedOptions?.[0]?.dataset?.platform || '';
          if (ytWrap) ytWrap.classList.toggle('hidden', pf !== 'youtube');
        } catch (_) { if (ytWrap) ytWrap.classList.add('hidden'); }
        // ê³„ì • ëª©ë¡ì´ ë°”ë€Œë©´ ì¶”ì²œ ì‹œê°„ë„ ê°±ì‹ 
        if (typeof window.refreshSnsSuggestedTimes === 'function') window.refreshSnsSuggestedTimes();
      };
      // Step4ì—ì„œ ê³„ì • ì„ íƒì„ ë°”ê¾¸ë©´ ì¶”ì²œ ì‹œê°„ë„ ì¦‰ì‹œ ê°±ì‹ 
      document.getElementById('sns-publish-connection-id')?.addEventListener('change', () => {
        if (typeof window.refreshSnsSuggestedTimes === 'function') window.refreshSnsSuggestedTimes();
        const ytWrap = document.getElementById('sns-youtube-video-url-wrap');
        try {
          const sel = document.getElementById('sns-publish-connection-id');
          const pf = sel?.selectedOptions?.[0]?.dataset?.platform || '';
          if (ytWrap) ytWrap.classList.toggle('hidden', pf !== 'youtube');
        } catch (_) { if (ytWrap) ytWrap.classList.add('hidden'); }
      });
      document.querySelectorAll('.sns-step-btn').forEach(btn => {
        btn.addEventListener('click', () => { const s = parseInt(btn.dataset.snsStep, 10); if (s) window.renderSnsFlowStep(s); });
      });
      document.getElementById('sns-plan-generate-btn')?.addEventListener('click', async () => {
        const input = document.getElementById('sns-plan-input');
        const listEl = document.getElementById('sns-plan-list');
        const loadingEl = document.getElementById('sns-plan-loading');
        const topic = (input?.value || '').trim();
        if (!topic) { alert('ì£¼ì œë‚˜ ë°©í–¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        const apiKey = (apiKeyInput?.value || '').trim() || localStorage.getItem(STORAGE_KEY) || '';
        if (!apiKey) { alert('Gemini API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (listEl) listEl.innerHTML = '';
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: `ë‹¤ìŒ ì£¼ì œë¡œ SNS ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ 5ê°œë§Œ ê°„ë‹¨íˆ ì œì•ˆí•´ì¤˜. ê° ì•„ì´ë””ì–´ëŠ” í•œ ì¤„ë¡œ, ë²ˆí˜¸ ì—†ì´ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„.\n\nì£¼ì œ: ${topic}` }] }],
              generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
            })
          });
          const data = await res.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const lines = text.split(/\n+/).map(s => s.replace(/^\d+[.)]\s*/, '').trim()).filter(s => s.length > 2).slice(0, 10);
          snsFlowState.ideas = lines;
          if (listEl) listEl.innerHTML = lines.map((idea, i) => `<button type="button" class="sns-idea-item block w-full text-left px-4 py-3 rounded-lg border border-gray-200 bg-white hover:border-[#2C96FF] hover:bg-blue-50/50 text-sm transition-colors" data-idea="${i}">${idea}</button>`).join('');
          listEl.querySelectorAll('.sns-idea-item').forEach(b => b.addEventListener('click', function() {
            const i = parseInt(this.dataset.idea, 10);
            snsFlowState.selectedIdea = snsFlowState.ideas[i];
            window.renderSnsFlowStep(2);
          }));
        } catch (e) { if (listEl) listEl.innerHTML = '<p class="text-red-600 text-sm">ìƒì„± ì‹¤íŒ¨: ' + (e.message || e) + '</p>'; }
        if (loadingEl) loadingEl.classList.add('hidden');
      });
      document.getElementById('sns-goto-cardnews-btn')?.addEventListener('click', () => {
        if (snsFlowState.selectedIdea) { switchView('cardnews'); if (promptInput) { promptInput.value = snsFlowState.selectedIdea + '\n\nìœ„ ì£¼ì œë¡œ ì¹´ë“œë‰´ìŠ¤ 5ì¥ ë§Œë“¤ì–´ì¤˜'; promptInput.dispatchEvent(new Event('input', { bubbles: true })); } }
      });
      document.getElementById('sns-goto-video-btn')?.addEventListener('click', () => {
        if (snsFlowState.selectedIdea) {
          switchView('video');
          if (promptInput) {
            promptInput.value = snsFlowState.selectedIdea + '\n\nìœ„ ì£¼ì œë¡œ 10~15ì´ˆ ë¶„ëŸ‰ì˜ ìˆí¼ ê´‘ê³  ì˜ìƒì„ ë§Œë“¤ì–´ì¤˜. ì¥ë©´ì€ 3~5ì»·ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ìë§‰ ë¬¸êµ¬ì™€ BGM ë¶„ìœ„ê¸°ë„ ì œì•ˆí•´ì¤˜.';
            promptInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
      });
      document.getElementById('sns-caption-generate-btn')?.addEventListener('click', async () => {
        const loadingEl = document.getElementById('sns-caption-loading');
        const resultEl = document.getElementById('sns-caption-result');
        const captionEl = document.getElementById('sns-caption-text');
        const hashtagsEl = document.getElementById('sns-hashtags');
        const apiKey = (apiKeyInput?.value || '').trim() || localStorage.getItem(STORAGE_KEY) || '';
        if (!apiKey) { alert('Gemini API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
        const idea = snsFlowState.selectedIdea || '';
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (resultEl) resultEl.classList.add('hidden');
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: `ë‹¤ìŒ ì½˜í…ì¸  ì£¼ì œì— ë§ëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ ê²Œì‹œë¬¼ ìº¡ì…˜(2~3ë¬¸ì¥)ê³¼ í•´ì‹œíƒœê·¸ 5~8ê°œë¥¼ ìƒì„±í•´ì¤˜. ë‹µë³€ í˜•ì‹:\nìº¡ì…˜:\n(ìº¡ì…˜ ë‚´ìš©)\ní•´ì‹œíƒœê·¸:\n#íƒœê·¸1 #íƒœê·¸2 ...\n\nì£¼ì œ: ${idea || 'SNS ì½˜í…ì¸ '}` }] }],
              generationConfig: { temperature: 0.7, maxOutputTokens: 512 }
            })
          });
          const data = await res.json();
          const text = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').trim();
          let caption = '', hashtags = '';
          const capM = text.match(/ìº¡ì…˜\s*:?\s*([\s\S]*?)(?=í•´ì‹œíƒœê·¸|#|$)/i);
          const tagM = text.match(/(#[\wê°€-í£]+(?:\s*#[\wê°€-í£]+)*)/);
          if (capM) caption = capM[1].trim();
          if (tagM) hashtags = tagM[1].trim(); else hashtags = text.match(/#[\wê°€-í£]+/g)?.join(' ') || '';
          snsFlowState.caption = caption; snsFlowState.hashtags = hashtags;
          if (captionEl) captionEl.value = caption;
          if (hashtagsEl) hashtagsEl.value = hashtags;
          if (resultEl) resultEl.classList.remove('hidden');
        } catch (e) { alert('ìº¡ì…˜ ìƒì„± ì‹¤íŒ¨: ' + (e.message || e)); }
        if (loadingEl) loadingEl.classList.add('hidden');
      });
      document.getElementById('sns-caption-copy-btn')?.addEventListener('click', () => {
        const captionEl = document.getElementById('sns-caption-text');
        const hashtagsEl = document.getElementById('sns-hashtags');
        const text = (captionEl?.value || '') + '\n\n' + (hashtagsEl?.value || '');
        if (text.trim()) navigator.clipboard.writeText(text.trim()).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
      });
      document.getElementById('sns-schedule-save-btn')?.addEventListener('click', async () => {
        const dtEl = document.getElementById('sns-schedule-datetime');
        const sel = document.getElementById('sns-publish-connection-id');
        const datetime = dtEl?.value || '';
        const connectionId = sel?.value?.trim();
        if (!datetime) { alert('ì˜ˆì•½ ì¼ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        if (!connectionId) { alert('ë°œí–‰í•  ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        const platform = sel?.selectedOptions?.[0]?.dataset?.platform || '';
        const ytVideoUrl = (document.getElementById('sns-youtube-video-url')?.value || '').trim();
        if (platform === 'youtube' && !ytVideoUrl) { alert('YouTube ì˜ˆì•½ ë°œí–‰ì€ ì—…ë¡œë“œí•  ì˜ìƒ URLì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        const captionEl = document.getElementById('sns-caption-text');
        const hashtagsEl = document.getElementById('sns-hashtags');
        const caption = (captionEl?.value || '').trim() || snsFlowState.caption || '';
        const hashtags = (hashtagsEl?.value || '').trim() || snsFlowState.hashtags || '';
        const text = (caption + (caption && hashtags ? '\n\n' : '') + hashtags).trim();
        if (!text) { alert('ìº¡ì…˜ì„ ì…ë ¥í•˜ê±°ë‚˜ 3ë‹¨ê³„ì—ì„œ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
        const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
        const scheduledAt = datetime.length === 16 ? datetime + ':00' : datetime;
        try {
          const res = await fetch(apiBase + '/api/sns/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ connection_id: connectionId, caption: text, scheduled_at: scheduledAt, idea: snsFlowState.selectedIdea || null, video_url: platform === 'youtube' ? ytVideoUrl : undefined })
          });
          if (!res.ok) { const d = await res.json().catch(() => ({})); alert(d.detail || 'ì €ì¥ ì‹¤íŒ¨'); return; }
          if (dtEl) dtEl.value = '';
          window.refreshSnsScheduleList();
        } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || e)); }
      });
      document.getElementById('sns-publish-now-btn')?.addEventListener('click', async () => {
        const sel = document.getElementById('sns-publish-connection-id');
        const connectionId = sel?.value?.trim();
        if (!connectionId) { alert('ë°œí–‰í•  ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ì„¤ì •ì—ì„œ SNSë¥¼ ì—°ë™í•œ ë’¤ 4ë‹¨ê³„ì—ì„œ ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        const platform = sel?.selectedOptions?.[0]?.dataset?.platform || '';
        const ytVideoUrl = (document.getElementById('sns-youtube-video-url')?.value || '').trim();
        if (platform === 'youtube' && !ytVideoUrl) { alert('YouTube ë°œí–‰ì€ ì—…ë¡œë“œí•  ì˜ìƒ URLì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        const captionEl = document.getElementById('sns-caption-text');
        const hashtagsEl = document.getElementById('sns-hashtags');
        const caption = (captionEl?.value || '').trim() || snsFlowState.caption || '';
        const hashtags = (hashtagsEl?.value || '').trim() || snsFlowState.hashtags || '';
        const text = (caption + (caption && hashtags ? '\n\n' : '') + hashtags).trim();
        if (!text) { alert('ìº¡ì…˜ì„ ì…ë ¥í•˜ê±°ë‚˜ 3ë‹¨ê³„ì—ì„œ ìº¡ì…˜ì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
        const apiBase = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'http://localhost:8000';
        const btn = document.getElementById('sns-publish-now-btn');
        if (btn) { btn.disabled = true; btn.textContent = 'ë°œí–‰ ì¤‘...'; }
        try {
          const res = await fetch(apiBase + '/api/sns/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ connection_id: connectionId, caption: text, video_url: platform === 'youtube' ? ytVideoUrl : undefined })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.ok) {
            alert('ì„ íƒí•œ ê³„ì •ì— ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            alert(data.detail || data.error || 'ë°œí–‰ ì‹¤íŒ¨. ì„¤ì •ì—ì„œ ì—°ë™ ê³„ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
          }
        } catch (e) {
          alert('ë°œí–‰ ìš”ì²­ ì‹¤íŒ¨: ' + (e.message || e) + '. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€, ì—°ë™ì´ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }
        if (btn) { btn.disabled = false; btn.textContent = 'ì§€ê¸ˆ ë°œí–‰'; }
      });
      document.querySelectorAll('.sns-step-btn').forEach(b => { b.classList.add('bg-gray-100', 'text-gray-600'); });
    })();

    // ì‡¼í•‘: ì¦‰ì‹œ ì„ì‹œ ì¸ë„¤ì¼ + ë°±ì—”ë“œ í´ë§ í›„ ì‹¤ì œ ê²°ê³¼ êµì²´
    (function initShoppingPage() {
      const showShoppingError = (msg) => {
        const backdrop = document.getElementById('shopping-error-modal-backdrop');
        const body = document.getElementById('shopping-error-body');
        if (backdrop && body) {
          body.textContent = String(msg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          backdrop.classList.remove('hidden');
        } else { alert(msg); }
      };
      document.getElementById('shopping-error-ok')?.addEventListener('click', () => {
        document.getElementById('shopping-error-modal-backdrop')?.classList.add('hidden');
      });
      document.getElementById('shopping-error-modal-backdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'shopping-error-modal-backdrop') e.target.classList.add('hidden');
      });

      window.updateShoppingApiBanner = function() {
        const geminiKey = (apiKeyInput?.value || '').trim() || (typeof localStorage !== 'undefined' ? localStorage.getItem(STORAGE_KEY) : null) || '';
        const replicateToken = (document.getElementById('replicate-token-input')?.value || '').trim() || (typeof localStorage !== 'undefined' ? localStorage.getItem(REPLICATE_STORAGE_KEY) : null) || '';
        const hasKeys = geminiKey && geminiKey.length > 10 && replicateToken && replicateToken.length > 10;
        const banner = document.getElementById('shopping-api-banner');
        if (banner) banner.classList.toggle('hidden', !!hasKeys);
      };
      document.getElementById('shopping-open-api-btn')?.addEventListener('click', () => {
        switchView('settings');
      });

      const input = document.getElementById('shopping-image-url-input');
      const genBtn = document.getElementById('shopping-generate-btn');
      const loading = document.getElementById('shopping-loading');
      const result = document.getElementById('shopping-result');
      const dlBtn = document.getElementById('shopping-download-btn');
      const img = document.getElementById('shopping-thumb-img');
      const placeholder = document.getElementById('shopping-thumb-placeholder');
      let currentResultDataUrl = null;
      let pollTimer = null;
      const SHOPPING_API_BASE = (location.protocol === 'http:' || location.protocol === 'https:')
        ? location.origin
        : 'http://localhost:8000';

      const setThumb = (urlOrDataUrl, fallbackDataUrl) => {
        currentResultDataUrl = urlOrDataUrl || fallbackDataUrl || null;
        if (!img || !placeholder) return;
        if (currentResultDataUrl) {
          img.onerror = null;
          img.src = currentResultDataUrl;
          if (fallbackDataUrl && !currentResultDataUrl.startsWith('data:')) {
            img.onerror = () => {
              img.onerror = null;
              img.src = fallbackDataUrl;
              currentResultDataUrl = fallbackDataUrl;
            };
          }
          img.classList.remove('hidden');
          placeholder.classList.add('hidden');
        } else {
          img.removeAttribute('src');
          img.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
      };

      const stopPolling = () => {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
      };

      const STEP_LABELS = [
        [0, 20, 'ì´ë¯¸ì§€ ìˆ˜ì§‘ ì¤‘'],
        [20, 40, 'ëˆ„ë¼ ì²˜ë¦¬ ì¤‘'],
        [40, 60, 'AI ìƒí’ˆ ë¶„ì„ ì¤‘'],
        [60, 80, 'ë°°ê²½ ìƒì„± ì¤‘'],
        [80, 100, 'í•©ì„± ì¤‘'],
      ];
      const getStepLabel = (p) => {
        for (const [lo, hi, label] of STEP_LABELS) {
          if (p < hi) return label;
        }
        return 'ì™„ë£Œ ì¤‘';
      };

      const setProgress = (p) => {
        const barEl = document.getElementById('shopping-loading-bar');
        const stepEl = document.getElementById('shopping-loading-step');
        if (barEl) barEl.style.width = p + '%';
        if (stepEl) stepEl.textContent = getStepLabel(p) + ' ' + p + '%';
      };

      const pollJob = async (jobId) => {
        try {
          const res = await fetch(`${SHOPPING_API_BASE}/api/shopping/thumbnail/jobs/${jobId}`);
          if (!res.ok) return;
          const job = await res.json();
          const p = Math.min(100, Math.max(0, job.progress || 0));
          setProgress(p);
          if (job.status === 'completed') {
            stopPolling();
            setProgress(100);
            if (loading) loading.classList.add('hidden');
            if (result) result.classList.remove('hidden');
            const resultUrl = `${SHOPPING_API_BASE}/api/shopping/thumbnail/jobs/${jobId}/result?t=${Date.now()}`;
            setThumb(resultUrl, job.result_data_url);
            return;
          }
          if (job.status === 'failed') {
            stopPolling();
            if (loading) loading.classList.add('hidden');
            const errMsg = job.error || 'unknown';
            showShoppingError('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨: ' + errMsg);
          }
        } catch (_) {}
      };

      const run = async () => {
        const imageUrl = (input?.value || '').trim();
        if (!imageUrl) { showShoppingError('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        stopPolling();
        setThumb(null);
        if (result) result.classList.add('hidden');
        if (loading) loading.classList.remove('hidden');
        setProgress(0);

        const geminiKey = (apiKeyInput?.value || '').trim() || (typeof localStorage !== 'undefined' ? localStorage.getItem(STORAGE_KEY) : null) || '';
        const replicateToken = (document.getElementById('replicate-token-input')?.value || '').trim() || (typeof localStorage !== 'undefined' ? localStorage.getItem(REPLICATE_STORAGE_KEY) : null) || '';

        const hasKeys = geminiKey && geminiKey.length > 10 && replicateToken && replicateToken.length > 10;
        if (!hasKeys) {
          if (loading) loading.classList.add('hidden');
          showShoppingError('ì‹¤ì œ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ë ¤ë©´ Gemini API Keyì™€ Replicate í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\nì™¼ìª½ í•˜ë‹¨ ì„¤ì •(âš™ï¸) â†’ API ì„¤ì •ì—ì„œ ì…ë ¥ í›„ "ì €ì¥"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
          switchView('settings');
          const banner = document.getElementById('shopping-api-banner');
          if (banner) banner.classList.remove('hidden');
          return;
        }

        try {
          const res = await fetch(`${SHOPPING_API_BASE}/api/shopping/thumbnail/jobs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image_url: imageUrl,
              gemini_api_key: geminiKey || null,
              replicate_token: replicateToken || null,
            }),
          });
          if (!res.ok) throw new Error('backend_error');
          const created = await res.json();
          await pollJob(created.id);
          pollTimer = setInterval(() => pollJob(created.id), 1200);
        } catch (e) {
          if (loading) loading.classList.add('hidden');
          const extra = (location.protocol === 'file:') ? '\n\nfile:// ëŒ€ì‹  http://localhost:8000 ìœ¼ë¡œ ì—´ì–´ì£¼ì„¸ìš”.' : '';
          showShoppingError('ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨. start.bat ì‹¤í–‰ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.' + extra);
        }
      };
      genBtn?.addEventListener('click', run);
      input?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); run(); } });
      dlBtn?.addEventListener('click', () => {
        if (!currentResultDataUrl) { showShoppingError('ì•„ì§ ìƒì„±ëœ ì¸ë„¤ì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const a = document.createElement('a');
        a.href = currentResultDataUrl;
        a.download = (currentResultDataUrl.startsWith('data:image/png') || currentResultDataUrl.includes('/result')) ? 'wavaa-shopping-thumbnail.png' : 'wavaa-shopping-thumbnail.svg';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
    })();
    document.getElementById('home-view-input')?.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' || e.shiftKey) return;
      e.preventDefault();
      const text = (e.target.value || '').trim();
      if (!text) return;
      switchView('chat');
      const curr = taskListChat.find(i => i.id === 'current');
      if (curr) delete curr.id;
      aiChatHistory = [];
      const aiChatInput = document.getElementById('ai-chat-input');
      if (aiChatInput) { aiChatInput.value = text; aiChatInput.focus(); autoResizeChatInput(aiChatInput); }
      e.target.value = '';
      autoResizeChatInput(e.target);
      renderAiChatMessages();
      setTimeout(() => sendAiChatMessage(), 0);
    });
    document.getElementById('nav-chat')?.addEventListener('click', () => switchView('chat'));
    document.getElementById('ai-chat-new-btn')?.addEventListener('click', () => {
      const curr = taskListChat.find(i => i.id === 'current');
      if (curr) delete curr.id;
      aiChatHistory = [];
      renderAiChatMessages();
      renderCanvasHistory();
      const toSave = taskListChat.slice(0, MAX_HISTORY_ITEMS);
      try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(toSave)); } catch (_) {}
    });
    document.getElementById('ai-chat-new-folder-btn')?.addEventListener('click', () => {
      if (activeMenu !== 'chat') return;
      showNewFolderModal(() => {
        renderCanvasHistory();
        renderFolderItemsInChat();
      });
    });
    let folderNameModalState = { mode: 'create', folderId: null, onSuccess: null };
    function showNewFolderModal(onSuccess) {
      folderNameModalState = { mode: 'create', folderId: null, onSuccess: onSuccess || null };
      const backdrop = document.getElementById('folder-name-modal-backdrop');
      const titleEl = document.getElementById('folder-name-modal-title');
      const input = document.getElementById('folder-name-modal-input');
      const saveBtn = document.getElementById('folder-name-modal-save');
      if (!backdrop || !input) return;
      if (titleEl) titleEl.textContent = 'ìƒˆ í´ë” ë§Œë“¤ê¸°';
      if (saveBtn) saveBtn.textContent = 'ì €ì¥';
      input.value = '';
      input.placeholder = 'í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”';
      backdrop.classList.remove('hidden');
      input.focus();
    }
    function showFolderRenameModal(folderId, folderName, onSuccess) {
      folderNameModalState = { mode: 'rename', folderId, onSuccess: onSuccess || null };
      const backdrop = document.getElementById('folder-name-modal-backdrop');
      const titleEl = document.getElementById('folder-name-modal-title');
      const input = document.getElementById('folder-name-modal-input');
      const saveBtn = document.getElementById('folder-name-modal-save');
      if (!backdrop || !input) return;
      if (titleEl) titleEl.textContent = 'í´ë” ì´ë¦„ ìˆ˜ì •';
      if (saveBtn) saveBtn.textContent = 'ì €ì¥';
      input.value = folderName || '';
      input.placeholder = 'í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”';
      backdrop.classList.remove('hidden');
      input.focus();
    }
    function showTaskRenameModal(currentTitle, onSuccess) {
      folderNameModalState = { mode: 'task-rename', onSuccess: onSuccess || null };
      const backdrop = document.getElementById('folder-name-modal-backdrop');
      const titleEl = document.getElementById('folder-name-modal-title');
      const input = document.getElementById('folder-name-modal-input');
      const saveBtn = document.getElementById('folder-name-modal-save');
      if (!backdrop || !input) return;
      if (titleEl) titleEl.textContent = 'ì‘ì—… ì´ë¦„ ìˆ˜ì •';
      if (saveBtn) saveBtn.textContent = 'ì €ì¥';
      input.value = currentTitle || '';
      input.placeholder = 'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”';
      backdrop.classList.remove('hidden');
      input.focus();
    }
    function closeFolderNameModal() {
      const backdrop = document.getElementById('folder-name-modal-backdrop');
      if (backdrop) backdrop.classList.add('hidden');
      folderNameModalState = { mode: 'create', folderId: null, onSuccess: null };
    }
    function addTaskFolder() {
      showNewFolderModal();
    }
    (function initFolderNameModal() {
      const backdrop = document.getElementById('folder-name-modal-backdrop');
      const input = document.getElementById('folder-name-modal-input');
      const saveBtn = document.getElementById('folder-name-modal-save');
      function doSubmit() {
        const name = (input?.value || '').trim();
        if (!name) return;
        const { mode, folderId, onSuccess } = folderNameModalState;
        if (mode === 'create') {
          const folders = getTaskFolders();
          const id = 'f_' + Date.now();
          folders.push({ id, name: name.slice(0, 30) });
          setTaskFolders(folders);
          renderCanvasHistory();
          renderFolderItemsInChat();
          if (typeof onSuccess === 'function') onSuccess(id);
        } else if (mode === 'rename' && folderId) {
          const folders = getTaskFolders();
          const f = folders.find(x => x.id === folderId);
          if (f) { f.name = name.slice(0, 30); setTaskFolders(folders); renderCanvasHistory(); renderFolderItemsInChat(); renderFolderItemsInCanvas(); }
          if (typeof onSuccess === 'function') onSuccess();
        } else if (mode === 'task-rename') {
          if (typeof onSuccess === 'function') onSuccess(name.slice(0, 50));
        }
        closeFolderNameModal();
      }
      saveBtn?.addEventListener('click', doSubmit);
      input?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSubmit(); } });
      backdrop?.addEventListener('click', (e) => { if (e.target === backdrop) closeFolderNameModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && backdrop && !backdrop.classList.contains('hidden')) closeFolderNameModal();
      });
    })();
    document.getElementById('ai-chat-folder-close')?.addEventListener('click', () => {
      selectedFolderId = null;
      const panel = document.getElementById('ai-chat-folder-items');
      if (panel) panel.classList.add('hidden');
      renderFolderItemsInChat();
    });
    document.getElementById('folder-view-back-btn')?.addEventListener('click', () => {
      selectedFolderId = null;
      const folderView = document.getElementById('ai-chat-folder-view');
      const messagesWrap = document.getElementById('ai-chat-messages-wrap');
      if (folderView) folderView.classList.add('hidden');
      if (messagesWrap) messagesWrap.classList.remove('hidden');
      document.getElementById('ai-chat-input-area')?.classList.remove('hidden');
      renderFolderItemsInChat();
      renderFolderItemsInCanvas();
      renderCanvasHistory();
    });
    document.getElementById('canvas-folder-view-back-btn')?.addEventListener('click', () => {
      selectedFolderId = null;
      const folderView = document.getElementById('ai-canvas-folder-view');
      const canvasScrollArea = document.getElementById('canvas-scroll-area');
      if (folderView) folderView.classList.add('hidden');
      if (canvasScrollArea) canvasScrollArea.classList.remove('hidden');
      renderFolderItemsInCanvas();
      renderCanvasHistory();
    });
    document.getElementById('canvas-folder-view-new-btn')?.addEventListener('click', () => {
      selectedFolderId = null;
      const folderView = document.getElementById('ai-canvas-folder-view');
      const canvasScrollArea = document.getElementById('canvas-scroll-area');
      if (folderView) folderView.classList.add('hidden');
      if (canvasScrollArea) canvasScrollArea.classList.remove('hidden');
      const curr = canvasHistory.find(i => i.id === 'current');
      if (curr) delete curr.id;
      designRows = [];
      chatHistory = [];
      if (activeMenu === 'cardnews') designRules.cardnews = [];
      else designRules.image = [];
      canvasTitle = 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°';
      document.getElementById('canvas-title').textContent = canvasTitle;
      renderDesignChatMessages();
      previewIframe.srcdoc = '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
      saveCanvasHistory();
      renderFolderItemsInCanvas();
      renderCanvasHistory();
      document.getElementById('task-list-overlay')?.classList.add('hidden');
    });
    document.getElementById('folder-view-new-chat-btn')?.addEventListener('click', () => {
      const curr = taskListChat.find(i => i.id === 'current');
      if (curr) delete curr.id;
      aiChatHistory = [];
      const folderView = document.getElementById('ai-chat-folder-view');
      const messagesWrap = document.getElementById('ai-chat-messages-wrap');
      if (folderView) folderView.classList.add('hidden');
      if (messagesWrap) messagesWrap.classList.remove('hidden');
      document.getElementById('ai-chat-input-area')?.classList.remove('hidden');
      renderAiChatMessages();
      renderCanvasHistory();
      document.getElementById('ai-chat-input')?.focus();
    });
    document.getElementById('folder-view-input')?.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' || e.shiftKey) return;
      e.preventDefault();
      const input = e.target;
      const text = (input.value || '').trim();
      if (!text && aiChatAttachments.length === 0) return;
      const folderView = document.getElementById('ai-chat-folder-view');
      const messagesWrap = document.getElementById('ai-chat-messages-wrap');
      if (folderView) folderView.classList.add('hidden');
      if (messagesWrap) messagesWrap.classList.remove('hidden');
      document.getElementById('ai-chat-input-area')?.classList.remove('hidden');
      const curr = taskListChat.find(i => i.id === 'current');
      if (curr) delete curr.id;
      aiChatHistory = [];
      input.value = '';
      autoResizeChatInput(input);
      const aiChatInput = document.getElementById('ai-chat-input');
      if (aiChatInput) { aiChatInput.value = text; aiChatInput.focus(); autoResizeChatInput(aiChatInput); }
      renderAiChatMessages();
      setTimeout(() => sendAiChatMessage(), 0);
    });
    (function initFolderViewDropZone() {
      const fvDropZone = document.getElementById('folder-view-drop-zone');
      const fvFileInput = document.getElementById('folder-view-file-input');
      const fvSendBtn = document.getElementById('folder-view-send-btn');
      const fvInput = document.getElementById('folder-view-input');
      function sendFromFolderView() {
        const text = (fvInput?.value || '').trim();
        if (!text && aiChatAttachments.length === 0) return;
        const folderView = document.getElementById('ai-chat-folder-view');
        const messagesWrap = document.getElementById('ai-chat-messages-wrap');
        if (folderView) folderView.classList.add('hidden');
        if (messagesWrap) messagesWrap.classList.remove('hidden');
        document.getElementById('ai-chat-input-area')?.classList.remove('hidden');
        const curr = taskListChat.find(i => i.id === 'current');
        if (curr) delete curr.id;
        aiChatHistory = [];
        if (fvInput) { fvInput.value = ''; autoResizeChatInput(fvInput); }
        const aiChatInput = document.getElementById('ai-chat-input');
        if (aiChatInput) { aiChatInput.value = text; aiChatInput.focus(); autoResizeChatInput(aiChatInput); }
        renderAiChatMessages();
        setTimeout(() => sendAiChatMessage(), 0);
      }
      fvDropZone?.addEventListener('click', (e) => {
        if (e.target.closest('.ai-chat-attach-remove') || e.target.closest('#folder-view-send-btn')) return;
        if (e.target.closest('textarea')) return;
        fvFileInput?.click();
      });
      fvFileInput?.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files?.length) await addFilesToAiChatAttachments(files);
        e.target.value = '';
      });
      fvDropZone?.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); fvDropZone.classList.add('drag-over'); });
      fvDropZone?.addEventListener('dragleave', (e) => { e.preventDefault(); if (!fvDropZone.contains(e.relatedTarget)) fvDropZone.classList.remove('drag-over'); });
      fvDropZone?.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        fvDropZone.classList.remove('drag-over');
        const files = e.dataTransfer?.files;
        if (files?.length) await addFilesToAiChatAttachments(files);
      });
      fvInput?.addEventListener('paste', async (e) => {
        const dt = e.clipboardData;
        if (!dt) return;
        const files = dt.files?.length ? Array.from(dt.files) : [];
        if (!files.length) { for (const item of dt.items || []) { if (item.kind === 'file') { const f = item.getAsFile(); if (f) files.push(f); } } }
        const allowed = files.filter(f => f.type?.startsWith('image/') || f.name?.toLowerCase().endsWith('.txt'));
        if (allowed.length) { e.preventDefault(); await addFilesToAiChatAttachments(allowed); }
      });
      fvSendBtn?.addEventListener('click', (e) => { e.stopPropagation(); sendFromFolderView(); });
    })();
    document.getElementById('nav-image')?.addEventListener('click', () => switchView('image'));
    document.getElementById('nav-cardnews')?.addEventListener('click', () => switchView('cardnews'));
    document.getElementById('nav-video')?.addEventListener('click', () => switchView('video'));
    document.getElementById('nav-shopping')?.addEventListener('click', () => switchView('shopping'));
    document.getElementById('nav-sns-flow')?.addEventListener('click', () => switchView('sns-flow'));

    function setVideoModeUi(isVideo) {
      // ì´ë¯¸ì§€/HTML í¸ì§‘/ì¡°ì‘ ê´€ë ¨ UI ìˆ¨ê¹€
      ['tool-undo', 'tool-redo', 'tool-zoom-in', 'tool-zoom-out'].forEach(id => {
        document.getElementById(id)?.classList.toggle('hidden', !!isVideo);
      });
      document.getElementById('design-edit-panel')?.classList.toggle('hidden', !!isVideo);
      const loadingBarEl = document.getElementById('loading-status-bar');
      if (loadingBarEl) { if (isVideo) loadingBarEl.classList.add('hidden'); }
      document.getElementById('attachment-preview')?.classList.toggle('hidden', !!isVideo);
      const dz = document.getElementById('attachment-drop-zone');
      if (dz) {
        dz.classList.toggle('cursor-pointer', !isVideo);
        dz.classList.toggle('cursor-not-allowed', !!isVideo);
      }
      if (isVideo) {
        try { clearAttachments(); } catch (_) {}
      }
    }

    function generateVideoPrompt(userInput) {
      const baseStyle = 'Cinematic 4K(Upscaled), 1080p, natural lighting';
      const safeArea = 'Keep main subject in center safe zone';
      const raw = (userInput.prompt || userInput.product || '').trim();
      return `${raw}, ${baseStyle}, ${safeArea}`;
    }

    // Auto-detect backend base URL to avoid host mismatch.
    // - If served via http(s), use same origin (ë°°í¬ ì‹œ ë™ì¼ ë„ë©”ì¸)
    // - If opened as file://, fall back to localhost:8000
    const VIDEO_API_BASE = (location.protocol === 'http:' || location.protocol === 'https:')
      ? location.origin
      : 'http://localhost:8000';
    let currentVideoJobId = null;
    let videoPollTimer = null;
    // videoRefs/videoOptions UIëŠ” ì œê±°ë¨ (ì±„íŒ…ìœ¼ë¡œ ìš”ì²­)
    async function createVideoJob(finalPrompt) {
      const rules = Array.isArray(getDesignRulesForMode()) ? getDesignRulesForMode() : [];
      let res;
      try {
        // quick health check with short timeout (helps produce better error hints)
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 1200);
        try { await fetch(`${VIDEO_API_BASE}/health`, { signal: ctrl.signal }); } catch (_) {}
        clearTimeout(t);
        res = await fetch(`${VIDEO_API_BASE}/api/video/jobs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: finalPrompt,
            model_version: 'veo-3.1',
            resolution: '1080p',
            has_model: null,
            model_gender: null,
            model_age: null,
            rules,
            product_ref_base64: null,
            product_ref_mime: null,
            background_ref_base64: null,
            background_ref_mime: null
          })
        });
      } catch (e) {
        // Typical browser error when backend is down or CORS blocks the request.
        const extra = (location.protocol === 'file:')
          ? '\n- í”„ë¡ íŠ¸ë¥¼ file://ë¡œ ì—´ë©´ ì°¨ë‹¨ë  ìˆ˜ ìˆì–´ìš”. (python -m http.server ë“±ìœ¼ë¡œ ì—´ì–´ì£¼ì„¸ìš”)'
          : '';
        throw new Error('Failed to fetch (ë°±ì—”ë“œ ì‹¤í–‰/í¬íŠ¸/CORS í™•ì¸ í•„ìš”)' + extra + `\n- ì‹œë„í•œ ì£¼ì†Œ: ${VIDEO_API_BASE}`);
      }
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.detail || 'ì˜ìƒ Job ìƒì„± ì‹¤íŒ¨');
      return data;
    }
    function setVideoPreviewHtml(innerHtml) {
      if (!previewIframe) return;
      const safe = String(innerHtml || '');
      previewIframe.srcdoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>
        html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#e5e7eb;}
        .wrap{min-height:300px;height:100%;display:flex;align-items:center;justify-content:center;}
        .card{max-width:720px;padding:18px 16px;font-family:Pretendard,system-ui,sans-serif;color:#334155;}
      </style></head><body><div class="wrap"><div class="card">${safe}</div></div></body></html>`;
      setTimeout(resizeIframeToContent, 0);
    }
    async function pollVideoJob(jobId) {
      if (!jobId) return;
      try {
        const res = await fetch(`${VIDEO_API_BASE}/api/video/jobs/${jobId}`);
        const job = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(job?.detail || 'ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨');
        const statusKo = job.status === 'pending' ? 'ëŒ€ê¸° ì¤‘' : job.status === 'processing' ? 'ìƒì„± ì¤‘' : job.status === 'completed' ? 'ì™„ë£Œ' : 'ì‹¤íŒ¨';
        const pct = typeof job.progress === 'number' ? job.progress : 0;
        if (job.status === 'completed') {
          setVideoPreviewHtml(`<div style="font-weight:700;font-size:14px;margin-bottom:8px;">ì˜ìƒ ìƒì„± ì™„ë£Œ</div>
            <div style="font-size:13px;line-height:1.6;color:#475569;white-space:pre-wrap;">${escapeHtml(job.result_text || 'ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')}</div>`);
          stopVideoPolling();
        } else if (job.status === 'failed') {
          setVideoPreviewHtml(`<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#b91c1c;">ì˜ìƒ ìƒì„± ì‹¤íŒ¨</div>
            <div style="font-size:13px;line-height:1.6;color:#7f1d1d;white-space:pre-wrap;">${escapeHtml(job.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')}</div>`);
          stopVideoPolling();
        } else {
          setVideoPreviewHtml(`<div style="font-weight:700;font-size:14px;margin-bottom:8px;">ì˜ìƒ ìƒì„± ${statusKo}</div>
            <div style="font-size:13px;color:#475569;margin-bottom:10px;">ì§„í–‰ë¥ : ${pct}%</div>
            <div style="height:10px;background:#cbd5e1;border-radius:999px;overflow:hidden;">
              <div style="height:10px;width:${Math.max(0, Math.min(100, pct))}%;background:#10b981;"></div>
            </div>`);
        }
      } catch (e) {
        setVideoPreviewHtml(`<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#b45309;">ë°±ì—”ë“œ ì—°ê²° í•„ìš”</div>
          <div style="font-size:13px;line-height:1.6;color:#78350f;white-space:pre-wrap;">${escapeHtml(e?.message || e)}</div>
          <div style="font-size:12px;color:#64748b;margin-top:10px;">ë¨¼ì € ë°±ì—”ë“œë¥¼ ì‹¤í–‰í•´ ì£¼ì„¸ìš”: <code>uvicorn backend.main:app --reload --port 8000</code></div>`);
      }
    }
    function startVideoPolling(jobId) {
      currentVideoJobId = jobId;
      stopVideoPolling();
      if (!jobId) return;
      // ì¦‰ì‹œ 1íšŒ + ì´í›„ 5ì´ˆë§ˆë‹¤ Polling
      pollVideoJob(jobId);
      videoPollTimer = setInterval(() => pollVideoJob(jobId), 5000);
    }
    function stopVideoPolling() {
      if (videoPollTimer) clearInterval(videoPollTimer);
      videoPollTimer = null;
    }

    let aiChatMode = 'thought';
    const AI_CHAT_MODE_LABELS = { fast: 'ë¹ ë¥¸ ëª¨ë“œ', thought: 'ì‚¬ê³  ëª¨ë“œ', pro: 'Pro' };
    const aiChatModeTrigger = document.getElementById('ai-chat-mode-trigger');
    const aiChatModeDropdown = document.getElementById('ai-chat-mode-dropdown');
    const aiChatModeLabel = document.getElementById('ai-chat-mode-label');
    aiChatModeTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      aiChatModeDropdown?.classList.toggle('hidden');
    });
    document.addEventListener('click', () => aiChatModeDropdown?.classList.add('hidden'));
    aiChatModeDropdown?.addEventListener('click', (e) => e.stopPropagation());
    document.querySelectorAll('.ai-chat-mode-select-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-mode');
        if (!mode) return;
        aiChatMode = mode;
        aiChatModeLabel.textContent = AI_CHAT_MODE_LABELS[mode] || mode;
        document.querySelectorAll('.ai-chat-mode-select-option .option-check').forEach(el => el.classList.add('hidden'));
        const check = document.querySelector(`.option-check[data-check="${mode}"]`);
        if (check) check.classList.remove('hidden');
        aiChatModeDropdown?.classList.add('hidden');
      });
    });

    const aiChatInput = document.getElementById('ai-chat-input');
    const aiChatMessages = document.getElementById('ai-chat-messages');
    const aiChatSendBtn = document.getElementById('ai-chat-send-btn');
    let aiChatHistory = [];
    let aiChatAttachments = [];
    const AI_CHAT_MODEL_MAP = { fast: 'gemini-2.5-flash', thought: 'gemini-2.5-pro', pro: 'gemini-2.5-pro' };
    const AI_CHAT_CONFIG = { fast: { temperature: 0.8, maxOutputTokens: 1024 }, thought: { temperature: 0.5, maxOutputTokens: 4096 }, pro: { temperature: 0.3, maxOutputTokens: 8192 } };
    function escapeChatHtml(str) {
      return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    }
    function renderAiChatMessages() {
      if (!aiChatMessages) return;
      aiChatMessages.innerHTML = aiChatHistory.map(({ role, content }, idx) => {
        const isUser = role === 'user';
        if (isUser) {
          return `<div class="flex justify-end"><div class="max-w-[85%] px-4 py-3 rounded-2xl chat-bubble-user">${escapeChatHtml(content)}</div></div>`;
        }
        return `<div class="flex justify-start"><div class="max-w-[85%] flex flex-col gap-1.5">
          <div class="px-4 py-3 rounded-2xl bg-white border border-gray-200 text-gray-800">${escapeChatHtml(content)}</div>
          <button type="button" class="ai-chat-copy-btn self-start p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" data-msg-index="${idx}" title="ëŒ€ë‹µ ë³µì‚¬"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button>
        </div></div>`;
      }).join('') || '<p class="text-center text-gray-500 text-sm">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  ì „ì†¡í•´ ë³´ì„¸ìš”.</p>';
      aiChatMessages.querySelectorAll('.ai-chat-copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-msg-index'), 10);
          const msg = aiChatHistory[idx];
          if (msg?.content) {
            navigator.clipboard.writeText(msg.content).then(() => { btn.title = 'ë³µì‚¬ë¨'; setTimeout(() => { btn.title = 'ëŒ€ë‹µ ë³µì‚¬'; }, 1500); }).catch(() => {});
          }
        });
      });
      const scrollParent = aiChatMessages?.parentElement;
      if (scrollParent) scrollParent.scrollTop = scrollParent.scrollHeight;
    }
    function addAiChatLoadingBubble() {
      if (!aiChatMessages) return null;
      const div = document.createElement('div');
      div.className = 'flex justify-start';
      div.dataset.aiChatLoading = '1';
      div.innerHTML = '<div class="max-w-[85%] px-4 py-3 rounded-2xl bg-white border border-gray-200 text-gray-600 text-sm flex items-center gap-2"><span class="inline-block w-2 h-2 rounded-full bg-[#2C96FF] animate-pulse"></span><span class="inline-block w-2 h-2 rounded-full bg-[#2C96FF] animate-pulse" style="animation-delay:0.2s"></span><span class="inline-block w-2 h-2 rounded-full bg-[#2C96FF] animate-pulse" style="animation-delay:0.4s"></span></div>';
      aiChatMessages.appendChild(div);
      const scrollParent = aiChatMessages?.parentElement;
      if (scrollParent) scrollParent.scrollTop = scrollParent.scrollHeight;
      return div;
    }
    function replaceAiChatLoadingBubble(el, content) {
      if (!el) return;
      el.dataset.aiChatLoading = '';
      el.className = 'flex justify-start';
      const idx = aiChatHistory.length - 1;
      el.innerHTML = `<div class="max-w-[85%] flex flex-col gap-1.5">
        <div class="px-4 py-3 rounded-2xl bg-white border border-gray-200 text-gray-800">${escapeChatHtml(content)}</div>
        <button type="button" class="ai-chat-copy-btn self-start p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" data-msg-index="${idx}" title="ëŒ€ë‹µ ë³µì‚¬"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button>
      </div>`;
      el.querySelector('.ai-chat-copy-btn')?.addEventListener('click', () => {
        const msg = aiChatHistory[idx];
        if (msg?.content) {
          const copyBtn = el.querySelector('.ai-chat-copy-btn');
          navigator.clipboard.writeText(msg.content).then(() => { copyBtn.title = 'ë³µì‚¬ë¨'; setTimeout(() => { copyBtn.title = 'ëŒ€ë‹µ ë³µì‚¬'; }, 1500); }).catch(() => {});
        }
      });
      const scrollParent = aiChatMessages?.parentElement;
      if (scrollParent) scrollParent.scrollTop = scrollParent.scrollHeight;
    }
    let aiChatSending = false;
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result.split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    async function sendAiChatMessage() {
      const text = (aiChatInput?.value || '').trim();
      if ((!text && aiChatAttachments.length === 0) || aiChatSending) return;
      const apiKey = apiKeyInput.value.trim() || localStorage.getItem(STORAGE_KEY);
      if (!apiKey) { alert('Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      aiChatSending = true;
      aiChatSendBtn?.setAttribute('disabled', 'true');
      aiChatInput.value = '';
      autoResizeChatInput(aiChatInput);
      const attachmentsToSend = aiChatAttachments.slice();
      clearAiChatAttachments();
      const displayText = text || (attachmentsToSend.length ? '[ì²¨ë¶€íŒŒì¼] ' + attachmentsToSend.map(a => a.name).join(', ') : '');
      aiChatHistory.push({ role: 'user', content: displayText });
      renderAiChatMessages();
      const loadingEl = addAiChatLoadingBubble();
      try {
        const model = AI_CHAT_MODEL_MAP[aiChatMode] || 'gemini-2.5-flash';
        const config = AI_CHAT_CONFIG[aiChatMode] || AI_CHAT_CONFIG.thought;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const contents = aiChatHistory.slice(0, -1).map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.content }] }));
        const userParts = [];
        const imageAttachments = attachmentsToSend.filter(a => a.file && a.type?.startsWith('image/'));
        for (const att of imageAttachments) {
          try {
            const b64 = await fileToBase64(att.file);
            userParts.push({ inlineData: { mimeType: att.type || 'image/png', data: b64 } });
          } catch (_) {}
        }
        if (text) userParts.push({ text });
        if (userParts.length === 0) userParts.push({ text: 'ì´ ì´ë¯¸ì§€ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.' });
        contents.push({ role: 'user', parts: userParts });
        let systemText = 'You are a helpful AI assistant. Respond in Korean. Be concise and clear. ë‹µë³€ ì‹œ ë§ˆí¬ë‹¤ìš´(#, *, **, -, ë“±)ì„ ì‚¬ìš©í•˜ì§€ ë§ê³  ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.';
        const chatRules = getDesignRulesForMode();
        if (Array.isArray(chatRules) && chatRules.length > 0) {
          const rulesBlock = chatRules.map(r => `- ${r}`).join('\n');
          systemText += `\n\n[ë‹¤ìŒ ê·œì¹™ì„ ë°˜ë“œì‹œ ë”°ë¥´ì„¸ìš”]\n${rulesBlock}`;
        }
        const systemInstruction = { parts: [{ text: systemText }] };
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction, generationConfig: { temperature: config.temperature, maxOutputTokens: config.maxOutputTokens } }) });
        const data = await res.json();
        if (!res.ok) throw new Error(parseGeminiError(data, 'API ìš”ì²­ ì‹¤íŒ¨'));
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        aiChatHistory.push({ role: 'model', content: reply });
        if (aiChatHistory.length > 40) aiChatHistory = aiChatHistory.slice(-40);
        replaceAiChatLoadingBubble(loadingEl, reply);
        saveChatTaskList();
        const isFirstUserMsg = aiChatHistory.filter(m => m.role === 'user').length === 1;
        if (isFirstUserMsg && displayText && displayText.length > 5) {
          summarizeAsTitle(displayText, apiKey).then(title => {
            if (title) {
              const curr = taskListChat.find(i => i.id === 'current');
              if (curr) { curr.title = title.slice(0, 50); try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {} renderCanvasHistory(); }
            }
          });
        }
      } catch (e) {
        const errMsg = 'ì˜¤ë¥˜: ' + (e?.message || e);
        aiChatHistory.push({ role: 'model', content: errMsg });
        replaceAiChatLoadingBubble(loadingEl, errMsg);
        saveChatTaskList();
        const isFirstUserMsg = aiChatHistory.filter(m => m.role === 'user').length === 1;
        if (isFirstUserMsg && displayText && displayText.length > 5) {
          summarizeAsTitle(displayText, apiKey).then(title => {
            if (title) {
              const curr = taskListChat.find(i => i.id === 'current');
              if (curr) { curr.title = title.slice(0, 50); try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {} renderCanvasHistory(); }
            }
          });
        }
      } finally {
        aiChatSending = false;
        aiChatSendBtn?.removeAttribute('disabled');
      }
    }
    aiChatSendBtn?.addEventListener('click', sendAiChatMessage);
    aiChatInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAiChatMessage(); }
    });

    function renderAiChatAttachments() {
      const folderView = document.getElementById('ai-chat-folder-view');
      const isFolderView = folderView && !folderView.classList.contains('hidden');
      const el = isFolderView ? document.getElementById('folder-view-attachment-preview') : document.getElementById('ai-chat-attachment-preview');
      if (!el) return;
      const imgs = aiChatAttachments.filter(a => a.type?.startsWith('image/'));
      if (!imgs.length) {
        el.classList.add('hidden');
        el.innerHTML = '';
        return;
      }
      el.innerHTML = imgs.map((item, idx) => `
        <div class="relative inline-block">
          <img src="${item.previewUrl}" alt="" class="max-h-20 rounded object-contain" style="max-width: 120px;">
          <button type="button" class="ai-chat-attach-remove absolute -top-1 -right-1 w-5 h-5 rounded-full bg-gray-600 text-white text-xs leading-none flex items-center justify-center hover:bg-gray-800" data-idx="${idx}">Ã—</button>
        </div>
      `).join('');
      el.classList.remove('hidden');
      el.querySelectorAll('.ai-chat-attach-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          const item = aiChatAttachments[idx];
          if (item?.previewUrl) URL.revokeObjectURL(item.previewUrl);
          aiChatAttachments.splice(idx, 1);
          renderAiChatAttachments();
        });
      });
    }
    async function addFilesToAiChatAttachments(files) {
      const list = Array.isArray(files) ? files : Array.from(files || []);
      const allowed = list.filter(f => f.type?.startsWith('image/') || (f.name && f.name.toLowerCase().endsWith('.txt')));
      for (const file of allowed) {
        const item = { name: file.name || 'pasted', type: file.type || 'image/png', size: file.size || 0, previewUrl: '', file };
        if (file.type?.startsWith('image/')) item.previewUrl = URL.createObjectURL(file);
        else if (file.name?.toLowerCase().endsWith('.txt')) { try { item.textSnippet = (await file.text()).slice(0, 200); } catch (_) {} }
        aiChatAttachments.push(item);
      }
      if (allowed.length) renderAiChatAttachments();
    }
    function clearAiChatAttachments() {
      aiChatAttachments.forEach(a => { if (a.previewUrl) URL.revokeObjectURL(a.previewUrl); });
      aiChatAttachments = [];
      renderAiChatAttachments();
    }

    const aiChatDropZone = document.getElementById('ai-chat-drop-zone');
    aiChatDropZone?.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); aiChatDropZone.classList.add('drag-over'); });
    aiChatDropZone?.addEventListener('dragleave', (e) => { e.preventDefault(); if (!aiChatDropZone.contains(e.relatedTarget)) aiChatDropZone.classList.remove('drag-over'); });
    aiChatDropZone?.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      aiChatDropZone.classList.remove('drag-over');
      const files = e.dataTransfer?.files;
      if (files?.length) await addFilesToAiChatAttachments(files);
    });
    aiChatInput?.addEventListener('paste', async (e) => {
      const dt = e.clipboardData;
      if (!dt) return;
      const files = dt.files?.length ? Array.from(dt.files) : [];
      if (!files.length) { for (const item of dt.items || []) { if (item.kind === 'file') { const f = item.getAsFile(); if (f) files.push(f); } } }
      const allowed = files.filter(f => f.type?.startsWith('image/') || f.name?.toLowerCase().endsWith('.txt'));
      if (allowed.length) { e.preventDefault(); await addFilesToAiChatAttachments(allowed); }
    });

    const dropZone = document.getElementById('attachment-drop-zone');
    dropZone?.addEventListener('click', (e) => {
      if (activeMenu === 'video') return;
      if (e.target.closest('.attachment-remove-one')) return;
      if (e.target.closest('textarea')) return;
      attachmentInput?.click();
    });
    attachmentInput?.addEventListener('change', async (e) => {
      if (activeMenu === 'video') { e.target.value = ''; return; }
      await addFilesToAttachments(e.target.files);
      e.target.value = '';
    });
    dropZone?.addEventListener('dragover', (e) => {
      if (activeMenu === 'video') return;
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-over');
    });
    dropZone?.addEventListener('dragleave', (e) => {
      if (activeMenu === 'video') return;
      e.preventDefault();
      if (!dropZone.contains(e.relatedTarget)) dropZone.classList.remove('drag-over');
    });
    dropZone?.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');
      if (activeMenu === 'video') return;
      const files = e.dataTransfer?.files;
      if (files?.length) await addFilesToAttachments(files);
    });
    promptInput?.addEventListener('paste', async (e) => {
      if (activeMenu === 'video') return;
      const dt = e.clipboardData;
      if (!dt) return;
      const files = dt.files?.length ? Array.from(dt.files) : [];
      if (!files.length) {
        for (const item of dt.items || []) {
          if (item.kind === 'file') { const f = item.getAsFile(); if (f) files.push(f); }
        }
      }
      const images = files.filter(f => f.type?.startsWith('image/'));
      if (images.length) { e.preventDefault(); await addFilesToAttachments(images); }
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    function renderAttachmentPreview(items) {
      if (!items || items.length === 0) return '';
      return `<div class="mt-2 flex flex-wrap gap-2">${items.map(item => {
        if (item.type.startsWith('image/') && item.previewUrl) {
          return `<div class="border border-gray-200 rounded-md p-1 bg-white"><img src="${item.previewUrl}" alt="${escapeHtml(item.name)}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;"></div>`;
        }
        const snippet = item.textSnippet ? escapeHtml(item.textSnippet) : '';
        return `<div class="border border-gray-200 rounded-md px-2 py-1 bg-white text-xs text-gray-600 max-w-[200px]">
          <div class="font-medium truncate">${escapeHtml(item.name)}</div>
          ${snippet ? `<div class="mt-1 text-[11px] text-gray-500 line-clamp-2">${snippet}</div>` : ''}
        </div>`;
      }).join('')}</div>`;
    }
    function addMessage(content, isUser = false, attachments = []) {
      const div = document.createElement('div');
      div.className = (isUser ? 'flex justify-end' : 'text-left') + ' mb-1';
      const bubble = document.createElement('div');
      bubble.className = 'inline-block max-w-[90%] px-4 py-2.5 rounded-xl text-left ' + (isUser ? 'chat-bubble-user text-gray-900' : 'text-gray-900 bg-gray-100');
      bubble.innerHTML = escapeHtml(content) + (attachments?.length ? renderAttachmentPreview(attachments) : '');
      div.appendChild(bubble);
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function renderDesignChatMessages() {
      if (!chatContainer) return;
      chatContainer.innerHTML = '';
      const history = Array.isArray(chatHistory) ? chatHistory : [];
      history.forEach((m) => {
        const div = document.createElement('div');
        div.className = (m.role === 'user' ? 'flex justify-end items-end gap-1' : 'text-left') + ' mb-1';
        const bubble = document.createElement('div');
        bubble.className = 'inline-block max-w-[90%] px-4 py-2.5 rounded-xl text-left ' + (m.role === 'user' ? 'chat-bubble-user text-gray-900' : 'text-gray-900 bg-gray-100');
        if (m.role === 'model') { bubble.style.whiteSpace = 'pre-wrap'; bubble.innerHTML = renderDesignChatMarkdown(m.text || ''); }
        else bubble.textContent = m.text || '';
        div.appendChild(bubble);
        if (m.role === 'user' && (activeMenu === 'cardnews' || activeMenu === 'image' || activeMenu === 'video') && (m.text || '').trim().length > 0) {
          const ruleBtn = document.createElement('button');
          ruleBtn.type = 'button';
          ruleBtn.className = 'shrink-0 p-1.5 text-amber-600 hover:text-amber-800 hover:bg-amber-100 rounded-lg transition-colors opacity-70 hover:opacity-100';
          ruleBtn.title = 'ì´ ë©”ì‹œì§€ë¥¼ ê·œì¹™ìœ¼ë¡œ ì €ì¥';
          ruleBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
          ruleBtn.addEventListener('click', () => { addDesignRule(m.text); });
          div.appendChild(ruleBtn);
        }
        div.dataset.role = m.role;
        chatContainer.appendChild(div);
      });
      const models = chatContainer.querySelectorAll('[data-role="model"]');
      const lastModel = models.length > 0 ? models[models.length - 1] : null;
      if (lastModel) chatContainer.scrollTop = Math.max(0, lastModel.offsetTop - 8);
      else chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'text-gray-700 text-sm text-left px-4 py-2.5 rounded-xl bg-gray-50 inline-block max-w-[90%] mb-1';
      div.textContent = text;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = Math.max(0, div.offsetTop - 8);
    }
    function addLoadingChatMessage(text) {
      const div = document.createElement('div');
      div.className = 'text-left mb-1';
      div.dataset.loadingMsg = '1';
      div.innerHTML = `<div class="inline-block max-w-[90%] px-4 py-2.5 rounded-xl bg-blue-50 text-blue-700 text-sm">${escapeHtml(text)}</div>`;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = Math.max(0, div.offsetTop - 8);
      return div;
    }
    function updateLoadingChatMessage(el, text) {
      if (!el) return;
      const escaped = escapeHtml(text || '').replace(/\n/g, '<br>');
      el.innerHTML = `<div class="inline-block max-w-[90%] px-4 py-2.5 rounded-xl bg-gray-100 text-gray-800 text-sm">${escaped}</div>`;
      el.dataset.loadingMsg = '';
      chatContainer.scrollTop = Math.max(0, el.offsetTop - 8);
    }
    function extractHtmlFromResponse(text) {
      const m = text.match(/```(?:html)?\s*([\s\S]*?)```/);
      return m ? m[1].trim() : (text.includes('<') ? text : null);
    }
    function extractMultipleHtmlFromResponse(text) {
      const regex = /```(?:html)?\s*([\s\S]*?)```/g;
      const results = [];
      let m;
      while ((m = regex.exec(text)) !== null) results.push(m[1].trim());
      if (results.length > 0) return results;
      if (text.includes('<')) return [text.trim()];
      return [];
    }
    function parseSelectedIndex(text) {
      const m = text.match(/(?:ì²«\s*ë²ˆì§¸|1\s*ë²ˆ|1ë²ˆì§¸|ì™¼ìª½\s*ê²ƒ|ì²«\s*ë²ˆ)/i);
      if (m) return 0;
      const m2 = text.match(/(?:ë‘\s*ë²ˆì§¸|2\s*ë²ˆ|2ë²ˆì§¸|ê°€ìš´ë°\s*ê²ƒ|ë‘\s*ë²ˆ)/i);
      if (m2) return 1;
      const m3 = text.match(/(?:ì„¸\s*ë²ˆì§¸|3\s*ë²ˆ|3ë²ˆì§¸|ì˜¤ë¥¸ìª½\s*ê²ƒ|ì„¸\s*ë²ˆ)/i);
      if (m3) return 2;
      const m4 = text.match(/(?:ë„¤\s*ë²ˆì§¸|4\s*ë²ˆ|4ë²ˆì§¸)/i);
      if (m4) return 3;
      return 0;
    }
    function parseCardnewsSlideIndex(text) {
      const num = text.match(/(\d+)\s*ë²ˆì§¸|\s*(\d+)\s*ë²ˆ\s*(?:ìŠ¬ë¼ì´ë“œ|ì´ë¯¸ì§€|ì¥)/i);
      if (num) return Math.max(0, Math.min(6, parseInt(num[1] || num[2], 10) - 1));
      if (/(?:ì²«|1)\s*ë²ˆì§¸|1\s*ë²ˆ/i.test(text)) return 0;
      if (/(?:ë‘|2)\s*ë²ˆì§¸|2\s*ë²ˆ/i.test(text)) return 1;
      if (/(?:ì„¸|3)\s*ë²ˆì§¸|3\s*ë²ˆ/i.test(text)) return 2;
      if (/(?:ë„¤|4)\s*ë²ˆì§¸|4\s*ë²ˆ/i.test(text)) return 3;
      if (/(?:ë‹¤ì„¯|5)\s*ë²ˆì§¸|5\s*ë²ˆ/i.test(text)) return 4;
      if (/(?:ì—¬ì„¯|6)\s*ë²ˆì§¸|6\s*ë²ˆ/i.test(text)) return 5;
      if (/(?:ì¼ê³±|7)\s*ë²ˆì§¸|7\s*ë²ˆ/i.test(text)) return 6;
      return 0;
    }
    function isCardnewsImageRegenRequest(text) {
      return /ì¬ìƒì„±|ë‹¤ì‹œ\s*ë§Œë“¤|ë‹¤ë¥¸\s*ì´ë¯¸ì§€|ì´ë¯¸ì§€\s*ë°”ê¿”|ì´ë¯¸ì§€\s*ë³€ê²½|ì´ë¯¸ì§€\s*ìˆ˜ì •|ë°°ê²½\s*ë°”ê¿”|ë°°ê²½\s*ë³€ê²½|ë‹¤ì‹œ\s*ìƒì„±|ìƒˆë¡œ\s*ìƒì„±|ë‹¤ì‹œ\s*í•´ì¤˜|ë°”ê¿”ì¤˜|ë³€ê²½í•´ì¤˜/i.test(text) ||
        (isModificationRequest(text) && /ë²ˆì§¸|ìŠ¬ë¼ì´ë“œ|ì´ë¯¸ì§€|ì¥/i.test(text));
    }

    function summarizePromptLines(text) {
      return text.split(/\n+/).map(line => line.trim()).filter(Boolean);
    }
    async function summarizeAsTitle(text, apiKey) {
      if (!text || text.length < 3 || !apiKey) return (text || '').slice(0, 40);
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const body = {
          contents: [{ role: 'user', parts: [{ text: `ë‹¤ìŒ ì‚¬ìš©ì ìš”ì²­ì„ ì‘ì—… ì œëª©ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆë„ë¡ 20ì ì´ë‚´ë¡œ ì§§ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”. ìš”ì•½ë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”.\n\n[ìš”ì²­]\n${text.slice(0, 500)}` }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 64 }
        };
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) return (text || '').slice(0, 40);
        const t = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        return (t || text).slice(0, 40);
      } catch (_) {
        return (text || '').slice(0, 40);
      }
    }

    function renderDesignChatMarkdown(text) {
      if (!text) return '';
      let s = escapeHtml(text);
      s = s.replace(/^### (.+)$/gm, '$1');
      s = s.replace(/^## (.+)$/gm, '$1');
      s = s.replace(/^# (.+)$/gm, '$1');
      s = s.replace(/\*\*(.+?)\*\*/g, '$1');
      s = s.replace(/\n/g, '<br>');
      return s;
    }
    async function addGeminiConversationalResponse(prompt, apiKey, options = {}) {
      const { isDesignRequest: isDesign, askConfirmation = false } = options;
      const div = document.createElement('div');
      div.className = 'text-left mb-1';
      div.dataset.summaryMsg = '1';
      div.innerHTML = `<div class="inline-block max-w-[90%] px-4 py-3 rounded-xl bg-gray-100 text-gray-800 text-sm">
        <div class="text-gray-500">ì‘ë‹µ ì¤‘...</div>
      </div>`;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (!apiKey || prompt.length < 3) {
        const fallback = askConfirmation ? 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?' : 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.';
        div.querySelector('.text-gray-500').textContent = fallback;
        div.dataset.summaryMsg = '';
        if (askConfirmation) chatHistory.push({ role: 'model', text: fallback });
        if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory();
        return;
      }
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        let sysPrompt;
        if (activeMenu === 'video' && askConfirmation) {
          sysPrompt = `ë‹¹ì‹ ì€ ìˆí¼Â·ê´‘ê³  ì˜ìƒ ê¸°íš ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ **ê·¸ëŒ€ë¡œ ë³µì‚¬Â·ìš”ì•½í•˜ì§€ ë§ê³ **, ë‹¹ì‹ ì´ ì˜ìƒ ê´€ì ì—ì„œ í•´ì„í•˜ê³  ë³´ì™„í•œ ë‚´ìš©ìœ¼ë¡œ ë‹µí•˜ì„¸ìš”.

ê·œì¹™:
- ì‚¬ìš©ìê°€ ë§í•œ ë‚´ìš©ì„ "~í•´ì£¼ì„¸ìš”ë¼ê³  í•˜ì…¨ìŠµë‹ˆë‹¤" ì‹ìœ¼ë¡œ ë°˜ë³µí•˜ì§€ ë§ ê²ƒ.
- ì‚¬ìš©ì ì˜ë„ë¥¼ íŒŒì•…í•œ ë’¤, **ë‹¹ì‹ ì´ ì œì•ˆí•˜ëŠ”** ì˜ìƒ êµ¬ì„±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•  ê²ƒ. (ì˜ˆ: ì´ ê¸¸ì´, ì¥ë©´ ìˆ˜, ì»·ë³„ ë‚´ìš©, ë¶„ìœ„ê¸°Â·BGMÂ·ìë§‰ í¬ì¸íŠ¸ ë“±)
- ##, ### ë¡œ ì„¹ì…˜ì„ ë‚˜ëˆ„ê³ , ë§ˆí¬ë‹¤ìš´(**êµµê²Œ** ë“±)ì„ ì‚¬ìš©í•´ ì½ê¸° ì‰½ê²Œ ì‘ì„±í•  ê²ƒ.
- ì „ë¬¸ê°€ë¡œì„œ "ì´ë ‡ê²Œ ë§Œë“¤ë©´ ì¢‹ê² ë‹¤"ëŠ” ì‹ì˜ **ë‹¹ì‹ ì˜ êµ¬ì²´ì•ˆ**ì„ 2~4ë¬¸ë‹¨ ì •ë„ë¡œ ì œì‹œí•œ ë’¤, ë§ˆì§€ë§‰ì—ë§Œ "ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?"ë¡œ ëë‚¼ ê²ƒ.`;
        } else if (askConfirmation) {
          sysPrompt = `ë‹¹ì‹ ì€ ê´‘ê³ Â·ì¹´ë“œë‰´ìŠ¤ ë””ìì¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ **ê·¸ëŒ€ë¡œ ë³µì‚¬Â·ìš”ì•½í•˜ì§€ ë§ê³ **, ë‹¹ì‹ ì´ ë””ìì¸ ê´€ì ì—ì„œ í•´ì„í•˜ê³  ë³´ì™„í•œ ë‚´ìš©ìœ¼ë¡œ ë‹µí•˜ì„¸ìš”.

ê·œì¹™:
- ì‚¬ìš©ìê°€ ë§í•œ ë‚´ìš©ì„ "~í•´ì£¼ì„¸ìš”ë¼ê³  í•˜ì…¨ìŠµë‹ˆë‹¤" ì‹ìœ¼ë¡œ ë°˜ë³µí•˜ì§€ ë§ ê²ƒ.
- ì‚¬ìš©ì ì˜ë„ë¥¼ íŒŒì•…í•œ ë’¤, **ë‹¹ì‹ ì´ ì œì•ˆí•˜ëŠ”** ì»¨ì…‰Â·í†¤Â·ìƒ‰ê°Â·ë ˆì´ì•„ì›ƒÂ·íƒ€ì´í¬Â·ì¹´ë“œë³„ êµ¬ì„± ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•  ê²ƒ.
- ##, ### ë¡œ ì„¹ì…˜ì„ ë‚˜ëˆ„ê³ , ë§ˆí¬ë‹¤ìš´(**êµµê²Œ** ë“±)ì„ ì‚¬ìš©í•´ ì½ê¸° ì‰½ê²Œ ì‘ì„±í•  ê²ƒ.
- ì „ë¬¸ê°€ë¡œì„œ "ì´ë ‡ê²Œ ë§Œë“¤ë©´ ì¢‹ê² ë‹¤"ëŠ” ì‹ì˜ **ë‹¹ì‹ ì˜ êµ¬ì²´ì•ˆ**ì„ 2~4ë¬¸ë‹¨ ì •ë„ë¡œ ì œì‹œí•œ ë’¤, ë§ˆì§€ë§‰ì—ë§Œ "ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?"ë¡œ ëë‚¼ ê²ƒ.`;
        } else {
          sysPrompt = `ë‹¹ì‹ ì€ ê´‘ê³ Â·ì¹´ë“œë‰´ìŠ¤ ë””ìì¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ ë°”íƒ•ìœ¼ë¡œ **ë‹¹ì‹ ì´ ë””ìì¸ ê´€ì ì—ì„œ í•´ì„Â·ë³´ì™„í•œ** ê°€ì´ë“œë¥¼ ì œê³µí•˜ì„¸ìš”. ì‚¬ìš©ì ë§ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , ì»¨ì…‰Â·ì»¬ëŸ¬Â·ë ˆì´ì•„ì›ƒ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•˜ì„¸ìš”. ##, ###, **êµµê²Œ** ë“± ë§ˆí¬ë‹¤ìš´ ì‚¬ìš©.`;
        }
        const historyText = chatHistory.length > 0
          ? chatHistory.map(m => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${m.text}`).join('\n') + '\n\nì‚¬ìš©ì: ' + prompt
          : prompt;
        const body = {
          contents: [{ role: 'user', parts: [{ text: `${sysPrompt}\n\n[ëŒ€í™”]\n${historyText}` }] }],
          generationConfig: { temperature: 0.5, maxOutputTokens: 4096 }
        };
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(parseGeminiError(data, 'ìš”ì•½ ì‹¤íŒ¨'));
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        if (askConfirmation && text && !/ì´ë ‡ê²Œ\s*ìƒì„±í•´ë“œë¦´ê¹Œìš”\?/.test(text)) {
          text = text.replace(/\.\s*$/, '') + ' ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?';
        }
        const contentEl = div.querySelector('.text-gray-500');
        if (contentEl) {
          contentEl.className = 'text-gray-700 leading-relaxed text-left';
          contentEl.style.whiteSpace = 'pre-wrap';
          contentEl.innerHTML = renderDesignChatMarkdown(text || (askConfirmation ? 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?' : 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.'));
        }
        chatHistory.push({ role: 'model', text: text || (askConfirmation ? 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?' : 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.') });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
      } catch (e) {
        const fallback = askConfirmation ? 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?' : 'ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.';
        const contentEl = div.querySelector('.text-gray-500');
        if (contentEl) contentEl.textContent = fallback;
        chatHistory.push({ role: 'model', text: fallback });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
      }
      div.dataset.summaryMsg = '';
      chatContainer.scrollTop = Math.max(0, div.offsetTop - 8);
      if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory();
    }

    function renderAttachmentPreview() {
      const previewEl = document.getElementById('attachment-preview');
      if (!previewEl) return;
      const imgs = pendingAttachments.filter(a => a.type?.startsWith('image/'));
      if (!imgs.length) {
        previewEl.classList.add('hidden');
        previewEl.innerHTML = '';
        return;
      }
      previewEl.innerHTML = imgs.map((item) => {
        const idx = pendingAttachments.indexOf(item);
        return `<div class="relative inline-block">
          <img src="${item.previewUrl}" alt="${escapeHtml(item.name || '')}" class="max-h-24 rounded object-contain" style="max-width: 100%;">
          <button type="button" class="attachment-remove-one absolute -top-1 -right-1 w-5 h-5 rounded-full bg-gray-600 text-white text-xs leading-none flex items-center justify-center hover:bg-gray-800" data-idx="${idx}" title="ì œê±°">Ã—</button>
        </div>`;
      }).join('');
      previewEl.classList.remove('hidden');
      previewEl.querySelectorAll('.attachment-remove-one').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          const item = pendingAttachments[idx];
          if (item?.previewUrl) URL.revokeObjectURL(item.previewUrl);
          pendingAttachments.splice(idx, 1);
          renderAttachmentPreview();
        });
      });
    }

    async function addFilesToAttachments(files) {
      const list = Array.isArray(files) ? files : Array.from(files || []);
      const imgFiles = list.filter(f => f.type?.startsWith('image/'));
      for (const file of imgFiles) {
        const item = { name: file.name || 'pasted-image.png', type: file.type || 'image/png', size: file.size || 0, previewUrl: URL.createObjectURL(file), textSnippet: '' };
        pendingAttachments.push(item);
      }
      if (imgFiles.length) renderAttachmentPreview();
    }
    function clearAttachments() {
      pendingAttachments.forEach(item => {
        if (item.previewUrl) URL.revokeObjectURL(item.previewUrl);
      });
      pendingAttachments = [];
      if (attachmentInput) attachmentInput.value = '';
      renderAttachmentPreview();
    }

    function loadTaskList(mode) {
      const key = TASK_LIST_KEYS[mode];
      if (!key) return [];
      try {
        let raw = localStorage.getItem(key);
        if (!raw && mode === 'image') raw = localStorage.getItem(CANVAS_HISTORY_KEY);
        const list = raw ? JSON.parse(raw) : [];
        list.forEach(item => {
          if (item.pinned === undefined) item.pinned = false;
          if (item.folderId === undefined) item.folderId = null;
        });
        return list;
      } catch { return []; }
    }
    function loadTaskFolders(mode) {
      const key = TASK_FOLDERS_KEYS[mode];
      if (!key) return [];
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function loadAllTaskLists() {
      taskListChat = loadTaskList('chat');
      taskListImage = loadTaskList('image');
      taskListCardnews = loadTaskList('cardnews');
      taskListVideo = loadTaskList('video');
      taskFoldersChat = loadTaskFolders('chat');
      taskFoldersImage = loadTaskFolders('image');
      taskFoldersCardnews = loadTaskFolders('cardnews');
      taskFoldersVideo = loadTaskFolders('video');
      canvasHistory = taskListImage;
    }
    function loadCanvasHistory() {
      loadAllTaskLists();
    }
    const MAX_HISTORY_ITEMS = 5;
    const MAX_STORAGE_BYTES = 2 * 1024 * 1024;
    function saveCanvasHistory() {
      const key = getCurrentTaskListKey();
      if (activeMenu === 'chat') return;
      let curr = canvasHistory.find(i => i.id === 'current');
      if (!curr && (designRows?.length > 0 || (Array.isArray(chatHistory) && chatHistory.length > 0) || activeMenu === 'video')) {
        const ts = new Date().toLocaleString('ko-KR', { hour12: false });
        curr = { id: 'current', title: canvasTitle || (activeMenu === 'cardnews' ? 'ì¹´ë“œë‰´ìŠ¤ ë¯¸ë¦¬ë³´ê¸°' : (activeMenu === 'video' ? 'ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°' : 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°')), updatedAt: ts, designRows: [], chatHistory: [], designRules: [], pinned: false, folderId: null };
        canvasHistory.unshift(curr);
      }
      if (curr) {
        if (Array.isArray(chatHistory)) curr.chatHistory = JSON.parse(JSON.stringify(chatHistory));
        if (Array.isArray(designRows) && designRows.length > 0) curr.designRows = JSON.parse(JSON.stringify(designRows));
        curr.designRules = JSON.parse(JSON.stringify(getDesignRulesForMode()));
        if (activeMenu === 'video') {
          curr.videoJobId = currentVideoJobId || curr.videoJobId || null;
        }
      }
      if (activeMenu === 'image') taskListImage = canvasHistory;
      else if (activeMenu === 'cardnews') taskListCardnews = canvasHistory;
      else if (activeMenu === 'video') taskListVideo = canvasHistory;
      let toSave = canvasHistory.slice(0, MAX_HISTORY_ITEMS);
      let json = JSON.stringify(toSave);
      if (new Blob([json]).size > MAX_STORAGE_BYTES) {
        toSave = toSave.map((item) => {
          const copy = { ...item };
          if (item.id !== 'current' && copy.designRows?.length) copy.designRows = [];
          return copy;
        });
        json = JSON.stringify(toSave);
        if (new Blob([json]).size > MAX_STORAGE_BYTES) {
          toSave = toSave.map(item => ({ id: item.id, title: item.title, updatedAt: item.updatedAt }));
          json = JSON.stringify(toSave);
        }
      }
      try {
        localStorage.setItem(key, json);
      } catch (e) {
        if (e?.name === 'QuotaExceededError' || /quota|exceeded/i.test(e?.message || '')) {
          const fallback = toSave.map(item => ({ id: item.id, title: item.title, updatedAt: item.updatedAt }));
          try { localStorage.setItem(key, JSON.stringify(fallback)); } catch (_) {}
        }
      }
    }
    function formatHistoryDate(updatedAt) {
      if (!updatedAt) return '';
      const m = String(updatedAt).match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/) || String(updatedAt).match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
      if (m) {
        const d = new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]));
        const today = new Date();
        const diff = Math.floor((today - d) / 86400000);
        if (diff === 0) return 'ì˜¤ëŠ˜';
        if (diff === 1) return 'ì–´ì œ';
        if (diff < 7) return 'ì´ë²ˆ ì£¼';
        return m[1] + 'ë…„ ' + m[2] + 'ì›”';
      }
      return 'ê¸°íƒ€';
    }
    function getTaskFolders() {
      if (activeMenu === 'chat') return taskFoldersChat;
      if (activeMenu === 'cardnews') return taskFoldersCardnews;
      if (activeMenu === 'video') return taskFoldersVideo;
      return taskFoldersImage;
    }
    function setTaskFolders(folders) {
      if (activeMenu === 'chat') taskFoldersChat = folders;
      else if (activeMenu === 'cardnews') taskFoldersCardnews = folders;
      else if (activeMenu === 'video') taskFoldersVideo = folders;
      else taskFoldersImage = folders;
      const key = TASK_FOLDERS_KEYS[activeMenu];
      if (key) try { localStorage.setItem(key, JSON.stringify(folders)); } catch (_) {}
    }
    function saveCurrentTaskList() {
      const list = activeMenu === 'chat' ? taskListChat : (activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage));
      const key = TASK_LIST_KEYS[activeMenu];
      if (key) try { localStorage.setItem(key, JSON.stringify(list.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {}
    }
    function renderHistoryItem(item, origIdx, icon) {
      const pinIcon = item.pinned ? 'ğŸ“Œ' : '';
      return `
        <div class="history-item relative group" data-history-idx="${origIdx}" data-clickable>
          <div class="history-item-icon">${icon}</div>
          <div class="flex-1 min-w-0">
            <div class="text-sm text-gray-800 truncate font-medium">${pinIcon} ${escapeHtml(item.title)}</div>
          </div>
          <div class="history-item-menu absolute right-0 top-1/2 -translate-y-1/2">
            <button class="history-item-menu-btn" data-history-idx="${origIdx}" data-menu-trigger title="ë©”ë‰´">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </button>
          </div>
        </div>`;
    }
    function renderCanvasHistory() {
      const targetPanel = activeMenu === 'chat' ? document.getElementById('canvas-list-panel') : document.getElementById('canvas-list-panel-overlay');
      const searchInput = activeMenu === 'chat' ? document.getElementById('history-search') : document.getElementById('history-search-overlay');
      if (!targetPanel) return;
      const list = activeMenu === 'chat' ? taskListChat : (activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage));
      const folders = getTaskFolders();
      const searchVal = (searchInput?.value || '').trim().toLowerCase();
      let filtered = list;
      if (searchVal) filtered = list.filter(item => (item.title || '').toLowerCase().includes(searchVal));
      const chatIcon = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>';
      const designIcon = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>';
      const icon = activeMenu === 'chat' ? chatIcon : designIcon;
      const order = ['ì˜¤ëŠ˜', 'ì–´ì œ', 'ì´ë²ˆ ì£¼'];
      const pinned = filtered.filter(i => i.pinned);
      const inFolders = filtered.filter(i => !i.pinned && i.folderId);
      const noFolder = filtered.filter(i => !i.pinned && !i.folderId);
      const dateGroups = {};
      noFolder.forEach(item => {
        const dateKey = formatHistoryDate(item.updatedAt);
        if (!dateGroups[dateKey]) dateGroups[dateKey] = [];
        dateGroups[dateKey].push({ item, origIdx: list.indexOf(item) });
      });
      const sortedDateKeys = Object.keys(dateGroups).sort((a, b) => {
        const ai = order.indexOf(a); const bi = order.indexOf(b);
        if (ai >= 0 && bi >= 0) return ai - bi;
        if (ai >= 0) return -1; if (bi >= 0) return 1;
        return (b || '').localeCompare(a || '');
      });
      let html = '';
      if (folders.length > 0) {
        html += '<div class="history-date-group">í´ë”</div>';
        folders.forEach(f => {
          html += `<div class="task-folder-row" data-folder-id="${escapeHtml(f.id)}" title="${escapeHtml(f.name)}">
            <span class="folder-icon">ğŸ“</span>
            <span class="flex-1 truncate text-sm text-gray-800">${escapeHtml(f.name)}</span>
            <div class="task-folder-menu absolute right-0 top-1/2 -translate-y-1/2">
              <button class="history-item-menu-btn" data-folder-menu-trigger data-folder-id="${escapeHtml(f.id)}" data-folder-name="${escapeHtml(f.name)}" title="ë©”ë‰´">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
              </button>
            </div>
          </div>`;
        });
        html += '<div class="h-2"></div>';
      }
      if (!filtered.length && folders.length === 0) {
        html += '<div class="text-xs text-gray-500 px-3 py-4 text-center">' + (searchVal ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.') + '</div>';
      } else if (filtered.length) {
        if (pinned.length) {
          html += '<div class="history-date-group">ìƒë‹¨ ê³ ì •</div>';
          pinned.forEach(item => { html += renderHistoryItem(item, list.indexOf(item), icon); });
        }
        sortedDateKeys.forEach(dateKey => {
          html += '<div class="history-date-group">' + escapeHtml(dateKey) + '</div>';
          dateGroups[dateKey].forEach(({ item, origIdx }) => { html += renderHistoryItem(item, origIdx, icon); });
        });
      } else if (folders.length > 0) {
        html += '<div class="text-xs text-gray-500 px-3 py-4 text-center">' + (searchVal ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.') + '</div>';
      }
      targetPanel.innerHTML = html;
      targetPanel.querySelectorAll('[data-menu-trigger]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.getAttribute('data-history-idx'), 10);
          showHistoryItemMenu(e.target.closest('.history-item'), idx);
        });
      });
      targetPanel.querySelectorAll('.task-folder-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.closest('[data-folder-menu-trigger], .history-item-dropdown')) return;
          const fid = row.getAttribute('data-folder-id');
          if (!fid) return;
          selectedFolderId = fid;
          renderFolderItemsInChat();
          renderFolderItemsInCanvas();
        });
      });
      targetPanel.querySelectorAll('[data-folder-menu-trigger]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const fid = btn.getAttribute('data-folder-id');
          const fname = btn.getAttribute('data-folder-name') || '';
          showFolderMenu(e.target.closest('.task-folder-row'), fid, fname);
        });
      });
    }
    function renderFolderItemsInChat() {
      const messagesWrap = document.getElementById('ai-chat-messages-wrap');
      const folderView = document.getElementById('ai-chat-folder-view');
      const folderTitleEl = document.getElementById('folder-view-title');
      const folderInputEl = document.getElementById('folder-view-input');
      const folderListEl = document.getElementById('folder-view-list');
      const oldPanel = document.getElementById('ai-chat-folder-items');
      if (!folderView || !folderListEl) return;
      const inputArea = document.getElementById('ai-chat-input-area');
      if (!selectedFolderId || activeMenu !== 'chat') {
        folderView.classList.add('hidden');
        if (messagesWrap) messagesWrap.classList.remove('hidden');
        if (oldPanel) oldPanel.classList.add('hidden');
        if (inputArea) inputArea.classList.remove('hidden');
        return;
      }
      const folders = getTaskFolders();
      const folder = folders.find(f => f.id === selectedFolderId);
      if (!folder) {
        folderView.classList.add('hidden');
        if (messagesWrap) messagesWrap.classList.remove('hidden');
        if (inputArea) inputArea.classList.remove('hidden');
        return;
      }
      if (messagesWrap) messagesWrap.classList.add('hidden');
      if (inputArea) inputArea.classList.add('hidden');
      folderView.classList.remove('hidden');
      if (folderTitleEl) folderTitleEl.textContent = folder.name;
      if (folderInputEl) folderInputEl.placeholder = folder.name + 'ì—ì„œ ìƒˆ ì±„íŒ…';
      const list = taskListChat;
      const items = list.filter(i => i.folderId === selectedFolderId);
      const firstUserMsg = (item) => (item.messages || []).find(m => m.role === 'user')?.content || '';
      const formatDate = (ts) => {
        if (!ts) return '';
        const m = String(ts).match(/(\d{4})[.\-\/]?\s*(\d{1,2})[.\-\/]?\s*(\d{1,2})/);
        if (m) return parseInt(m[2], 10) + 'ì›” ' + parseInt(m[3], 10) + 'ì¼';
        return ts;
      };
      folderListEl.innerHTML = items.length ? items.map((item) => {
        const idx = list.indexOf(item);
        const sub = firstUserMsg(item);
        return `<div class="folder-view-item" data-folder-item-idx="${idx}">
          <div class="folder-view-item-main">
            <div class="folder-view-item-title">${escapeHtml(item.title || 'ìƒˆ ëŒ€í™”')}</div>
            ${sub ? `<div class="folder-view-item-sub">${escapeHtml(sub.slice(0, 80))}${sub.length > 80 ? '...' : ''}</div>` : ''}
          </div>
          <span class="folder-view-item-date">${escapeHtml(formatDate(item.updatedAt))}</span>
        </div>`;
      }).join('') : '<div class="text-sm text-gray-500 py-8 text-center">ë¹„ì–´ ìˆìŒ</div>';
      folderListEl.querySelectorAll('.folder-view-item').forEach(row => {
        row.addEventListener('click', () => {
          const idx = parseInt(row.getAttribute('data-folder-item-idx'), 10);
          const item = taskListChat[idx];
          if (!item) return;
          taskListChat.forEach(i => delete i.id);
          item.id = 'current';
          aiChatHistory = Array.isArray(item.messages) ? JSON.parse(JSON.stringify(item.messages)) : [];
          selectedFolderId = null;
          folderView.classList.add('hidden');
          if (messagesWrap) messagesWrap.classList.remove('hidden');
          document.getElementById('ai-chat-input-area')?.classList.remove('hidden');
          renderAiChatMessages();
          renderCanvasHistory();
          try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {}
        });
      });
    }
    function renderFolderItemsInCanvas() {
      const folderView = document.getElementById('ai-canvas-folder-view');
      const canvasScrollArea = document.getElementById('canvas-scroll-area');
      const folderTitleEl = document.getElementById('canvas-folder-view-title');
      const folderListEl = document.getElementById('canvas-folder-view-list');
      if (!folderView || !folderListEl || !canvasScrollArea) return;
      if (!selectedFolderId || (activeMenu !== 'image' && activeMenu !== 'cardnews' && activeMenu !== 'video')) {
        folderView.classList.add('hidden');
        canvasScrollArea.classList.remove('hidden');
        return;
      }
      const folders = getTaskFolders();
      const folder = folders.find(f => f.id === selectedFolderId);
      if (!folder) {
        folderView.classList.add('hidden');
        canvasScrollArea.classList.remove('hidden');
        return;
      }
      folderView.classList.remove('hidden');
      canvasScrollArea.classList.add('hidden');
      if (folderTitleEl) folderTitleEl.textContent = folder.name;
      const list = activeMenu === 'image' ? taskListImage : (activeMenu === 'video' ? taskListVideo : taskListCardnews);
      const items = list.filter(i => i.folderId === selectedFolderId);
      const formatDate = (ts) => {
        if (!ts) return '';
        const m = String(ts).match(/(\d{4})[.\-\/]?\s*(\d{1,2})[.\-\/]?\s*(\d{1,2})/);
        if (m) return parseInt(m[2], 10) + 'ì›” ' + parseInt(m[3], 10) + 'ì¼';
        return ts;
      };
      folderListEl.innerHTML = items.length ? items.map((item) => {
        const idx = list.indexOf(item);
        const hasDesign = Array.isArray(item.designRows) && item.designRows.length > 0;
        const sub = hasDesign ? 'ë””ìì¸ í¬í•¨' : '';
        return `<div class="folder-view-item" data-folder-item-idx="${idx}">
          <div class="folder-view-item-main">
            <div class="folder-view-item-title">${escapeHtml(item.title || 'ìƒˆ ì‘ì—…')}</div>
            ${sub ? `<div class="folder-view-item-sub">${escapeHtml(sub)}</div>` : ''}
          </div>
          <span class="folder-view-item-date">${escapeHtml(formatDate(item.updatedAt))}</span>
        </div>`;
      }).join('') : '<div class="text-sm text-gray-500 py-8 text-center">ë¹„ì–´ ìˆìŒ</div>';
      folderListEl.querySelectorAll('.folder-view-item').forEach(row => {
        row.addEventListener('click', () => {
          const idx = parseInt(row.getAttribute('data-folder-item-idx'), 10);
          const item = list[idx];
          if (!item) return;
          const prevCurrent = canvasHistory.find(i => i.id === 'current');
          if (prevCurrent && prevCurrent !== item) {
            prevCurrent.designRows = designRows.length > 0 ? JSON.parse(JSON.stringify(designRows)) : prevCurrent.designRows;
            if (Array.isArray(chatHistory)) prevCurrent.chatHistory = JSON.parse(JSON.stringify(chatHistory));
            prevCurrent.designRules = JSON.parse(JSON.stringify(getDesignRulesForMode()));
          }
          canvasHistory.forEach(i => delete i.id);
          item.id = 'current';
          canvasTitle = item.title;
          const canvasTitleEl = document.getElementById('canvas-title');
          if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
          if (activeMenu === 'video') {
            designRows = [];
            chatHistory = [];
            designRules.video = Array.isArray(item.designRules) ? [...item.designRules] : [];
            setVideoPreviewHtml('<div style="color:#9ca3af;font-size:14px;font-weight:600;">ì˜ìƒ ìƒì„± ëŒ€ê¸°</div>');
          } else {
            designRows = Array.isArray(item.designRows) && item.designRows.length > 0 ? JSON.parse(JSON.stringify(item.designRows)) : [];
            chatHistory = Array.isArray(item.chatHistory) && item.chatHistory.length > 0 ? JSON.parse(JSON.stringify(item.chatHistory)) : [];
            const rules = Array.isArray(item.designRules) ? item.designRules : [];
            if (activeMenu === 'cardnews') designRules.cardnews = [...rules];
            else designRules.image = [...rules];
            if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            else previewIframe.srcdoc = buildRowsDisplayHtml() || '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
          }
          renderDesignRulesPanel();
          selectedFolderId = null;
          saveCanvasHistory();
          renderCanvasHistory();
          folderView.classList.add('hidden');
          canvasScrollArea.classList.remove('hidden');
          if (activeMenu !== 'video') renderDesignChatMessages();
          document.getElementById('task-list-overlay')?.classList.add('hidden');
        });
      });
    }
    function showFolderMenu(container, folderId, folderName) {
      const existing = document.querySelector('.history-item-dropdown');
      if (existing) existing.remove();
      const dropdown = document.createElement('div');
      dropdown.className = 'history-item-dropdown';
      dropdown.innerHTML = `
        <div class="history-item-dropdown-main">
          <button data-action="folder-rename">ì´ë¦„ ìˆ˜ì •</button>
          <button data-action="folder-delete" class="text-red-600">ì‚­ì œ</button>
        </div>
      `;
      container.style.position = 'relative';
      container.appendChild(dropdown);
      const close = () => dropdown.remove();
      dropdown.querySelector('[data-action="folder-rename"]')?.addEventListener('click', (e) => {
        e.stopPropagation();
        close();
        showFolderRenameModal(folderId, folderName, () => {
          renderFolderItemsInChat();
          renderFolderItemsInCanvas();
        });
      });
      dropdown.querySelector('[data-action="folder-delete"]')?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!confirm('ì´ í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”? í´ë” ì•ˆì˜ í•­ëª©ì€ í´ë”ì—ì„œ ì œê±°ë©ë‹ˆë‹¤.')) { close(); return; }
        const folders = getTaskFolders();
        const list = activeMenu === 'chat' ? taskListChat : (activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage));
        list.forEach(i => { if (i.folderId === folderId) i.folderId = null; });
        const next = folders.filter(f => f.id !== folderId);
        setTaskFolders(next);
        saveCurrentTaskList();
        if (activeMenu === 'chat') try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {}
        if (selectedFolderId === folderId) { selectedFolderId = null; renderFolderItemsInChat(); renderFolderItemsInCanvas(); }
        renderCanvasHistory();
        close();
      });
      const handler = () => { close(); document.removeEventListener('click', handler); };
      setTimeout(() => document.addEventListener('click', handler), 0);
    }
    function showHistoryItemMenu(container, idx) {
      const existing = document.querySelector('.history-item-dropdown');
      if (existing) existing.remove();
      const list = activeMenu === 'chat' ? taskListChat : (activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage));
      const item = list[idx];
      if (!item) return;
      const folders = getTaskFolders();
      const dropdown = document.createElement('div');
      dropdown.className = 'history-item-dropdown';
      dropdown.innerHTML = `
        <div class="history-item-dropdown-main">
          <button data-action="rename">ì´ë¦„ ìˆ˜ì •</button>
          <button data-action="pin">${item.pinned ? 'ìƒë‹¨ ê³ ì • í•´ì œ' : 'ìƒë‹¨ ê³ ì •'}</button>
          ${item.folderId ? '<button data-action="unfolder">í´ë”ì—ì„œ ì œê±°</button>' : ''}
          ${folders.length ? '<button data-action="tofolder">í´ë”ë¡œ ì´ë™ â–¸</button>' : '<button data-action="newfolder">ğŸ“+ ìƒˆ í´ë”</button>'}
          <button data-action="delete" class="text-red-600">ì‚­ì œ</button>
        </div>
        ${folders.length ? `<div class="history-item-dropdown-submenu hidden" data-submenu>
          <button data-action="newfolder">ğŸ“+ ìƒˆ í´ë”</button>
          ${folders.map(f => `<button data-folder-id="${escapeHtml(f.id)}">ğŸ“ ${escapeHtml(f.name)}</button>`).join('')}
        </div>` : ''}
      `;
      container.style.position = 'relative';
      container.appendChild(dropdown);
      const close = () => dropdown.remove();
      const submenu = dropdown.querySelector('[data-submenu]');
      const tofolderBtn = dropdown.querySelector('[data-action="tofolder"]');
      if (tofolderBtn && submenu) {
        tofolderBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          submenu.classList.toggle('hidden');
        });
        submenu.querySelector('[data-action="newfolder"]')?.addEventListener('click', (e) => {
          e.stopPropagation();
          close();
          showNewFolderModal((id) => {
            item.folderId = id;
            saveCurrentTaskList();
            renderCanvasHistory();
            renderFolderItemsInChat();
          });
        });
        submenu.querySelectorAll('[data-folder-id]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            item.folderId = btn.getAttribute('data-folder-id');
            saveCurrentTaskList();
            renderCanvasHistory();
            renderFolderItemsInChat();
            close();
          });
        });
      }
      dropdown.querySelectorAll('.history-item-dropdown-main button').forEach(b => {
        const action = b.getAttribute('data-action');
        if (action === 'tofolder') return;
        b.addEventListener('click', (e) => {
          e.stopPropagation();
          if (action === 'newfolder') {
            close();
            showNewFolderModal((id) => {
              item.folderId = id;
              saveCurrentTaskList();
              renderCanvasHistory();
              renderFolderItemsInChat();
            });
            return;
          }
          if (action === 'rename') {
            close();
            showTaskRenameModal(item.title || '', (name) => {
              if (name && name.trim()) { item.title = name.trim().slice(0, 50); saveCurrentTaskList(); renderCanvasHistory(); }
            });
            return;
          } else if (action === 'pin') {
            item.pinned = !item.pinned;
            saveCurrentTaskList();
            renderCanvasHistory();
          } else if (action === 'unfolder') {
            item.folderId = null;
            saveCurrentTaskList();
            renderCanvasHistory();
          } else if (action === 'delete') {
            if (!confirm('ì´ ì‘ì—…ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            list.splice(idx, 1);
            if (activeMenu === 'chat') { taskListChat = list; try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {} }
            else { saveCanvasHistory(); }
            renderCanvasHistory();
            if (activeMenu === 'chat' && item.id === 'current') { aiChatHistory = []; renderAiChatMessages(); }
          }
          close();
        });
      });
      const handler = () => { close(); document.removeEventListener('click', handler); };
      setTimeout(() => document.addEventListener('click', handler), 0);
    }
    function saveChatTaskList() {
      const title = (aiChatHistory.find(m => m.role === 'user')?.content || 'ìƒˆ ëŒ€í™”').slice(0, 50);
      const now = new Date();
      const ts = now.toLocaleString('ko-KR', { hour12: false });
      let curr = taskListChat.find(i => i.id === 'current');
      const folderId = selectedFolderId || null;
      const rulesToSave = JSON.parse(JSON.stringify(getDesignRulesForMode()));
      if (aiChatHistory.length === 0) {
        if (curr) { curr.designRules = rulesToSave; }
        else if (rulesToSave.length > 0) {
          curr = { id: 'current', title: 'ìƒˆ ëŒ€í™”', updatedAt: ts, messages: [], designRules: rulesToSave, pinned: false, folderId };
          taskListChat.unshift(curr);
        } else {
          return;
        }
      } else {
        const firstUser = (arr) => (arr || []).find(m => m.role === 'user')?.content;
        const isNewConversation = curr && curr.messages?.length > 0 && firstUser(aiChatHistory) !== firstUser(curr.messages);
        if (isNewConversation) {
          delete curr.id;
          curr = { id: 'current', title, updatedAt: ts, messages: JSON.parse(JSON.stringify(aiChatHistory)), designRules: rulesToSave, pinned: false, folderId };
          taskListChat.unshift(curr);
        } else if (curr) {
          curr.title = title;
          curr.updatedAt = ts;
          curr.messages = JSON.parse(JSON.stringify(aiChatHistory));
          curr.designRules = rulesToSave;
        } else {
          curr = { id: 'current', title, updatedAt: ts, messages: JSON.parse(JSON.stringify(aiChatHistory)), designRules: rulesToSave, pinned: false, folderId };
          taskListChat.unshift(curr);
        }
      }
      const toSave = taskListChat.slice(0, MAX_HISTORY_ITEMS);
      try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(toSave)); } catch (_) {}
    }
    function upsertCanvasHistory(title) {
      const now = new Date();
      const ts = now.toLocaleString('ko-KR', { hour12: false });
      const existing = canvasHistory.find(item => item.id === 'current');
      const rowsToSave = designRows.length > 0 ? JSON.parse(JSON.stringify(designRows)) : (existing?.designRows || []);
      const chatToSave = Array.isArray(chatHistory) && chatHistory.length > 0 ? JSON.parse(JSON.stringify(chatHistory)) : (existing?.chatHistory || []);
      const rulesToSave = JSON.parse(JSON.stringify(getDesignRulesForMode()));
      const videoOpts = activeMenu === 'video' ? null : (existing?.videoOptions || null);
      if (existing) {
        existing.title = title;
        existing.updatedAt = ts;
        existing.designRows = rowsToSave;
        existing.chatHistory = chatToSave;
        existing.designRules = rulesToSave;
        if (activeMenu === 'video') delete existing.videoOptions;
      } else {
        const newItem = { id: 'current', title, updatedAt: ts, designRows: rowsToSave, chatHistory: chatToSave, designRules: rulesToSave, pinned: false, folderId: null };
        if (activeMenu === 'video') delete newItem.videoOptions;
        canvasHistory.unshift(newItem);
      }
      saveCanvasHistory();
      renderCanvasHistory();
    }

    function parseGeminiError(data, defaultMsg) {
      const err = data?.error;
      if (!err) return defaultMsg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      const code = err.code;
      const status = err.status || '';
      const msg = err.message || '';
      const codeMap = { 400: 'ì˜ëª»ëœ ìš”ì²­', 401: 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ', 403: 'ê¶Œí•œ ì—†ìŒ ë˜ëŠ” API ë¹„í™œì„±í™”', 404: 'ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 429: 'API ë¹„ìœ¨ ì œí•œ ì´ˆê³¼ (ì ì‹œ í›„ ì¬ì‹œë„)', 500: 'ì„œë²„ ì˜¤ë¥˜' };
      const statusMap = { INVALID_ARGUMENT: 'ì˜ëª»ëœ ìš”ì²­', UNAUTHENTICATED: 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ', PERMISSION_DENIED: 'ê¶Œí•œ ì—†ìŒ ë˜ëŠ” API ë¹„í™œì„±í™”', NOT_FOUND: 'ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', RESOURCE_EXHAUSTED: 'API ë¹„ìœ¨ ì œí•œ ì´ˆê³¼ (ì ì‹œ í›„ ì¬ì‹œë„)', INTERNAL: 'ì„œë²„ ì˜¤ë¥˜' };
      const codeStr = codeMap[code] || statusMap[status] || (code != null ? `ì˜¤ë¥˜ ì½”ë“œ ${code}` : status || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      return msg ? `[Gemini API] ${codeStr}: ${msg}` : `[Gemini API] ${codeStr}`;
    }

    const GEMINI_IMAGE_FALLBACK = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="#e5e7eb" width="400" height="400"/><text x="50%" y="50%" fill="#9ca3af" font-family="\'Pretendard\', sans-serif" font-size="14" text-anchor="middle" dy=".3em">Gemini ì´ë¯¸ì§€ ìƒì„± í•„ìš”</text></svg>');
    const NANO_BANANA_PRO = 'gemini-3-pro-image-preview';
    const NANO_BANANA = 'gemini-2.5-flash-image';
    const IMAGE_MODELS_FALLBACK = [NANO_BANANA, 'gemini-2.0-flash-preview-image-generation'];
    const NANO_BANANA_PRO_RPM = 20;
    const IMAGE_REQUEST_DELAY_MS = Math.ceil(60000 / NANO_BANANA_PRO_RPM);

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function generateGeminiImageWithModel(apiKey, prompt, aspectRatio, modelId) {
      const ar = aspectRatio || '1:1';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
      const imageConfig = modelId === NANO_BANANA_PRO ? { aspectRatio: ar, imageSize: '2K' } : { aspectRatio: ar };
      const payload = {
        contents: [{ role: 'user', parts: [{ text: prompt }] }],
        generationConfig: { responseModalities: ['TEXT', 'IMAGE'], imageConfig }
      };
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await res.json();
      if (!res.ok) throw new Error(parseGeminiError(data, 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'));
      const parts = data.candidates?.[0]?.content?.parts || [];
      for (const part of parts) {
        const inline = part.inlineData || part.inline_data;
        if (inline?.data) return `data:${inline.mimeType || inline.mime_type || 'image/png'};base64,${inline.data}`;
      }
      throw new Error('ì´ë¯¸ì§€ ìƒì„± ì‘ë‹µì— ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    async function generateGeminiImage(apiKey, prompt, aspectRatio) {
      if (isImageOnlyMode()) {
        const models = [NANO_BANANA, NANO_BANANA_PRO, ...IMAGE_MODELS_FALLBACK.filter(m => m !== NANO_BANANA)];
        for (const model of models) {
          try {
            return await generateGeminiImageWithModel(apiKey, prompt, aspectRatio, model);
          } catch (e) {
            const isRateLimit = /429|quota|rate|limit|RESOURCE_EXHAUSTED/i.test(e?.message || '');
            if (typeof addSystemMessage === 'function') {
              addSystemMessage(isRateLimit ? 'API ë¹„ìœ¨ ì œí•œ, ëŒ€ì²´ ëª¨ë¸ ì‹œë„ ì¤‘â€¦' : `ëŒ€ì²´ ëª¨ë¸ ì‹œë„: ${(e?.message || e).slice(0, 80)}`);
            }
            if (model === models[models.length - 1]) throw e;
          }
        }
      }
      const imageConfig = { aspectRatio: aspectRatio || '1:1' };
      let lastErr = null;
      for (const model of IMAGE_MODELS_FALLBACK) {
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
          const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'], imageConfig } };
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) { lastErr = parseGeminiError(data, 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'); continue; }
          const parts = data.candidates?.[0]?.content?.parts || [];
          for (const part of parts) {
            if (part.inlineData?.data) return `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;
          }
          lastErr = 'ì´ë¯¸ì§€ ìƒì„± ì‘ë‹µì— ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        } catch (e) { lastErr = e.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'; }
      }
      throw new Error(lastErr || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }

    const MAX_LABEL_LENGTH = 20;
    const DESIGN_LABELS = ['íŠ¸ë Œë“œí˜•', 'í”„ë¦¬ë¯¸ì—„', 'ë‹¤ì´ë ‰íŠ¸', 'ë²„ì „ D', 'ë²„ì „ E'];
    function trimLabel(text) {
      if (!text) return '';
      return text.length > MAX_LABEL_LENGTH ? text.slice(0, MAX_LABEL_LENGTH - 1) + 'â€¦' : text;
    }
    function getBlockLabel(rowIdx, blockIdx) {
      if (rowIdx === 0) return trimLabel(DESIGN_LABELS[blockIdx] || `ì‹œì•ˆ ${blockIdx + 1}`);
      return trimLabel(`ìˆ˜ì •ë³¸ ${rowIdx}`);
    }
    function isImageOnlyMode() { return document.querySelector('#global-nav [data-mode].nav-item-active')?.getAttribute('data-mode') === 'image'; }
    function isCardnewsMode() { return activeMenu === 'cardnews'; }

    function buildCardnewsJsonPrompt(slideCount) {
      const n = Math.min(10, Math.max(3, slideCount || 5));
      return `You are a card news content designer. Given a topic, output a JSON object with exactly ${n} slides for a Korean card news (Instagram 4:5 format).
Output ONLY valid JSON, no markdown code block. Format:
{"slides":[{"title":"ì œëª©","body":"ë³¸ë¬¸ í…ìŠ¤íŠ¸","imagePrompt":"English prompt for photorealistic background image"}]}
Rules:
- Slide 1 (Intro): title only, body empty "". imagePrompt must include "dark moody cinematic" for immersive first impression.
- Slides 2-${n}: title 10-15 chars, body 1-2 short sentences 30-50 chars.
- imagePrompt: English, under 80 chars, background only (no text), suitable for 4:5 vertical card.
- Exactly ${n} slides. Do NOT use unescaped double quotes inside title, body, or imagePrompt values.`;
    }
    function tryParseCardnewsJson(jsonText) {
      try {
        return JSON.parse(jsonText);
      } catch (e) {
        if (e instanceof SyntaxError && (e.message.includes('Unterminated string') || e.message.includes('Unexpected end'))) {
          const lastSep = jsonText.lastIndexOf('"},{"title"');
          if (lastSep >= 0) {
            const repaired = jsonText.substring(0, lastSep + 2) + ']}';
            try { return JSON.parse(repaired); } catch (_) {}
          }
          const altSep = jsonText.lastIndexOf('"},{"title');
          if (altSep >= 0) {
            const repaired = jsonText.substring(0, altSep + 2) + ']}';
            try { return JSON.parse(repaired); } catch (_) {}
          }
        }
        throw e;
      }
    }

    function cardnewsColorStyle(c, defaultSolid) {
      const val = c || defaultSolid;
      if (val && String(val).indexOf('gradient') >= 0) return `background:${val};-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;`;
      return `color:${val};`;
    }
    function buildCardnewsSlideHtml(b, rowIdx, blockIdx) {
      const isIntro = rowIdx === 0 && blockIdx === 0;
      const isLoading = !b.imageUrl || b.imageUrl === 'loading';
      const safeBg = (url) => (url && url !== 'loading' ? url : GEMINI_IMAGE_FALLBACK);
      const title = (b.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const body = (b.body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const ts = b.titleStyle || {};
      const bs = b.bodyStyle || {};
      const titleStyle = `font-family:${ts.fontFamily || 'Pretendard, sans-serif'};font-size:${ts.fontSize || '2.5rem'};font-weight:${ts.fontWeight || '800'};${cardnewsColorStyle(ts.color, '#fff')}letter-spacing:-0.03em;`;
      const bodyStyle = `font-family:${bs.fontFamily || 'Pretendard, sans-serif'};font-size:${bs.fontSize || '1.1rem'};font-weight:${bs.fontWeight || '500'};${cardnewsColorStyle(bs.color, 'rgba(255,255,255,0.95)')}`;
      const bgStyle = isLoading ? 'background:linear-gradient(135deg,#e5e7eb 0%,#d1d5db 100%);' : `background:url('${safeBg(b.imageUrl)}') center/cover no-repeat;`;
      const skeletonEl = isLoading ? '<div class="cardnews-skeleton" style="position:absolute;inset:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.4) 50%,transparent 100%);background-size:200% 100%;animation:cardnews-shimmer 1.5s infinite;"></div>' : '';
      const introClass = isIntro ? ' is-intro' : '';
      const contentLayout = isIntro ? 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:32px;text-align:center;' : 'position:absolute;bottom:0;left:0;right:0;padding:28px 24px;';
      const bodyEl = isIntro ? '' : `<p class="cardnews-body" contenteditable="true" data-edit="body" data-row="${rowIdx}" data-block="${blockIdx}" style="margin:0;${bodyStyle}line-height:1.6;text-shadow:0 1px 2px rgba(0,0,0,0.4);outline:none;">${body}</p>`;
      return `<div class="cardnews-slide-wrap" style="flex-shrink:0;margin-right:24px;display:flex;flex-direction:column;align-items:center;">
        <div class="cardnews-slide${introClass}" data-row="${rowIdx}" data-block="${blockIdx}" style="position:relative;width:360px;min-height:450px;aspect-ratio:4/5;${bgStyle}border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
          <div class="cardnews-overlay" style="position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 25%, transparent 65%, rgba(0,0,0,0.5) 100%);pointer-events:none;"></div>
          ${skeletonEl}
          <div class="cardnews-content" style="${contentLayout}pointer-events:auto;">
            <h1 class="cardnews-title" contenteditable="true" data-edit="title" data-row="${rowIdx}" data-block="${blockIdx}" style="margin:0;${titleStyle}line-height:1.25;text-shadow:0 1px 4px rgba(0,0,0,0.5);outline:none;">${title}</h1>
            ${bodyEl}
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:center;">
          <button onclick="window.parent.__wavaDownloadPng(${rowIdx},${blockIdx})" style="padding:6px 14px;font-size:12px;background:#2C96FF;color:white;border:none;border-radius:6px;cursor:pointer;">PNG</button>
          <button onclick="window.parent.__wavaDownloadHtml(${rowIdx},${blockIdx})" style="padding:6px 14px;font-size:12px;background:white;color:#333;border:1px solid #ddd;border-radius:6px;cursor:pointer;">HTML</button>
        </div>
      </div>`;
    }

    function buildRowsDisplayHtml() {
      const hasCardnews = designRows.length > 0 && designRows[0]?.[0]?.cardnewsSlide;
      if (hasCardnews) {
        const allSlides = designRows.flatMap((row, rowIdx) =>
          row.filter(b => b.cardnewsSlide).map((b, blockIdx) => ({ b, rowIdx, blockIdx }))
        );
        const row1Slides = allSlides.slice(0, 7);
        const row2Slides = allSlides.slice(7);
        const row1Html = row1Slides.map(({ b, rowIdx, blockIdx }) => buildCardnewsSlideHtml(b, rowIdx, blockIdx)).join('');
        const row2Html = row2Slides.length > 0
          ? '<div style="display:flex;flex-direction:row;align-items:flex-start;margin-top:24px;flex-shrink:0;">' + row2Slides.map(({ b, rowIdx, blockIdx }) => buildCardnewsSlideHtml(b, rowIdx, blockIdx)).join('') + '</div>'
          : '';
        const slidesHtml = row2Slides.length > 0
          ? '<div style="display:flex;flex-direction:column;align-items:flex-start;"><div style="display:flex;flex-direction:row;align-items:flex-start;flex-shrink:0;">' + row1Html + '</div>' + row2Html + '</div>'
          : '<div style="display:flex;flex-direction:row;align-items:flex-start;flex-shrink:0;">' + row1Html + '</div>';
        const cardnewsStyles = 'body{font-family:\'Pretendard\',-apple-system,sans-serif}.cardnews-title:focus,.cardnews-body:focus{outline:2px solid #2C96FF;outline-offset:2px;border-radius:4px}.cardnews-slide.is-intro::before{content:\'\';position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.5) 0%,rgba(0,0,0,0.3) 50%,rgba(0,0,0,0.6) 100%);pointer-events:none;z-index:1}.cardnews-slide.is-intro .cardnews-title{font-size:3rem!important}.cardnews-text-toolbar{position:fixed;background:#1e293b;color:#fff;padding:6px 10px;border-radius:8px;display:flex;align-items:center;gap:6px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:12px}.cardnews-text-toolbar{flex-wrap:wrap;gap:8px}.cardnews-text-toolbar .cardnews-toolbar-row{display:flex;align-items:center;gap:6px}.cardnews-text-toolbar select{height:28px;border:none;border-radius:4px;cursor:pointer}.cardnews-text-toolbar button{padding:4px 10px;background:#334155;border:none;border-radius:4px;color:#fff;cursor:pointer;font-weight:600}.cardnews-text-toolbar button:hover{background:#475569}.cardnews-color-trigger{width:28px;height:28px;border:2px solid rgba(255,255,255,0.5);border-radius:4px;cursor:pointer;padding:0;background:#000;flex-shrink:0}.cardnews-color-trigger:hover{border-color:#fff}.cardnews-text-toolbar .relative{position:relative}.cardnews-color-popover{position:absolute;left:0;top:100%;margin-top:4px;width:220px;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.25);padding:12px;z-index:10000;display:none}.cardnews-color-popover.open{display:block}.cardnews-cp-mode{display:flex;gap:4px;margin-bottom:10px}.cardnews-cp-mode button{padding:4px 10px;font-size:11px;border:1px solid #e5e7eb;border-radius:4px;background:#f9fafb;cursor:pointer;color:#374151}.cardnews-cp-mode button.active{background:#2C96FF;color:#fff;border-color:#2C96FF}.cardnews-cp-main{width:100%;height:120px;border-radius:6px;cursor:crosshair;position:relative;margin-bottom:8px;overflow:hidden}.cardnews-cp-hue{height:10px;border-radius:4px;cursor:pointer;margin-bottom:8px;background:linear-gradient(to right,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00)}.cardnews-cp-alpha{height:10px;border-radius:4px;cursor:pointer;margin-bottom:8px;background:linear-gradient(to right,transparent,#000)}.cardnews-cp-hex{display:flex;align-items:center;gap:6px;margin-bottom:8px}.cardnews-cp-hex input{flex:1;padding:4px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px}.cardnews-cp-hex span{font-size:11px;color:#6b7280;min-width:24px}.cardnews-cp-gradient{display:none}.cardnews-cp-gradient.open{display:block}.cardnews-cp-gbar{height:24px;border-radius:6px;cursor:pointer;margin-bottom:8px;position:relative}.cardnews-cp-gstops{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}.cardnews-cp-gstop{width:24px;height:24px;border:2px solid #fff;border-radius:4px;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.3)}.cardnews-cp-angle{display:flex;align-items:center;gap:6px;margin-top:6px}.cardnews-cp-angle input{width:60px;padding:4px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px}@keyframes cardnews-shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}';
        const textToolbarScript = `(function(){
          var toolbar=document.createElement('div');toolbar.className='cardnews-text-toolbar';toolbar.style.display='none';toolbar.innerHTML='<div class="cardnews-toolbar-row"><select data-cmd="font" title="í°íŠ¸"><option value="Pretendard">Pretendard</option><option value="Noto Sans KR">Noto Sans KR</option><option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option></select><button data-cmd="bold" title="ë³¼ë“œ">B</button><select data-cmd="size"><option value="0.75rem">10px</option><option value="0.875rem">12px</option><option value="1rem">14px</option><option value="1.1rem">16px</option><option value="1.25rem">18px</option><option value="1.5rem">20px</option><option value="1.75rem">22px</option><option value="2rem">24px</option><option value="2.5rem" selected>28px</option><option value="3rem">32px</option><option value="3.5rem">36px</option></select></div><div class="relative"><button type="button" class="cardnews-color-trigger" data-cmd="color" title="ìƒ‰ìƒ ì„ íƒ"></button><div class="cardnews-color-popover" id="cardnews-cp"><div class="cardnews-cp-mode"><button type="button" data-mode="solid" class="active">ë‹¨ìƒ‰</button><button type="button" data-mode="gradient">ê·¸ë¼ë””ì–¸íŠ¸</button></div><div class="cardnews-cp-solid"><div class="cardnews-cp-main" id="cp-main"></div><div class="cardnews-cp-hue" id="cp-hue"></div><div class="cardnews-cp-alpha" id="cp-alpha"></div><div class="cardnews-cp-hex"><span>Hex</span><input type="text" id="cp-hex" value="FFD700" maxlength="7"></div></div><div class="cardnews-cp-gradient"><div class="cardnews-cp-gbar" id="cp-gbar"></div><div class="cardnews-cp-gstops" id="cp-gstops"></div><div class="cardnews-cp-angle"><span>ê°ë„</span><input type="number" id="cp-angle" value="90" min="0" max="360"></div></div></div></div>';
          document.body.appendChild(toolbar);
          var curEl=null,blockField=null;
          var h=0,s=1,v=1,a=1;
          var gStops=[{color:'#ffffff',pos:0},{color:'#000000',pos:100}];
          var gAngle=90;
          var editingStopIdx=0;
          function hex2rgb(h){var r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return[r,g,b];}
          function rgb2hsv(r,g,b){r/=255;g/=255;b/=255;var M=Math.max(r,g,b),m=Math.min(r,g,b),d=M-m,v=M,c=(M===0)?0:d/M;var h=0;if(d!==0){if(M===r)h=((g-b)/d)%6;else if(M===g)h=(b-r)/d+2;else h=(r-g)/d+4;h/=6;if(h<0)h+=1;}return[h,c,v];}
          function hsv2rgb(h,s,v){var r,g,b;var i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);i%=6;switch(i){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;default:r=v;g=p;b=q;}return'#'+[Math.round(r*255),Math.round(g*255),Math.round(b*255)].map(function(x){var s=x.toString(16);return s.length===1?'0'+s:s;}).join('');}
          function rgb2hex(r,g,b){return'#'+[r,g,b].map(function(x){var s=Math.round(x).toString(16);return s.length===1?'0'+s:s;}).join('');}
          function updateColorFromHex(hex){var m=hex.match(/^#?([0-9a-fA-F]{6})$/);if(!m)return;var r=parseInt(m[1].slice(0,2),16),g=parseInt(m[1].slice(2,4),16),b=parseInt(m[1].slice(4,6),16);var hsv=rgb2hsv(r,g,b);h=hsv[0];s=hsv[1];v=hsv[2];}
          function getHex(){return hsv2rgb(h,s,v);}
          function applySize(v){if(!curEl)return;curEl.style.setProperty('font-size',v,'important');}
          function applyColorOrGradient(val,isGrad){if(!curEl)return;if(isGrad&&val&&val.indexOf('gradient')>=0){curEl.style.color='transparent';curEl.style.background=val;curEl.style.webkitBackgroundClip='text';curEl.style.backgroundClip='text';curEl.style.webkitTextFillColor='transparent';}else{curEl.style.background='';curEl.style.webkitBackgroundClip='';curEl.style.backgroundClip='';curEl.style.webkitTextFillColor='';curEl.style.setProperty('color',val||getHex(),'important');}}
          function applyToCurEl(){var m=pop.querySelector('[data-mode=gradient]');if(m&&m.classList.contains('active')){var g=getGradientCss();applyColorOrGradient(g,true);trigger.style.background=g;}else{var c=getHex();applyColorOrGradient(c,false);trigger.style.background=c;}}
          function syncToBlock(){if(!curEl||!blockField)return;var r=curEl.getAttribute('data-row')*1,c=curEl.getAttribute('data-block')*1;var bg=curEl.style.background;var isGrad=bg&&bg.indexOf('gradient')>=0;window.parent.__wavaCardnewsSyncStyle(r,c,blockField,{fontFamily:curEl.style.fontFamily,fontSize:curEl.style.fontSize,fontWeight:curEl.style.fontWeight,color:isGrad?bg:curEl.style.color});}
          function renderMain(){var el=document.getElementById('cp-main');if(!el)return;el.style.background='linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, '+hsv2rgb(h,1,1)+')';}
          function renderHue(){var el=document.getElementById('cp-hue');if(!el)return;el.style.background='linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00)';}
          function renderAlpha(){var el=document.getElementById('cp-alpha');if(!el)return;el.style.background='linear-gradient(to right, transparent, '+getHex()+')';}
          function renderGradient(){var bar=document.getElementById('cp-gbar');var stops=document.getElementById('cp-gstops');if(!bar||!stops)return;var grad='linear-gradient('+gAngle+'deg,'+gStops.map(function(s){return s.color+' '+s.pos+'%';}).join(',')+')';bar.style.background=grad;stops.innerHTML=gStops.map(function(s,i){return'<button type="button" class="cardnews-cp-gstop" data-idx="'+i+'" style="background:'+s.color+'"></button>';}).join('');}
          function getGradientCss(){return'linear-gradient('+gAngle+'deg,'+gStops.map(function(s){return s.color+' '+s.pos+'%';}).join(',')+')';}
          function setupColorPicker(){var pop=document.getElementById('cardnews-cp');var trigger=toolbar.querySelector('.cardnews-color-trigger');var main=document.getElementById('cp-main');var hue=document.getElementById('cp-hue');var alpha=document.getElementById('cp-alpha');var hexIn=document.getElementById('cp-hex');var modeBtns=pop.querySelectorAll('[data-mode]');var solidDiv=pop.querySelector('.cardnews-cp-solid');var gradDiv=pop.querySelector('.cardnews-cp-gradient');var angleIn=document.getElementById('cp-angle');trigger.onclick=function(e){e.stopPropagation();pop.classList.toggle('open');if(pop.classList.contains('open')){renderMain();renderHue();renderAlpha();renderGradient();trigger.style.background=getHex();}};
          modeBtns.forEach(function(btn){btn.onclick=function(){modeBtns.forEach(function(b){b.classList.remove('active');});btn.classList.add('active');if(btn.dataset.mode==='solid'){gradDiv.classList.remove('open');trigger.style.background=getHex();if(curEl)applyColorOrGradient(getHex(),false);}else{gradDiv.classList.add('open');var g=getGradientCss();trigger.style.background=g;if(curEl)applyColorOrGradient(g,true);}renderGradient();};});
          function dragBar(barEl,getVal,setVal,cb){var onMove=function(e){var rect=barEl.getBoundingClientRect();var x=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));setVal(x);cb();};barEl.onmousedown=function(e){e.preventDefault();onMove(e);document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',function(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',arguments.callee);});};}
          if(main){main.onmousedown=function(e){e.preventDefault();var rect=main.getBoundingClientRect();var setSV=function(ev){var x=Math.max(0,Math.min(1,(ev.clientX-rect.left)/rect.width));var y=1-Math.max(0,Math.min(1,(ev.clientY-rect.top)/rect.height));s=x;v=y;hexIn.value=getHex().slice(1).toUpperCase();renderMain();renderAlpha();trigger.style.background=getHex();if(pop.querySelector('[data-mode=gradient]').classList.contains('active')){gStops[editingStopIdx].color=getHex();renderGradient();applyToCurEl();}else if(curEl)applyColorOrGradient(getHex(),false);};setSV(e);document.addEventListener('mousemove',setSV);document.addEventListener('mouseup',function(){document.removeEventListener('mousemove',setSV);document.removeEventListener('mouseup',arguments.callee);});};}
          if(hue){hue.onmousedown=function(e){e.preventDefault();var rect=hue.getBoundingClientRect();var setH=function(ev){h=Math.max(0,Math.min(1,(ev.clientX-rect.left)/rect.width));hexIn.value=getHex().slice(1).toUpperCase();renderMain();renderAlpha();trigger.style.background=getHex();if(pop.querySelector('[data-mode=gradient]').classList.contains('active')){gStops[editingStopIdx].color=getHex();renderGradient();applyToCurEl();}else if(curEl)applyColorOrGradient(getHex(),false);};setH(e);document.addEventListener('mousemove',setH);document.addEventListener('mouseup',function(){document.removeEventListener('mousemove',setH);document.removeEventListener('mouseup',arguments.callee);});};}
          if(alpha){alpha.onmousedown=function(e){e.preventDefault();var rect=alpha.getBoundingClientRect();var setA=function(ev){a=Math.max(0,Math.min(1,(ev.clientX-rect.left)/rect.width));var rgb=hex2rgb(getHex());var c=a<1?'rgba('+rgb.join(',')+','+a+')':getHex();hexIn.value=a<1?c:getHex().slice(1).toUpperCase();renderAlpha();trigger.style.background=c;if(curEl)applyColorOrGradient(c,false);};setA(e);document.addEventListener('mousemove',setA);document.addEventListener('mouseup',function(){document.removeEventListener('mousemove',setA);document.removeEventListener('mouseup',arguments.callee);});};}
          hexIn.oninput=function(){var v=this.value.replace(/^#/,'');if(v.length===6){updateColorFromHex('#'+v);renderMain();renderAlpha();trigger.style.background=getHex();if(pop.querySelector('[data-mode=gradient]').classList.contains('active')){gStops[editingStopIdx].color=getHex();renderGradient();applyToCurEl();}else if(curEl)applyColorOrGradient(getHex(),false);}};
          angleIn.oninput=function(){gAngle=parseInt(this.value,10)||90;renderGradient();if(curEl&&pop.querySelector('[data-mode=gradient]').classList.contains('active'))applyColorOrGradient(getGradientCss(),true);};
          document.getElementById('cp-gbar').onclick=function(e){var rect=this.getBoundingClientRect();var pct=Math.max(0,Math.min(100,((e.clientX-rect.left)/rect.width)*100));gStops[editingStopIdx].pos=Math.round(pct);renderGradient();if(curEl)applyColorOrGradient(getGradientCss(),true);};
          document.addEventListener('click',function(e){if(!pop.contains(e.target)&&!trigger.contains(e.target))pop.classList.remove('open');});
          }
          document.addEventListener('focusin',function(e){var t=e.target;if(t.classList&&(t.classList.contains('cardnews-title')||t.classList.contains('cardnews-body'))){curEl=t;blockField=t.getAttribute('data-edit');toolbar.style.display='flex';var r=t.getBoundingClientRect();toolbar.style.left=Math.max(8,r.left)+'px';toolbar.style.top=Math.max(8,r.top-toolbar.offsetHeight-8)+'px';var fontVal=(t.style.fontFamily||'Pretendard').split(',')[0].replace(/'/g,'').trim();toolbar.querySelector('[data-cmd=font]').value=(fontVal.indexOf('Noto')>=0?'Noto Sans KR':fontVal.indexOf('Nanum')>=0?'Nanum Gothic':'Pretendard');var sz=t.style.fontSize||(t.classList.contains('cardnews-title')?'2.5rem':'1.1rem');var sel=toolbar.querySelector('[data-cmd=size]');var found=false;for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===sz){sel.value=sz;found=true;break;}}if(!found)sel.value=t.classList.contains('cardnews-title')?'2.5rem':'1.1rem';var col=(t.style.color||t.style.background||'#ffffff').replace('rgba(255,255,255,0.95)','#ffffff').replace('rgb(255,255,255)','#ffffff');var isGrad=col.indexOf('gradient')>=0;if(isGrad){var m=col.match(/linear-gradient\\(([0-9]+)deg\\s*,(.+)\\)/);if(m){gAngle=parseInt(m[1],10)||90;var parts=m[2].split(/,\\s*/);gStops=parts.map(function(p){var pm=p.match(/([#rgba\\d\\s,.()]+)\\s+([\\d.]+)%?/);return{color:pm?pm[1].trim():'#fff',pos:pm?parseFloat(pm[2])||0:0};});if(gStops.length<2)gStops=[{color:'#ffffff',pos:0},{color:'#000000',pos:100}];}document.getElementById('cp-angle').value=gAngle;toolbar.querySelector('[data-mode=gradient]').click();renderGradient();}else{updateColorFromHex(col.length>=6&&col[0]==='#'?col:'#'+(col.replace(/^#/,'').slice(0,6)||'ffffff'));}toolbar.querySelector('.cardnews-color-trigger').style.background=col;}}});
          document.addEventListener('focusout',function(){setTimeout(function(){if(document.activeElement!==curEl&&!toolbar.contains(document.activeElement)){toolbar.style.display='none';if(curEl)syncToBlock();curEl=null;}},150);});
          toolbar.addEventListener('click',function(e){var btn=e.target.closest('[data-cmd]');var gstop=e.target.closest('.cardnews-cp-gstop');if(gstop){editingStopIdx=parseInt(gstop.dataset.idx,10);var c=gStops[editingStopIdx].color;updateColorFromHex(c);document.getElementById('cp-hex').value=c.slice(1);renderMain();return;}if(btn&&btn.dataset.cmd==='color')return;if(!btn||!curEl)return;e.preventDefault();if(btn.dataset.cmd==='bold'){curEl.style.fontWeight=curEl.style.fontWeight==='800'?'500':'800';}else if(btn.dataset.cmd==='size'){applySize(btn.value);}else if(btn.dataset.cmd==='font'){curEl.style.fontFamily=btn.value+', sans-serif';}});
          toolbar.querySelectorAll('select').forEach(function(s){s.onchange=function(){if(!curEl)return;if(this.dataset.cmd==='font')curEl.style.fontFamily=this.value+', sans-serif';else applySize(this.value);};});
          setTimeout(setupColorPicker,0);
        })();`;
        const wheelScript = `<script>(function(){var a=window.parent.document.getElementById('canvas-scroll-area');if(!a)return;document.addEventListener('wheel',function(e){if(e.ctrlKey)return;e.preventDefault();var dY=e.deltaY||0,dX=e.deltaX||0;if(e.shiftKey){a.scrollLeft+=dY;a.scrollTop+=dX;}else{a.scrollTop+=dY;a.scrollLeft+=dX;}},{passive:false});})();<\/script>`;
        return `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet"><style>html,body{font-family:'Pretendard',sans-serif;margin:0;padding:24px;background:#e5e7eb;background-image:radial-gradient(rgba(0,0,0,0.08) 1px, transparent 1px);background-size:20px 20px;box-sizing:border-box;overflow:hidden;}*{box-sizing:border-box;}${cardnewsStyles}</style></head><body style="display:flex;flex-direction:row;align-items:flex-start;justify-content:flex-start;min-height:100%;overflow:hidden;">${slidesHtml || ''}<script>${textToolbarScript}<\/script>${wheelScript}</body></html>`;
      }
      const ratio = getCurrentAspectRatio();
      const ar = ratio === '9:16' ? '9/16' : ratio === '16:9' ? '16/9' : '1/1';
      const safeBg = (url) => url || GEMINI_IMAGE_FALLBACK;
      const sel = selectedDesign;
      const isSelected = (r, c) => sel && sel.rowIdx === r && sel.blockIdx === c;
      const CARD_WIDTH = 320;
      const card = (b, rowIdx, blockIdx, rowLen) => {
        const cardStyle = `width:${CARD_WIDTH}px;flex:0 0 ${CARD_WIDTH}px;min-width:${CARD_WIDTH}px;`;
        const label = getBlockLabel(rowIdx, blockIdx);
        const labelEl = `<div class="design-row-label" style="color:#9ca3af;font-size:12px;margin-bottom:8px;font-weight:500;">${label}</div>`;
        const selCls = isSelected(rowIdx, blockIdx) ? ' design-card-selected' : '';
        const clickHandler = `onclick="event.stopPropagation(); window.parent.__wavaSelectDesign(${rowIdx},${blockIdx})"`;
        const btnStop = `onclick="event.stopPropagation()"`;
        if (b.imageOnly && b.img) {
          return `<div data-row="${rowIdx}" data-block="${blockIdx}" class="design-card-clickable${selCls}" ${clickHandler} style="${cardStyle}border-radius:8px;">${labelEl}<div class="design-card-inner design-img-only" style="aspect-ratio:${ar};width:100%;min-height:0;overflow:hidden;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;background:#f9fafb;"><img src="${b.img}" alt="" style="width:100%;height:100%;object-fit:contain;"></div><div style="margin-top:12px;display:flex;gap:8px;" ${btnStop}><button onclick="window.parent.__wavaDownloadPng(${rowIdx},${blockIdx})" style="padding:8px 16px;font-size:13px;background:#2C96FF;color:white;border:none;border-radius:6px;cursor:pointer;">PNG</button></div></div>`;
        }
        return `<div data-row="${rowIdx}" data-block="${blockIdx}" class="design-card-clickable${selCls}" ${clickHandler} style="${cardStyle}border-radius:8px;">${labelEl}<div class="design-card-inner" style="background:url('${safeBg(b.bg)}') center/cover;aspect-ratio:${ar};width:100%;min-height:0;overflow:hidden;padding:24px;display:flex;flex-direction:column;justify-content:center;box-sizing:border-box;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">${b.overlay}</div><div style="margin-top:12px;display:flex;gap:8px;" ${btnStop}><button onclick="window.parent.__wavaDownloadPng(${rowIdx},${blockIdx})" style="padding:8px 16px;font-size:13px;background:#2C96FF;color:white;border:none;border-radius:6px;cursor:pointer;">PNG</button><button onclick="window.parent.__wavaDownloadHtml(${rowIdx},${blockIdx})" style="padding:8px 16px;font-size:13px;background:white;color:#333;border:1px solid #ddd;border-radius:6px;cursor:pointer;">HTML</button></div></div>`;
      };
      let html = '';
      designRows.forEach((row, rowIdx) => {
        if (!row?.length) return;
        const isPrimaryRow = rowIdx === 0 && row.length > 1;
        const rowStyle = isPrimaryRow
          ? 'display:flex;flex-wrap:nowrap;flex-direction:row;gap:24px;margin-bottom:32px;width:max-content;'
          : 'display:flex;flex-wrap:wrap;flex-direction:row;gap:24px;margin-bottom:32px;';
        html += `<div style="${rowStyle}">${row.map((b, blockIdx) => card(b, rowIdx, blockIdx, row.length)).join('')}</div>`;
      });
      const cardStyles = '.design-card-selected{outline:2px dashed #2C96FF!important;outline-offset:4px}.design-card-clickable{cursor:pointer}';
      return `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><style>html,body{font-family:'Pretendard',sans-serif;margin:0;padding:32px;background:#e5e7eb;background-image:radial-gradient(rgba(0,0,0,0.08) 1px, transparent 1px);background-size:20px 20px;overflow:hidden;box-sizing:border-box;}*{box-sizing:border-box;}${cardStyles}</style></head><body style="display:block;width:fit-content;">${html || ''}</body></html>`;
    }
    function buildDownloadHtml() {
      const ratio = getCurrentAspectRatio();
      const { height: h, width: w } = getDimensionsForRatio(ratio);
      const allBlocks = (designRows || []).flat();
      if (allBlocks.length === 0) return '';
      const safeBg = (url) => url || GEMINI_IMAGE_FALLBACK;
      const blockHtml = (b) => {
        if (b.cardnewsSlide) {
          const t = (b.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const body = (b.body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const ts = b.titleStyle || {};
          const bs = b.bodyStyle || {};
          const tColor = cardnewsColorStyle(ts.color, '#fff');
          const bColor = cardnewsColorStyle(bs.color, 'rgba(255,255,255,0.95)');
          return `<div style="position:relative;height:${h}px;width:${w}px;background:url('${safeBg(b.imageUrl)}') center/cover;">
            <div style="position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 25%, transparent 65%, rgba(0,0,0,0.5) 100%);"></div>
            <div style="position:absolute;bottom:0;left:0;right:0;padding:28px 24px;">
              <h1 style="margin:0 0 12px;font-size:${ts.fontSize || '2.5rem'};font-weight:${ts.fontWeight || '800'};letter-spacing:-0.03em;${tColor}">${t}</h1>
              <p style="margin:0;font-size:${bs.fontSize || '1.1rem'};font-weight:${bs.fontWeight || '500'};${bColor}line-height:1.6;">${body}</p>
            </div>
          </div>`;
        }
        if (b.imageOnly && b.img) return `<div style="height:${h}px;width:${w}px;"><img src="${b.img}" alt="" style="width:100%;height:100%;object-fit:cover;"></div>`;
        return `<div style="background:url('${safeBg(b.bg)}') center/cover;height:${h}px;width:100%;padding:24px;display:flex;flex-direction:column;justify-content:center;box-sizing:border-box;">${b.overlay}</div>`;
      };
      const totalH = allBlocks.length * h;
      const totalW = w;
      return `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><style>html,body{font-family:'Pretendard',sans-serif;margin:0;padding:0;width:${totalW}px;height:${totalH}px;overflow:hidden;box-sizing:border-box;}*{box-sizing:border-box;}</style></head><body>${allBlocks.map(blockHtml).join('')}</body></html>`;
    }
    function resizeIframeToContent() {
      try {
        const doc = previewIframe.contentDocument;
        if (doc && doc.body) {
          const h = Math.max(300, doc.body.scrollHeight + 48);
          const w = Math.max(300, doc.body.scrollWidth + 48);
          previewIframe.style.height = h + 'px';
          previewIframe.style.width = w + 'px';
        }
      } catch (e) {}
    }
    function fitCanvasToView() {
      if (!canvasScrollArea || !canvasZoomWrapper || designRows.length === 0) return;
      const areaW = canvasScrollArea.clientWidth - 48;
      const areaH = canvasScrollArea.clientHeight - 48;
      if (areaW <= 0 || areaH <= 0) return;
      const contentW = canvasZoomWrapper.scrollWidth || canvasZoomWrapper.offsetWidth;
      const contentH = canvasZoomWrapper.scrollHeight || canvasZoomWrapper.offsetHeight;
      if (contentW <= 0 || contentH <= 0) return;
      const scaleX = areaW / contentW;
      const scaleY = areaH / contentH;
      canvasZoom = Math.min(scaleX, scaleY, 1);
      canvasZoom = Math.max(0.1, Math.min(3, canvasZoom));
      applyCanvasZoom();
    }
    function attachCardnewsContentEditable() {
      try {
        const doc = previewIframe?.contentDocument;
        if (!doc || !designRows?.length) return;
        doc.querySelectorAll('[contenteditable="true"][data-edit][data-row][data-block]').forEach(el => {
          const rowIdx = parseInt(el.getAttribute('data-row'), 10);
          const blockIdx = parseInt(el.getAttribute('data-block'), 10);
          const field = el.getAttribute('data-edit');
          const block = designRows[rowIdx]?.[blockIdx];
          if (!block?.cardnewsSlide || (field !== 'title' && field !== 'body')) return;
          const sync = () => {
            const text = el.innerText?.trim() ?? '';
            if (field === 'title') block.title = text;
            else block.body = text;
            const styleKey = field === 'title' ? 'titleStyle' : 'bodyStyle';
            block[styleKey] = block[styleKey] || {};
            block[styleKey].fontFamily = el.style.fontFamily || undefined;
            block[styleKey].fontSize = el.style.fontSize || undefined;
            block[styleKey].fontWeight = el.style.fontWeight || undefined;
            const bg = el.style.background;
            block[styleKey].color = (bg && bg.indexOf('gradient') >= 0) ? bg : (el.style.color || undefined);
            saveCanvasHistory();
          };
          el.removeEventListener('blur', sync);
          el.addEventListener('blur', sync);
        });
      } catch (e) { console.warn('attachCardnewsContentEditable:', e); }
    }

    window.__wavaCardnewsSyncStyle = function(rowIdx, blockIdx, field, style) {
      const block = designRows?.[rowIdx]?.[blockIdx];
      if (!block?.cardnewsSlide) return;
      const key = field === 'title' ? 'titleStyle' : 'bodyStyle';
      block[key] = block[key] || {};
      if (style.fontFamily) block[key].fontFamily = style.fontFamily;
      if (style.fontSize) block[key].fontSize = style.fontSize;
      if (style.fontWeight) block[key].fontWeight = style.fontWeight;
      if (style.color) block[key].color = style.color;
      saveCanvasHistory();
    };

    function renderHtml(html, downloadHtml) {
      if (!html) return;
      lastGeneratedHtml = downloadHtml || html;
      if (designRows.length > 0) upsertCanvasHistory(canvasTitle);
      const isFullDoc = /<!DOCTYPE\s+html|<\s*html\s/i.test(html);
      const fullHtml = isFullDoc ? html : `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><style>body{font-family:'Pretendard',sans-serif;margin:0;padding:24px;background:white;min-height:100vh;}</style></head><body>${html}</body></html>`;
      previewIframe.removeAttribute('src');
      previewIframe.srcdoc = fullHtml;
      previewIframe.onload = () => {
        resizeIframeToContent();
        attachIframeWheelListener();
        const hasCardnews = designRows.length > 0 && designRows.flat().some(b => b.cardnewsSlide);
        if (hasCardnews) {
          attachCardnewsContentEditable();
          canvasScrollArea?.classList.add('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-outer')?.classList.add('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-wrapper')?.classList.add('canvas-cardnews-mode');
          document.getElementById('cardnews-toolbar')?.classList.remove('hidden');
        } else {
          canvasScrollArea?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-outer')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-wrapper')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('cardnews-toolbar')?.classList.add('hidden');
        }
        setTimeout(fitCanvasToView, 100);
      };
      setTimeout(() => {
        resizeIframeToContent();
        fitCanvasToView();
        const hasCardnews = designRows.length > 0 && designRows.flat().some(b => b.cardnewsSlide);
        if (hasCardnews) {
          attachCardnewsContentEditable();
          canvasScrollArea?.classList.add('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-outer')?.classList.add('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-wrapper')?.classList.add('canvas-cardnews-mode');
          document.getElementById('cardnews-toolbar')?.classList.remove('hidden');
        } else {
          canvasScrollArea?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-outer')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('canvas-zoom-wrapper')?.classList.remove('canvas-cardnews-mode');
          document.getElementById('cardnews-toolbar')?.classList.add('hidden');
        }
      }, 400);
    }

    function buildContents(userPrompt, isModify, isAdd, selectedRowIndex, multiCount) {
      const parts = [];
      const row1 = designRows[0] || [];
      if (isAdd && row1.length > 0) {
        const firstUser = chatHistory.find(m => m.role === 'user')?.text || userPrompt;
        parts.push({ role: 'user', parts: [{ text: `[ì²« ìš”ì²­] ${firstUser}` }] });
        parts.push({ role: 'model', parts: [{ text: row1[0]?.overlay || '' }] });
      } else {
        chatHistory.forEach(msg => parts.push({ role: msg.role, parts: [{ text: msg.text }] }));
      }
      let finalPrompt = userPrompt;
      if (isModify && row1.length > 0) {
        const flatBlocks = (designRows || []).flat();
        const idx = selectedRowIndex >= 0 && selectedRowIndex < flatBlocks.length ? selectedRowIndex : 0;
        const targetOverlay = flatBlocks[idx].overlay;
        finalPrompt = `[ìˆ˜ì • ëª¨ë“œ] ì•„ë˜ HTMLì„ ìˆ˜ì •í•©ë‹ˆë‹¤. (1í–‰ ${idx + 1}ë²ˆì§¸ ì‹œì•ˆ)

\`\`\`html
${targetOverlay}
\`\`\`

ì‚¬ìš©ì ìˆ˜ì • ìš”ì²­: ${userPrompt}

[ì¶œë ¥] ìˆ˜ì •ëœ ì „ì²´ ì˜¤ë²„ë ˆì´ HTML 1ê°œë§Œ ì¶œë ¥. ì½”ë“œ ë¸”ë¡ 1ê°œ. ë¬¸êµ¬ëŠ” ê¸€ì ê·¸ëŒ€ë¡œ ìœ ì§€.`;
      } else if (isAdd && row1.length > 0) {
        const refOverlay = row1[0].overlay;
        finalPrompt = `[ì¶”ê°€ ì œì‘ ëª¨ë“œ] ê¸°ì¡´ ë””ìì¸ ì°¸ì¡°.

[ì°¸ì¡° - í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©]
\`\`\`html
${refOverlay}
\`\`\`

ì‚¬ìš©ì ì¶”ê°€ ìš”ì²­: ${userPrompt}

[ì¶œë ¥] ë™ì¼ í…ìŠ¤íŠ¸ ì‚¬ìš©, ë ˆì´ì•„ì›ƒÂ·ìƒ‰ìƒë§Œ ë‹¤ë¥¸ ìƒˆ ì˜¤ë²„ë ˆì´ HTML 1ê°œ.`;
      } else if (multiCount >= 2) {
        finalPrompt = `[ê´‘ê³  ì†Œì¬ ì œì‘ - ${multiCount}ê°œ ë™ì‹œ ì‘ì—…]

ì‚¬ìš©ìê°€ ${multiCount}ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ë””ìì¸ì„ í•œë²ˆì— ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë©”ì‹œì§€ì—ì„œ ${multiCount}ê°œì˜ ìš”ì²­ì„ íŒŒì•…í•˜ê³ , ê°ê°ì— ë§ëŠ” ë””ìì¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

âš ï¸ ê° ìš”ì²­ì˜ ë¬¸êµ¬ëŠ” ê¸€ì ê·¸ëŒ€ë¡œ ì‚¬ìš©. í•œ ê¸€ìë„ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”.

---
${userPrompt}
---

[ì¶œë ¥] ${multiCount}ê°œì˜ html ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ êµ¬ë¶„í•´ ì¶œë ¥. \`\`\`html ... \`\`\` \`\`\`html ... \`\`\` ...`;
      } else {
        finalPrompt = `[ê´‘ê³  ì†Œì¬ ì œì‘ - 1í–‰ ì—¬ëŸ¬ ì‹œì•ˆ]

âš ï¸ ì‚¬ìš©ìê°€ ì œì‹œí•œ ëª¨ë“  ë¬¸êµ¬(L1, L2, L3, CTA ë“±)ëŠ” ë°˜ë“œì‹œ ê¸€ì ê·¸ëŒ€ë¡œ ì‚¬ìš©. í•œ ê¸€ìë„ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”.

---
${userPrompt}
---

[ì¶œë ¥] ë ˆì´ì•„ì›ƒÂ·ìƒ‰ìƒì´ ì„œë¡œ ë‹¤ë¥¸ 3ê°€ì§€ ì‹œì•ˆì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ê° ì‹œì•ˆì„ \`\`\`html ... \`\`\` ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ êµ¬ë¶„í•´ 3ê°œ ì¶œë ¥.`;
      }
      parts.push({ role: 'user', parts: [{ text: finalPrompt }] });
      return parts;
    }

    function doDownloadDesignPng(rowIdx, blockIdx) {
      const block = designRows[rowIdx]?.[blockIdx];
      if (!block) return;
      if (block.imageOnly && block.img) {
        const a = document.createElement('a');
        a.href = block.img;
        a.download = `wava-design-${rowIdx}-${blockIdx}.png`;
        a.click();
        return;
      }
      const doc = previewIframe.contentDocument;
      if (!doc) return;
      const el = block.cardnewsSlide
        ? doc.querySelector(`.cardnews-slide[data-row="${rowIdx}"][data-block="${blockIdx}"]`)
        : doc.querySelector(`[data-row="${rowIdx}"][data-block="${blockIdx}"] .design-card-inner`);
      if (!el || typeof html2canvas === 'undefined') { alert('ìº¡ì²˜í•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      html2canvas(el, { useCORS: true, allowTaint: true, scale: 2, logging: false }).then(canvas => {
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wava-design-${rowIdx}-${blockIdx}.png`;
          a.click();
          URL.revokeObjectURL(url);
        }, 'image/png', 1);
      }).catch(err => { console.error(err); alert('PNG ë³€í™˜ ì‹¤íŒ¨'); });
    }
    function doDownloadDesignHtml(rowIdx, blockIdx) {
      const block = designRows[rowIdx]?.[blockIdx];
      if (!block || block.imageOnly) return;
      if (block.cardnewsSlide) {
        const { height: h, width: w } = getDimensionsForRatio('4:5');
        const safeBg = (url) => url || GEMINI_IMAGE_FALLBACK;
        const t = (block.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const body = (block.body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><style>html,body{font-family:'Pretendard',sans-serif;margin:0;padding:0;width:${w}px;height:${h}px;overflow:hidden;box-sizing:border-box;}*{box-sizing:border-box;}</style></head><body><div style="position:relative;height:100%;width:100%;background:url('${safeBg(block.imageUrl)}') center/cover;"><div style="position:absolute;inset:0;background:linear-gradient(to bottom, transparent 30%, rgba(0,0,0,0.5) 100%);"></div><div style="position:absolute;bottom:0;left:0;right:0;padding:32px 24px;"><h2 style="margin:0 0 12px;font-size:24px;font-weight:700;color:#fff;">${t}</h2><p style="margin:0;font-size:15px;color:rgba(255,255,255,0.95);line-height:1.6;">${body}</p></div></div></body></html>`;
        const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `wava-cardnews-${rowIdx}-${blockIdx}.html`;
        a.click();
        URL.revokeObjectURL(a.href);
        return;
      }
      const ratio = getCurrentAspectRatio();
      const { width: w, height: h } = getDimensionsForRatio(ratio);
      const safeBg = (url) => url || GEMINI_IMAGE_FALLBACK;
      const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"><style>html,body{margin:0;padding:0;width:${w}px;height:${h}px;font-family:'Pretendard',sans-serif;overflow:hidden;box-sizing:border-box;}*{box-sizing:border-box;}</style></head><body><div style="background:url('${safeBg(block.bg)}') center/cover;height:${h}px;width:100%;padding:24px;display:flex;flex-direction:column;justify-content:center;box-sizing:border-box;">${block.overlay}</div></body></html>`;
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `wava-design-${rowIdx}-${blockIdx}.html`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    window.__wavaDownloadPng = doDownloadDesignPng;
    window.__wavaDownloadHtml = doDownloadDesignHtml;

    function selectDesign(rowIdx, blockIdx) {
      const same = selectedDesign && selectedDesign.rowIdx === rowIdx && selectedDesign.blockIdx === blockIdx;
      selectedDesign = same ? null : { rowIdx, blockIdx };
      const panel = document.getElementById('design-edit-panel');
      if (panel) panel.classList.toggle('hidden', !selectedDesign);
      if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
    }
    window.__wavaSelectDesign = selectDesign;

    const canvasScrollArea = document.getElementById('canvas-scroll-area');
    const canvasZoomWrapper = document.getElementById('canvas-zoom-wrapper');
    const canvasZoomOuter = document.getElementById('canvas-zoom-outer');
    const canvasTitleEl = document.getElementById('canvas-title');
    let spacePressed = false;
    let isPanning = false;
    let lastPanX = 0, lastPanY = 0;
    function isInputFocused() {
      const el = document.activeElement;
      return el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable);
    }
    function applyCanvasZoom() {
      if (!canvasZoomWrapper) return;
      canvasZoomWrapper.style.transform = `scale(${canvasZoom})`;
      if (canvasZoomOuter) {
        const cw = canvasZoomWrapper.scrollWidth || canvasZoomWrapper.offsetWidth;
        const ch = canvasZoomWrapper.scrollHeight || canvasZoomWrapper.offsetHeight;
        if (cw > 0 && ch > 0) {
          canvasZoomOuter.style.width = (cw * canvasZoom) + 'px';
          canvasZoomOuter.style.height = (ch * canvasZoom) + 'px';
        }
      }
    }
    const canvasPanOverlay = document.getElementById('canvas-pan-overlay');
    function setPanOverlayActive(active) {
      if (!canvasPanOverlay) return;
      canvasPanOverlay.style.pointerEvents = active ? 'auto' : 'none';
      canvasPanOverlay.classList.toggle('cursor-grab', active && !isPanning);
      canvasPanOverlay.classList.toggle('cursor-grabbing', active && isPanning);
    }
    function doPan(dx, dy) {
      if (!canvasScrollArea) return;
      canvasScrollArea.scrollLeft -= dx;
      canvasScrollArea.scrollTop -= dy;
    }
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !isInputFocused()) {
        e.preventDefault();
        spacePressed = true;
        setPanOverlayActive(true);
      }
    });
    document.addEventListener('keyup', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        spacePressed = false;
        isPanning = false;
        setPanOverlayActive(false);
      }
    });
    canvasScrollArea?.addEventListener('mousedown', (e) => {
      if (spacePressed && e.button === 0) {
        isPanning = true;
        lastPanX = e.clientX;
        lastPanY = e.clientY;
        canvasPanOverlay?.classList.remove('cursor-grab');
        canvasPanOverlay?.classList.add('cursor-grabbing');
      }
    });
    canvasScrollArea?.addEventListener('mousemove', (e) => {
      if (isPanning) {
        e.preventDefault();
        const dx = e.clientX - lastPanX;
        const dy = e.clientY - lastPanY;
        lastPanX = e.clientX;
        lastPanY = e.clientY;
        doPan(dx, dy);
      }
    });
    canvasPanOverlay?.addEventListener('mousedown', (e) => {
      if (spacePressed && e.button === 0) {
        e.preventDefault();
        isPanning = true;
        lastPanX = e.clientX;
        lastPanY = e.clientY;
        canvasPanOverlay?.classList.remove('cursor-grab');
        canvasPanOverlay?.classList.add('cursor-grabbing');
      }
    });
    canvasPanOverlay?.addEventListener('mousemove', (e) => {
      if (isPanning) {
        e.preventDefault();
        const dx = e.clientX - lastPanX;
        const dy = e.clientY - lastPanY;
        lastPanX = e.clientX;
        lastPanY = e.clientY;
        doPan(dx, dy);
      }
    });
    canvasPanOverlay?.addEventListener('mouseup', (e) => {
      if (e.button === 0) { isPanning = false; canvasPanOverlay?.classList.remove('cursor-grabbing'); if (spacePressed) canvasPanOverlay?.classList.add('cursor-grab'); }
    });
    canvasPanOverlay?.addEventListener('mouseleave', () => {
      if (isPanning) { isPanning = false; canvasPanOverlay?.classList.remove('cursor-grabbing'); if (spacePressed) canvasPanOverlay?.classList.add('cursor-grab'); }
    });
    const stopPanning = () => {
      if (isPanning) {
        isPanning = false;
        canvasPanOverlay?.classList.remove('cursor-grabbing');
      }
      if (spacePressed) {
        canvasPanOverlay?.classList.add('cursor-grab');
      }
      setPanOverlayActive(spacePressed);
    };
    canvasScrollArea?.addEventListener('mouseup', (e) => {
      if (e.button === 0) stopPanning();
    });
    document.addEventListener('mouseup', () => {
      stopPanning();
    });
    canvasScrollArea?.addEventListener('mouseleave', () => {
      if (!isPanning) return;
      stopPanning();
    });
    function handleCanvasWheel(e) {
      if (!e.ctrlKey) return;
      e.preventDefault();
      e.stopPropagation();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      canvasZoom = Math.max(0.1, Math.min(3, canvasZoom + delta));
      applyCanvasZoom();
    }
    document.addEventListener('wheel', (e) => {
      if (!e.ctrlKey) return;
      if (!e.target.closest('main')) return;
      handleCanvasWheel(e);
    }, { passive: false, capture: true });
    function attachIframeWheelListener() {
      try {
        const doc = previewIframe?.contentDocument;
        if (doc && doc.body && !doc.documentElement.dataset.wheelAttached) {
          doc.documentElement.dataset.wheelAttached = '1';
          doc.addEventListener('wheel', handleCanvasWheel, { passive: false, capture: true });
        }
      } catch (_) {}
    }
    previewIframe?.addEventListener('load', attachIframeWheelListener);
    if (previewIframe?.contentDocument?.body) attachIframeWheelListener();
    document.getElementById('tool-zoom-in')?.addEventListener('click', () => {
      canvasZoom = Math.min(3, canvasZoom + 0.2);
      applyCanvasZoom();
    });
    document.getElementById('tool-zoom-out')?.addEventListener('click', () => {
      canvasZoom = Math.max(0.1, canvasZoom - 0.2);
      applyCanvasZoom();
    });
    document.getElementById('tool-undo')?.addEventListener('click', () => { doDesignUndo(); });
    document.getElementById('tool-redo')?.addEventListener('click', () => { doDesignRedo(); });
    window.addEventListener('resize', () => { if (designRows.length > 0) fitCanvasToView(); });
    window.addEventListener('beforeunload', () => { if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory(); });
    document.getElementById('history-search')?.addEventListener('input', () => renderCanvasHistory());
    document.getElementById('history-search-overlay')?.addEventListener('input', () => renderCanvasHistory());

    const taskListOverlay = document.getElementById('task-list-overlay');
    const taskListMenuBtn = document.getElementById('task-list-menu-btn');
    const taskListCloseBtn = document.getElementById('task-list-close-btn');
    const taskListOverlayBackdrop = document.getElementById('task-list-overlay-backdrop');
    taskListMenuBtn?.addEventListener('click', () => {
      renderCanvasHistory();
      taskListOverlay?.classList.remove('hidden');
    });
    taskListCloseBtn?.addEventListener('click', () => taskListOverlay?.classList.add('hidden'));
    taskListOverlayBackdrop?.addEventListener('click', () => taskListOverlay?.classList.add('hidden'));
    document.getElementById('task-list-new-folder-btn')?.addEventListener('click', () => {
      if (activeMenu !== 'image' && activeMenu !== 'cardnews' && activeMenu !== 'video') return;
      showNewFolderModal(() => {
        renderCanvasHistory();
        renderFolderItemsInCanvas();
      });
    });

    const navSidebarToggle = document.getElementById('nav-sidebar-toggle');
    function toggleSidebar() {
      sidebarCollapsed = !sidebarCollapsed;
      contextualSidebar?.classList.toggle('sidebar-collapsed', sidebarCollapsed);
      navSidebarToggle?.setAttribute('title', sidebarCollapsed ? 'ì‘ì—… ëª©ë¡ í¼ì¹˜ê¸°' : 'ì‘ì—… ëª©ë¡ ì ‘ê¸°');
      if (designRows.length > 0) setTimeout(fitCanvasToView, 280);
    }
    navSidebarToggle?.addEventListener('click', toggleSidebar);

    const SIDEBAR_WIDTH_KEY = 'wava_sidebar_width';
    const sidebarResizeHandle = document.getElementById('sidebar-resize-handle');
    (function initSidebarResize() {
      const saved = localStorage.getItem(SIDEBAR_WIDTH_KEY);
      if (saved) {
        const w = parseInt(saved, 10);
        if (w >= 240 && w <= 500 && contextualSidebar) contextualSidebar.style.width = w + 'px';
      }
      if (!sidebarResizeHandle || !contextualSidebar) return;
      let resizing = false, startX = 0, startW = 0;
      sidebarResizeHandle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        resizing = true;
        startX = e.clientX;
        startW = contextualSidebar.offsetWidth;
        contextualSidebar.classList.add('sidebar-resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      });
      document.addEventListener('mousemove', (e) => {
        if (!resizing) return;
        const dx = e.clientX - startX;
        let w = Math.max(240, Math.min(500, startW + dx));
        contextualSidebar.style.width = w + 'px';
      });
      document.addEventListener('mouseup', () => {
        if (!resizing) return;
        resizing = false;
        contextualSidebar.classList.remove('sidebar-resizing');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        try { localStorage.setItem(SIDEBAR_WIDTH_KEY, String(contextualSidebar.offsetWidth)); } catch (_) {}
        if (designRows.length > 0) setTimeout(fitCanvasToView, 0);
      });
    })();

    canvasListPanel?.addEventListener('click', (e) => {
      if (e.target.closest('[data-menu-trigger], .history-item-dropdown')) return;
      const target = e.target.closest('[data-history-idx]');
      if (!target) return;
      const idx = parseInt(target.getAttribute('data-history-idx'), 10);
      const list = activeMenu === 'chat' ? taskListChat : (activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage));
      const item = list[idx];
      if (!item) return;
      if (activeMenu === 'chat') {
        taskListChat.forEach(i => delete i.id);
        item.id = 'current';
        aiChatHistory = Array.isArray(item.messages) ? JSON.parse(JSON.stringify(item.messages)) : [];
        designRules.chat = Array.isArray(item.designRules) ? [...item.designRules] : [];
        renderAiChatMessages();
        renderChatRulesPanel();
        try { localStorage.setItem(TASK_LIST_KEYS.chat, JSON.stringify(taskListChat.slice(0, MAX_HISTORY_ITEMS))); } catch (_) {}
        return;
      }
      const prevCurrent = canvasHistory.find(i => i.id === 'current');
      if (prevCurrent && prevCurrent !== item) {
        prevCurrent.designRows = designRows.length > 0 ? JSON.parse(JSON.stringify(designRows)) : prevCurrent.designRows;
        if (Array.isArray(chatHistory)) prevCurrent.chatHistory = JSON.parse(JSON.stringify(chatHistory));
        prevCurrent.designRules = JSON.parse(JSON.stringify(getDesignRulesForMode()));
      }
      if (item.id !== 'current') {
        canvasHistory.forEach(i => delete i.id);
        item.id = 'current';
      }
      canvasTitle = item.title;
      if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
      designRows = Array.isArray(item.designRows) && item.designRows.length > 0 ? JSON.parse(JSON.stringify(item.designRows)) : [];
      chatHistory = Array.isArray(item.chatHistory) && item.chatHistory.length > 0 ? JSON.parse(JSON.stringify(item.chatHistory)) : [];
      const rules = Array.isArray(item.designRules) ? item.designRules : [];
      if (activeMenu === 'cardnews') designRules.cardnews = [...rules];
      else designRules.image = [...rules];
      renderDesignChatMessages();
      renderDesignRulesPanel();
      saveCanvasHistory();
      renderCanvasHistory();
      if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
      else previewIframe.srcdoc = buildRowsDisplayHtml() || '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
      document.getElementById('task-list-overlay')?.classList.add('hidden');
    });
    document.getElementById('canvas-list-panel-overlay')?.addEventListener('click', (e) => {
      if (e.target.closest('[data-menu-trigger], .history-item-dropdown')) return;
      const target = e.target.closest('[data-history-idx]');
      if (!target) return;
      const idx = parseInt(target.getAttribute('data-history-idx'), 10);
      const list = activeMenu === 'cardnews' ? taskListCardnews : (activeMenu === 'video' ? taskListVideo : taskListImage);
      const item = list[idx];
      if (!item) return;
      const prevCurrent = canvasHistory.find(i => i.id === 'current');
      if (prevCurrent && prevCurrent !== item) {
        prevCurrent.designRows = designRows.length > 0 ? JSON.parse(JSON.stringify(designRows)) : prevCurrent.designRows;
        if (Array.isArray(chatHistory)) prevCurrent.chatHistory = JSON.parse(JSON.stringify(chatHistory));
        prevCurrent.designRules = JSON.parse(JSON.stringify(getDesignRulesForMode()));
        if (activeMenu === 'video') delete prevCurrent.videoOptions;
      }
      if (item.id !== 'current') {
        canvasHistory.forEach(i => delete i.id);
        item.id = 'current';
      }
      canvasTitle = item.title;
      if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
      if (activeMenu === 'video') {
        designRows = [];
        chatHistory = Array.isArray(item.chatHistory) && item.chatHistory.length > 0 ? JSON.parse(JSON.stringify(item.chatHistory)) : [];
        designRules.video = Array.isArray(item.designRules) ? [...item.designRules] : [];
        currentVideoJobId = item.videoJobId || null;
        if (currentVideoJobId) startVideoPolling(currentVideoJobId);
        else setVideoPreviewHtml('<div style="color:#9ca3af;font-size:14px;font-weight:600;">ì˜ìƒ ìƒì„± ëŒ€ê¸°</div>');
        renderDesignChatMessages();
      } else {
        designRows = Array.isArray(item.designRows) && item.designRows.length > 0 ? JSON.parse(JSON.stringify(item.designRows)) : [];
        chatHistory = Array.isArray(item.chatHistory) && item.chatHistory.length > 0 ? JSON.parse(JSON.stringify(item.chatHistory)) : [];
        const rules = Array.isArray(item.designRules) ? item.designRules : [];
        if (activeMenu === 'cardnews') designRules.cardnews = [...rules];
        else designRules.image = [...rules];
        if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
        else previewIframe.srcdoc = buildRowsDisplayHtml() || '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>';
      }
      renderDesignRulesPanel();
      saveCanvasHistory();
      renderCanvasHistory();
      if (activeMenu !== 'video') renderDesignChatMessages();
      document.getElementById('task-list-overlay')?.classList.add('hidden');
    });
    canvasTitleEditBtn?.addEventListener('click', () => {
      if (!canvasTitleInput || !canvasTitleEl) return;
      canvasTitleInput.value = canvasTitle;
      canvasTitleEl.classList.add('hidden');
      canvasTitleEditBtn.classList.add('hidden');
      canvasTitleInput.classList.remove('hidden');
      canvasTitleInput.focus();
      canvasTitleInput.select();
    });
    canvasTitleInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        canvasTitleInput.blur();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        canvasTitleInput.value = canvasTitle;
        canvasTitleInput.blur();
      }
    });
    canvasTitleInput?.addEventListener('blur', () => {
      if (!canvasTitleInput || !canvasTitleEl) return;
      const next = canvasTitleInput.value.trim() || 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°';
      canvasTitle = next;
      canvasTitleEl.textContent = canvasTitle;
      canvasTitleEl.classList.remove('hidden');
      canvasTitleEditBtn?.classList.remove('hidden');
      canvasTitleInput.classList.add('hidden');
      upsertCanvasHistory(canvasTitle);
    });

    const designEditPanel = document.getElementById('design-edit-panel');
    const redesignInput = document.getElementById('redesign-input');
    document.getElementById('edit-text-btn')?.addEventListener('click', () => {
      if (!selectedDesign) return;
      redesignInput?.focus();
      if (redesignInput) redesignInput.placeholder = 'ìˆ˜ì •í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: L1 ë¬¸êµ¬ êµì²´)';
      addSystemMessage('í…ìŠ¤íŠ¸ í¸ì§‘ ëª¨ë“œ: ìˆ˜ì •í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥ í›„ ì „ì†¡í•˜ì„¸ìš”.');
    });
    document.getElementById('edit-toolbox-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('toolbox-dropdown')?.classList.toggle('hidden');
      document.getElementById('element-dropdown')?.classList.add('hidden');
    });
    document.getElementById('edit-add-element-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('element-dropdown')?.classList.toggle('hidden');
      document.getElementById('toolbox-dropdown')?.classList.add('hidden');
    });
    document.querySelectorAll('#element-dropdown button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('element-dropdown')?.classList.add('hidden');
        if (!selectedDesign) return;
        const type = btn.dataset.element;
        if (type === 'text') redesignInput.value = 'í…ìŠ¤íŠ¸ ì¶”ê°€: ';
        if (type === 'image') redesignInput.value = 'ì´ë¯¸ì§€ ì¶”ê°€: ';
        if (type === 'draw') redesignInput.value = 'ê·¸ë¦¬ê¸° ì¶”ê°€: ';
        redesignInput?.focus();
      });
    });
    document.querySelectorAll('#toolbox-dropdown button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('toolbox-dropdown')?.classList.add('hidden');
        if (!selectedDesign) return;
        const tool = btn.dataset.tool;
        const toolMap = {
          'bg-remove': 'ë°°ê²½ ì œê±°í•´ì¤˜',
          'magic-erase': 'ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì§€ì›Œì¤˜',
          'magic-draw': 'í•´ë‹¹ ì˜ì—­ ë‹¤ì‹œ ê·¸ë ¤ì¤˜',
          'style-lock': 'ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•œ ì±„ ê¹¨ë—í•˜ê²Œ ë³´ì •í•´ì¤˜',
          'img-extend': 'ì´ë¯¸ì§€ ê°€ì¥ìë¦¬ í™•ì¥í•´ì¤˜',
          'color-variant': 'ìƒ‰ìƒ ë³€í˜•í•´ì¤˜'
        };
        redesignInput.value = toolMap[tool] || '';
        redesignInput?.focus();
      });
    });
    document.getElementById('edit-export-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const dd = document.getElementById('export-dropdown');
      if (dd) dd.classList.toggle('hidden');
    });
    document.querySelectorAll('#export-dropdown button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('export-dropdown')?.classList.add('hidden');
        if (!selectedDesign) return;
        const { rowIdx, blockIdx } = selectedDesign;
        const fmt = btn.dataset.export;
        if (fmt === 'png') doDownloadDesignPng(rowIdx, blockIdx);
        else if (fmt === 'html') doDownloadDesignHtml(rowIdx, blockIdx);
        else if (fmt === 'pdf') {
          const block = designRows[rowIdx]?.[blockIdx];
          if (!block) return;
          const doc = previewIframe.contentDocument;
          const el = doc?.querySelector(`[data-row="${rowIdx}"][data-block="${blockIdx}"] .design-card-inner`);
          if (el && typeof html2canvas !== 'undefined' && window.jspdf) {
            html2canvas(el, { useCORS: true, allowTaint: true, scale: 2, logging: false }).then(canvas => {
              const imgData = canvas.toDataURL('image/png');
              const jsPDF = window.jspdf.jsPDF || (window.jspdf.default && window.jspdf.default.jsPDF) || window.jspdf;
              const pdf = new jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
              pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
              pdf.save(`wava-design-${rowIdx}-${blockIdx}.pdf`);
            }).catch(() => addSystemMessage('PDF ë³€í™˜ ì‹¤íŒ¨'));
          } else if (block.imageOnly && block.img) {
            const img = new Image();
            img.onload = () => {
              const jsPDF = window.jspdf.jsPDF || (window.jspdf.default && window.jspdf.default.jsPDF) || window.jspdf;
              const pdf = new jsPDF({ orientation: img.width > img.height ? 'landscape' : 'portrait', unit: 'px', format: [img.width, img.height] });
              pdf.addImage(block.img, 'PNG', 0, 0, img.width, img.height);
              pdf.save(`wava-design-${rowIdx}-${blockIdx}.pdf`);
            };
            img.src = block.img;
          } else addSystemMessage('PDF ë‚´ë³´ë‚´ê¸°ëŠ” HTML ëª¨ë“œ ë˜ëŠ” ì´ë¯¸ì§€ ì‹œì•ˆì—ì„œ ì§€ì›ë©ë‹ˆë‹¤.');
        }
      });
    });
    document.addEventListener('click', () => {
      document.getElementById('export-dropdown')?.classList.add('hidden');
      document.getElementById('element-dropdown')?.classList.add('hidden');
      document.getElementById('toolbox-dropdown')?.classList.add('hidden');
    });
    document.getElementById('edit-delete-btn')?.addEventListener('click', () => {
      if (!selectedDesign) return;
      const { rowIdx, blockIdx } = selectedDesign;
      designRows[rowIdx]?.splice(blockIdx, 1);
      if (designRows[rowIdx]?.length === 0) designRows.splice(rowIdx, 1);
      selectedDesign = null;
      designEditPanel?.classList.add('hidden');
      renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
      addSystemMessage('ì„ íƒí•œ ë””ìì¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
    const SELECTION_HINTS = ['ì²« ë²ˆì§¸', 'ë‘ ë²ˆì§¸', 'ì„¸ ë²ˆì§¸', 'ë„¤ ë²ˆì§¸', 'ë‹¤ì„¯ ë²ˆì§¸'];
    document.getElementById('redesign-send-btn')?.addEventListener('click', () => {
      const text = redesignInput?.value?.trim();
      if (!text) return;
      if (!selectedDesign) { addSystemMessage('ë¨¼ì € í¸ì§‘í•  ë””ìì¸ì„ í´ë¦­í•´ ì„ íƒí•˜ì„¸ìš”.'); return; }
      redesignInput.value = '';
      const flatIdx = designRows.slice(0, selectedDesign.rowIdx).reduce((s, r) => s + r.length, 0) + selectedDesign.blockIdx;
      const hint = SELECTION_HINTS[flatIdx] || (flatIdx + 1) + 'ë²ˆì§¸';
      sendToGemini(hint + ' ì‹œì•ˆ ' + text, { fromRedesign: true });
    });
    redesignInput?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('redesign-send-btn')?.click(); }
    });

    refreshBtn?.addEventListener('click', () => {
      if (designRows.length > 0) renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
      else if (lastGeneratedHtml) renderHtml(lastGeneratedHtml);
    });

    document.getElementById('reset-btn')?.addEventListener('click', () => {
      if (!confirm('ì±„íŒ… ê¸°ë¡ê³¼ ë””ìì¸ì„ ëª¨ë‘ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return;
      chatHistory = [];
      pendingDesignPrompt = null;
      designRows = [];
      designUndoStack = [];
      designRedoStack = [];
      if (activeMenu === 'cardnews') designRules.cardnews = [];
      else if (activeMenu === 'video') designRules.video = [];
      else designRules.image = [];
      lastGeneratedHtml = '';
      lastBackgroundImageUrl = null;
      canvasTitle = activeMenu === 'cardnews' ? 'ì¹´ë“œë‰´ìŠ¤ ë¯¸ë¦¬ë³´ê¸°' : (activeMenu === 'video' ? 'ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°' : 'ê´‘ê³  ì†Œì¬ ë¯¸ë¦¬ë³´ê¸°');
      selectedDesign = null;
      if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
      designEditPanel?.classList.add('hidden');
      document.getElementById('cardnews-toolbar')?.classList.add('hidden');
      // video-toolbar removed
      chatContainer.innerHTML = '';
      previewIframe.srcdoc = activeMenu === 'video' ? (setVideoPreviewHtml('<div style="color:#9ca3af;font-size:14px;font-weight:600;">ì˜ìƒ ìƒì„± ëŒ€ê¸°</div>'), previewIframe.srcdoc) : (buildRowsDisplayHtml() || '<!DOCTYPE html><html><body style="background:#e5e7eb;"></body></html>');
      renderDesignRulesPanel();
      upsertCanvasHistory(canvasTitle);
    });

    async function sendToGemini(prompt, options = {}) {
      const { fromRedesign = false, attachments = [] } = options;
      const apiKey = apiKeyInput.value.trim() || localStorage.getItem(STORAGE_KEY);
      if (!apiKey) { alert('Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      // ì˜ìƒ ëª¨ë“œ: í™•ì¸ ë‹¨ê³„ ìˆìŒ. skipConfirmationì´ë©´ ë°”ë¡œ Job ìƒì„±, ì•„ë‹ˆë©´ AIê°€ í•´ì„Â·ì œì•ˆ í›„ "ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?" ëŒ€ê¸°.
      if (activeMenu === 'video') {
        const raw = (prompt || '').trim();
        if (!raw) return;
        if (options.skipConfirmation) {
          addMessage(raw, true, []);
          chatHistory.push({ role: 'user', text: raw });
          if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
          const effectivePrompt = buildPromptWithRules(generateVideoPrompt({ prompt: raw, product: raw }));
          try {
            const created = await createVideoJob(effectivePrompt);
            currentVideoJobId = created?.id || null;
            chatHistory.push({ role: 'model', text: `[ì˜ìƒ] ì‘ì—…ì´ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n- Job ID: ${currentVideoJobId}\n- ìƒíƒœ: ${created?.status || 'pending'}\n\n(5ì´ˆë§ˆë‹¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤)` });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderDesignChatMessages();
            saveCanvasHistory();
            startVideoPolling(currentVideoJobId);
          } catch (e) {
            chatHistory.push({ role: 'model', text: `[ì˜ìƒ] ë°±ì—”ë“œ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.\n${e?.message || e}` });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderDesignChatMessages();
          }
          return;
        }
        if (isConfirmationRequest(prompt) && pendingDesignPrompt) {
          const stored = pendingDesignPrompt;
          pendingDesignPrompt = null;
          addMessage(prompt, true, []);
          chatHistory.push({ role: 'user', text: prompt });
          return sendToGemini(stored.prompt, { ...stored.options, attachments: stored.attachments || [], skipConfirmation: true });
        }
        addMessage(raw, true, []);
        chatHistory.push({ role: 'user', text: raw });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
        pendingDesignPrompt = { prompt: raw, attachments: [], options: { ...options, skipConfirmation: true } };
        addGeminiConversationalResponse(raw, apiKey, { isDesignRequest: true, askConfirmation: true });
        return;
      }

      // í™•ì¸ ì‘ë‹µ(ì˜ˆ/ë„¤ ë“±) + ëŒ€ê¸° ì¤‘ì¸ ë””ìì¸ ìš”ì²­ â†’ ì‹¤ì œ ìƒì„± ì§„í–‰
      if (isConfirmationRequest(prompt) && pendingDesignPrompt) {
        const stored = pendingDesignPrompt;
        pendingDesignPrompt = null;
        chatHistory.push({ role: 'user', text: prompt });
        return sendToGemini(stored.prompt, { ...stored.options, attachments: stored.attachments || [], skipConfirmation: true });
      }

      const isDesign = isDesignRequest(prompt) || fromRedesign || attachments.some(a => a.type?.startsWith('image/')) || (isCardnewsMode() && prompt.trim().length > 0) || (activeMenu === 'video' && prompt.trim().length > 0);
      const isModifyEarly = isModificationRequest(prompt);
      const isAddEarly = isAdditionRequest(prompt);
      const hasExistingDesigns = designRows.length > 0 && designRows.flat().length > 0;
      const allowImageModifyEarly = fromRedesign && selectedDesign && isImageOnlyMode() && hasExistingDesigns;
      const isRegenerateRequest = isImageOnlyMode() && (isModifyEarly || isAddEarly) && hasExistingDesigns && !allowImageModifyEarly;
      if (isRegenerateRequest) {
        addMessage(prompt, true, attachments);
        chatHistory.push({ role: 'user', text: prompt });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
      }
      if (!isDesign && attachments.length === 0) {
        chatHistory.push({ role: 'user', text: prompt });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
        const chatMsgEl = addLoadingChatMessage('ë‹µë³€ ìƒì„± ì¤‘...');
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
          const contents = chatHistory.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] }));
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, generationConfig: { temperature: 0.7, maxOutputTokens: 2048 } }) });
          const data = await res.json();
          if (!res.ok) throw new Error(parseGeminiError(data, 'API ìš”ì²­ ì‹¤íŒ¨'));
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          chatHistory.push({ role: 'model', text });
          if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
          updateLoadingChatMessage(chatMsgEl, text);
        } catch (e) {
          updateLoadingChatMessage(chatMsgEl, 'ì˜¤ë¥˜: ' + (e?.message || e));
        }
        if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') saveCanvasHistory();
        return;
      }

      // ë””ìì¸ ìš”ì²­ + í™•ì¸ ë‹¨ê³„ ë¯¸ì™„ë£Œ â†’ "ì´ë ‡ê²Œ ìƒì„±í•´ë“œë¦´ê¹Œìš”?" í›„ ëŒ€ê¸°
      // ìˆ˜ì •/ì¬ìƒì„± ìš”ì²­(isRegenerateRequest)ì€ í™•ì¸ ì—†ì´ ë°”ë¡œ ì¬ìƒì„± ì§„í–‰
      const skipConfirmation = options.skipConfirmation || fromRedesign || isRegenerateRequest;
      if (isDesign && !skipConfirmation && !isConfirmationRequest(prompt)) {
        chatHistory.push({ role: 'user', text: prompt });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
        pendingDesignPrompt = { prompt, attachments: attachments.slice(), options: { ...options, skipConfirmation: true } };
        addGeminiConversationalResponse(prompt, apiKey, { isDesignRequest: true, askConfirmation: true });
        return;
      }

      const isModify = isModificationRequest(prompt);
      const isAdd = isAdditionRequest(prompt);
      const multiCount = getMultiRequestCount(prompt);
      const parsedRequests = multiCount >= 2 ? parseMultiRequests(prompt, multiCount) : null;
      const useParallel = multiCount >= 2 && parsedRequests && parsedRequests.length >= 2;
      const aspectRatio = getCurrentAspectRatio();
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelSelect.value}:generateContent?key=${apiKey}`;

      let progress = 0;
      const progressInterval = setInterval(() => { if (progress < 90) { progress += Math.floor(Math.random() * 8) + 3; progress = Math.min(progress, 90); updateLoadingStatus('design', progress); } }, 400);

      if (!options.skipConfirmation) {
        chatHistory.push({ role: 'user', text: prompt });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
        addGeminiConversationalResponse(prompt, apiKey, { isDesignRequest: true, askConfirmation: false });
      } else if (fromRedesign) {
        addMessage(prompt, true, attachments);
        chatHistory.push({ role: 'user', text: prompt });
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
      }
      const isFirstUserMsg = !chatHistory.some(m => m.role === 'user');
      if (isFirstUserMsg && prompt.length > 0) {
        canvasTitle = prompt.length > 50 ? prompt.slice(0, 47) + '...' : prompt;
        if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
        upsertCanvasHistory(canvasTitle);
        summarizeAsTitle(prompt, apiKey).then(title => {
          if (title) {
            canvasTitle = title.slice(0, 50);
            if (canvasTitleEl) canvasTitleEl.textContent = canvasTitle;
            upsertCanvasHistory(canvasTitle);
            renderCanvasHistory();
          }
        });
      }
      let effectivePrompt = prompt;
      if (isRegenerateRequest) {
        const firstUser = chatHistory.filter(m => m.role === 'user')[0]?.text || canvasTitle;
        effectivePrompt = `${firstUser}\n\n[ìˆ˜ì • ìš”ì²­] ${prompt}`;
      } else if (isImageOnlyMode() && prompt.length < 300 && /ë¸Œë¦¬í”„|í•˜ê¸°|3ì•ˆ|ì‹œì•ˆ|ìƒì„±/i.test(prompt)) {
        const userMsgs = chatHistory.filter(m => m.role === 'user');
        const prevWithBrief = [...userMsgs].reverse().find(m => m.text && (m.text.includes('ë””ìì¸ ë¸Œë¦¬í”„') || m.text.includes('L1') || m.text.includes('L2') || m.text.length > 200));
        if (prevWithBrief?.text) effectivePrompt = prevWithBrief.text + '\n\n[ìš”ì²­] ' + prompt;
      }
      if (activeMenu === 'cardnews' || activeMenu === 'image') effectivePrompt = buildPromptWithRules(effectivePrompt);
      if (activeMenu === 'video') effectivePrompt = buildPromptWithRules(generateVideoPrompt({ prompt, product: prompt, action: '', background: '', movement: '' }));
      const isActualModifyOrAdd = (isModify || isAdd) && (designRows.length > 0 && designRows.flat().length > 0);
      const allowImageModify = fromRedesign && selectedDesign && isImageOnlyMode() && designRows.length > 0 && designRows.flat().length > 0;
      addSystemMessage(useParallel ? `${multiCount}ê°œ ë™ì‹œ ì‘ì—… ì¤‘...` : isModify ? 'ìˆ˜ì • ì¤‘...' : isAdd ? 'ì¶”ê°€ ì œì‘ ì¤‘...' : (activeMenu === 'video' ? 'ì˜ìƒ í”„ë¡¬í”„íŠ¸ ìƒì„±ë¨ (Veo API ì—°ë™ ì˜ˆì •)' : 'ë””ìì¸ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.'));

      try {
        pushDesignState();
        if (activeMenu === 'video') {
          try {
            const created = await createVideoJob(effectivePrompt);
            currentVideoJobId = created?.id || null;
            chatHistory.push({ role: 'model', text: `[ì˜ìƒ] ì‘ì—…ì´ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n- Job ID: ${currentVideoJobId}\n- ìƒíƒœ: ${created?.status || 'pending'}\n\n(5ì´ˆë§ˆë‹¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤)` });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderDesignChatMessages();
            saveCanvasHistory();
            startVideoPolling(currentVideoJobId);
          } catch (e) {
            chatHistory.push({ role: 'model', text: '[ì˜ìƒ] ë°±ì—”ë“œ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.\n' + (e?.message || e) });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderDesignChatMessages();
          } finally {
            clearInterval(progressInterval);
            hideLoadingBar();
          }
          return;
        }
        if (allowImageModify) {
          const { rowIdx, blockIdx } = selectedDesign;
          const userMsgs = chatHistory.filter(m => m.role === 'user');
          const origBrief = [...userMsgs].reverse().find(m => m.text && (m.text.includes('ë””ìì¸ ë¸Œë¦¬í”„') || m.text.includes('L1') || m.text.includes('L2') || m.text.length > 200))?.text || canvasTitle;
          const rulesArr = getDesignRulesForMode();
          const rulesBlock = rulesArr.length > 0 ? `\n=== SAVED RULES (always apply) ===\n${rulesArr.map(r => '- ' + r).join('\n')}\n=== END RULES ===\n\n` : '';
          const modPrompt = `Create a complete Korean web advertisement banner. SAME design as the original brief, but with this MODIFICATION applied.
${rulesBlock}=== ORIGINAL DESIGN BRIEF ===
${origBrief}
=== END ORIGINAL ===

=== MODIFICATION REQUEST (apply this change) ===
${prompt.replace(/^(ì²«|ë‘|ì„¸|ë„¤|ë‹¤ì„¯)\s*ë²ˆì§¸\s*ì‹œì•ˆ\s*/i, '').trim()}
=== END MODIFICATION ===

CRITICAL: Keep ALL other elements (text, colors, layout) the same. Only change what the modification requests. Do NOT add any new text. Use ONLY text from the original brief. Do NOT introduce unrelated products/people. Aspect: ${aspectRatio}. Output: One complete image. No HTML.`;
          updateLoadingStatus('design', 20);
          addSystemMessage('ì„ íƒí•œ ì‹œì•ˆ ìˆ˜ì • ì¤‘...');
          try {
            const newImg = await generateGeminiImage(apiKey, modPrompt, aspectRatio);
            designRows.push([{ imageOnly: true, img: newImg }]);
            selectedDesign = { rowIdx: designRows.length - 1, blockIdx: 0 };
            designEditPanel?.classList.remove('hidden');
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: '[ì´ë¯¸ì§€ ì „ìš©] ì„ íƒ ì‹œì•ˆ ìˆ˜ì • ì™„ë£Œ.' });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
          } catch (e) {
            addSystemMessage('ìˆ˜ì • ì‹¤íŒ¨: ' + (e?.message || e));
          }
          clearInterval(progressInterval);
          hideLoadingBar();
          addSystemMessage('ì„ íƒí•œ ì‹œì•ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          return;
        }
        if (isCardnewsMode()) {
          const hasCardnews = designRows?.flat().some(b => b?.cardnewsSlide);
          const isCardnewsRegen = hasCardnews && isCardnewsImageRegenRequest(prompt);
          if (isCardnewsRegen) {
            const slideIdx = parseCardnewsSlideIndex(prompt);
            const flatSlides = designRows.flat().filter(b => b?.cardnewsSlide);
            const orig = flatSlides[slideIdx];
            if (orig) {
              pushDesignState();
              updateLoadingStatus('design', 20);
              addSystemMessage(`${slideIdx + 1}ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ ë°°ê²½ ì´ë¯¸ì§€ ì¬ìƒì„± ì¤‘...`);
              try {
                const imgPrompt = orig.imagePrompt || `Soft gradient background, modern minimal style, suitable for card news slide ${slideIdx + 1}`;
                const firstSlidePrompt = slideIdx === 0 ? 'Dark moody cinematic atmosphere. ' : '';
                const imageUrl = await generateGeminiImage(apiKey, `Create a photorealistic background image. NO text. 4:5 vertical Instagram style. ${firstSlidePrompt}${imgPrompt}\n\n[ìˆ˜ì • ìš”ì²­] ${prompt}`, '4:5');
                const modifiedSlide = JSON.parse(JSON.stringify(orig));
                modifiedSlide.imageUrl = imageUrl;
                designRows.push([modifiedSlide]);
                chatHistory.push({ role: 'user', text: prompt });
                chatHistory.push({ role: 'model', text: `[ì¹´ë“œë‰´ìŠ¤] ${slideIdx + 1}ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ì¬ìƒì„± ì™„ë£Œ. 2í–‰ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.` });
                if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
                renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
                attachCardnewsContentEditable();
                upsertCanvasHistory(canvasTitle);
                addSystemMessage(`${slideIdx + 1}ë²ˆì§¸ ìŠ¬ë¼ì´ë“œê°€ 2í–‰ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              } catch (e) {
                addSystemMessage('ì´ë¯¸ì§€ ì¬ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e));
              }
              clearInterval(progressInterval);
              hideLoadingBar();
              return;
            }
          }
          updateLoadingStatus('design', 5);
          addSystemMessage('ì¹´ë“œë‰´ìŠ¤ ê¸°íšì•ˆ ìƒì„± ì¤‘...');
          const fetchCardnewsJson = async (promptText) => {
            const jsonUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const jsonBody = {
              contents: [{ role: 'user', parts: [{ text: promptText }] }],
              generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
            };
            const jsonRes = await fetch(jsonUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jsonBody) });
            const jsonData = await jsonRes.json();
            if (!jsonRes.ok) throw new Error(parseGeminiError(jsonData, 'JSON ìƒì„± ì‹¤íŒ¨'));
            let jsonText = jsonData.candidates?.[0]?.content?.parts?.[0]?.text || '';
            jsonText = jsonText.replace(/```json\s*|\s*```/g, '').trim();
            return tryParseCardnewsJson(jsonText);
          };
          const cardnewsSlideCount = getCardnewsSlideCount(effectivePrompt);
          const cardnewsPrompt = buildCardnewsJsonPrompt(cardnewsSlideCount);
          try {
            let parsed;
            try {
              parsed = await fetchCardnewsJson(`${cardnewsPrompt}\n\n[ì£¼ì œ]\n${effectivePrompt}`);
            } catch (parseErr) {
              addSystemMessage('JSON íŒŒì‹± ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘...');
              parsed = await fetchCardnewsJson(`${cardnewsPrompt}\n\n[ì£¼ì œ]\n${effectivePrompt}\n\nIMPORTANT: Output compact valid JSON. Keep imagePrompt under 60 chars.`);
            }
            const slides = Array.isArray(parsed.slides) ? parsed.slides : [];
            if (slides.length === 0) throw new Error('ì¹´ë“œë‰´ìŠ¤ ìŠ¬ë¼ì´ë“œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            designRows = slides.map((s, i) => [{ cardnewsSlide: true, title: s.title || '', body: s.body || '', imageUrl: 'loading', imagePrompt: s.imagePrompt, slideIndex: i }]);
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: `[ì¹´ë“œë‰´ìŠ¤] ${slides.length}ì¥ ê¸°íšì•ˆ ìƒì„± ì™„ë£Œ. ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì¤‘...` });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            attachCardnewsContentEditable();
            addSystemMessage('í…ìŠ¤íŠ¸ ê¸°íšì•ˆì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ìˆœì„œëŒ€ë¡œ ìƒì„± ì¤‘...');
            for (let i = 0; i < slides.length; i++) {
              const s = slides[i];
              const imgPrompt = s.imagePrompt || `Soft gradient background, modern minimal style, suitable for card news slide ${i + 1}`;
              updateLoadingStatus('design', 20 + Math.floor((i / slides.length) * 75));
              let imageUrl = GEMINI_IMAGE_FALLBACK;
              const firstSlidePrompt = i === 0 ? 'Dark moody cinematic atmosphere. ' : '';
              try {
                imageUrl = await generateGeminiImage(apiKey, `Create a photorealistic background image. NO text. 4:5 vertical Instagram style. ${firstSlidePrompt}${imgPrompt}`, '4:5');
                if (i > 0) await sleep(IMAGE_REQUEST_DELAY_MS || 800);
              } catch (e) {
                addSystemMessage(`ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ${e?.message || e}`);
              }
              designRows[i][0].imageUrl = imageUrl;
              renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
              attachCardnewsContentEditable();
            }
            chatHistory.push({ role: 'model', text: `[ì¹´ë“œë‰´ìŠ¤] ${slides.length}ì¥ ìƒì„± ì™„ë£Œ.` });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            upsertCanvasHistory(canvasTitle);
            addSystemMessage(`${slides.length}ì¥ ì¹´ë“œë‰´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } catch (e) {
            addSystemMessage('ì¹´ë“œë‰´ìŠ¤ ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e));
            console.error(e);
          }
          clearInterval(progressInterval);
          hideLoadingBar();
          return;
        }
        if (isImageOnlyMode()) {
          updateLoadingStatus('design', 10);
          addSystemMessage('Gemini ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
          const explicitCount = getImageRequestCount(effectivePrompt);
          const defaultCount = isAdStyleRequest(effectivePrompt) ? 3 : 1;
          const reqCount = explicitCount || (multiCount >= 2 ? multiCount : defaultCount);
          const wantsNoText = /í…ìŠ¤íŠ¸\s*ì—†|í…ìŠ¤íŠ¸\s*ì‚­ì œ|ê¸€ì\s*ì—†|ë¬¸êµ¬\s*ì—†|ìº¡ì…˜\s*ì—†|í…ìŠ¤íŠ¸\s*ì œê±°|ê¸€ì”¨\s*ì—†/i.test(effectivePrompt);
          const needsText = !wantsNoText && isAdStyleRequest(effectivePrompt);
          const imgPrompt = needsText
            ? `Create a complete Korean web advertisement banner as a single, high-quality image. Describe and render the scene following the design brief exactly.

=== DESIGN BRIEF (ë°˜ë“œì‹œ ì •í™•íˆ ë”°ë¥¼ ê²ƒ) ===
${effectivePrompt}
=== END DESIGN BRIEF ===

CRITICAL: Include ONLY the text explicitly specified in the brief. NEVER add any text not in the user's request. Aspect: ${aspectRatio}. Output: One photorealistic ad image. No HTML.`
            : `Create a single high-quality photorealistic image. NO text, NO overlay, NO captions, NO slogans, NO buttons. Just the image itself.

=== USER REQUEST (ë°˜ë“œì‹œ ë”°ë¥¼ ê²ƒ) ===
${effectivePrompt}
=== END REQUEST ===

CRITICAL: Pure image only. Zero text. No words, letters, or typography. Aspect: ${aspectRatio}. Output: One photorealistic image. No HTML.`;

          const count = useParallel && parsedRequests ? parsedRequests.length : (multiCount >= 2 ? multiCount : reqCount);
          const variationHints = ['[Variation 1 - Trend Design] Modern, dynamic layout. Same content, different visual style.', '[Variation 2 - Premium Design] Elegant, premium feel. Same content, different layout and color accents.', '[Variation 3 - Direct Creative] Bold, direct messaging. Same content, different composition.'];
          const prompts = useParallel && parsedRequests
            ? parsedRequests.map((r) => `[MANDATORY] Create Korean web ad as SINGLE image. SAME design brief for ALL - only vary layout/colors. Use ONLY text from the brief - NEVER add extra text. Follow:\n---\n${r}\n---\nAspect: ${aspectRatio}.`)
            : Array(count).fill(null).map((_, i) => count > 1
              ? imgPrompt + `\n\nIMPORTANT: This is variation ${i + 1} of ${count}. ALL ${count} images must have the SAME content (same offer, same text, same product). Only vary: layout, color scheme, visual style. ${variationHints[i] || `Variation ${i + 1} style.`}`
              : imgPrompt);

          const results = [];
          for (let i = 0; i < prompts.length; i++) {
            if (i > 0 && isImageOnlyMode()) await sleep(IMAGE_REQUEST_DELAY_MS);
            updateLoadingStatus('design', 20 + Math.floor((i / prompts.length) * 60));
            try {
              const img = await generateGeminiImage(apiKey, prompts[i], aspectRatio);
              results.push({ imageOnly: true, img });
            } catch (e) {
              addSystemMessage(`ì‹œì•ˆ ${i + 1} ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ${e?.message || e}`);
            }
          }
          if (results.length > 0) {
            designRows = useParallel && parsedRequests ? results.map(r => [r]) : [results];
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: '[ì´ë¯¸ì§€ ì „ìš© ëª¨ë“œ] ' + results.length + 'ê°œ ì‹œì•ˆ ìƒì„± ì™„ë£Œ.' });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
          } else {
            addSystemMessage('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          clearInterval(progressInterval);
          hideLoadingBar();
          addSystemMessage(results.length > 0 ? `${results.length}ê°œ ì´ë¯¸ì§€ ì‹œì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.` : 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        let backgroundImageUrl = lastBackgroundImageUrl;
        const shouldGenBg = !isModify && !isAdd && !useParallel || (isModify && needsBackgroundRegeneration(prompt));
        if (shouldGenBg) {
          try {
            updateLoadingStatus('bg', 25);
            const imagePrompt = `Create a unique, custom background/main image for a Korean web advertisement. Aspect ratio: ${aspectRatio}.

[í•„ìˆ˜ ìš”ì²­ ë‚´ìš© - ë°˜ë“œì‹œ ì •í™•íˆ ë”°ë¥¼ ê²ƒ]
${prompt}

Output: Single high-quality photorealistic image. Avoid generic stock-photo look. Create distinctive, on-brand imagery. Suitable for text overlay.`;
            backgroundImageUrl = await generateGeminiImage(apiKey, imagePrompt, aspectRatio);
            if (backgroundImageUrl) { lastBackgroundImageUrl = backgroundImageUrl; addSystemMessage('Gemini ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ.'); }
          } catch (imgErr) {
            const errMsg = imgErr?.message || String(imgErr);
            addSystemMessage('Gemini ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ' + errMsg + ' (ë°°ê²½ ì—†ìŒ)');
          }
          backgroundImageUrl = backgroundImageUrl || lastBackgroundImageUrl || GEMINI_IMAGE_FALLBACK;
        }
        if (isAdd && (designRows[0]?.length || 0) > 0 && !shouldGenBg) {
          try {
            updateLoadingStatus('bg', 25);
            const imagePrompt = `Create a NEW unique background/main image for an additional Korean ad design. Aspect ratio: ${aspectRatio}.

[í•„ìˆ˜ ìš”ì²­ ë‚´ìš© - ë°˜ë“œì‹œ ì •í™•íˆ ë”°ë¥¼ ê²ƒ]
${prompt}

Output: Different from previous designs. High-quality photorealistic. Avoid generic stock look. Distinctive imagery. Suitable for text overlay.`;
            backgroundImageUrl = await generateGeminiImage(apiKey, imagePrompt, aspectRatio);
            if (backgroundImageUrl) addSystemMessage('Gemini ì¶”ê°€ ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ.');
          } catch (e) {
            const errMsg = e?.message || String(e);
            addSystemMessage('Gemini ì¶”ê°€ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ' + errMsg + ' (ë°°ê²½ ì—†ìŒ)');
          }
          backgroundImageUrl = backgroundImageUrl || lastBackgroundImageUrl || GEMINI_IMAGE_FALLBACK;
        }

        updateLoadingStatus('design', 50);
        const selectedIdx = isModify ? parseSelectedIndex(prompt) : 0;

        if (useParallel && parsedRequests) {
          let sharedBg = backgroundImageUrl || lastBackgroundImageUrl;
          if (!sharedBg) {
            try {
              updateLoadingStatus('bg', 30);
              const imgPrompt = `Create a professional background image for Korean web advertisement. Aspect ratio: ${aspectRatio}. Style based on: ${parsedRequests[0]}. Photorealistic, suitable for text overlay.`;
              sharedBg = await generateGeminiImage(apiKey, imgPrompt, aspectRatio);
              lastBackgroundImageUrl = sharedBg;
              addSystemMessage('Gemini ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ.');
            } catch (e) {
              addSystemMessage('Gemini ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e) + ' (ë°°ê²½ ì—†ìŒ)');
            }
            sharedBg = sharedBg || GEMINI_IMAGE_FALLBACK;
          }
          const fetchOne = async (req) => {
            const contents = [{ role: 'user', parts: [{ text: `[ê´‘ê³  ì†Œì¬ ì œì‘]\n\nâš ï¸ ë¬¸êµ¬ëŠ” ê¸€ì ê·¸ëŒ€ë¡œ ì‚¬ìš©.\n\n---\n${req}\n---\n\n[ì¶œë ¥] HTML ì½”ë“œë§Œ. ì½”ë“œ ë¸”ë¡ 1ê°œ.` }] }];
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }, generationConfig: { temperature: 0.4, maxOutputTokens: 8192 } }) });
            const data = await res.json();
            if (!res.ok) throw new Error(parseGeminiError(data, 'API ìš”ì²­ ì‹¤íŒ¨'));
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            return extractHtmlFromResponse(text) || text;
          };
          const results = await Promise.all(parsedRequests.map(fetchOne));
          const blocks = results.filter(Boolean).map(overlay => ({ bg: sharedBg, overlay }));
          if (blocks.length > 0) {
            designRows = blocks.map(b => [b]);
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: blocks[0]?.overlay || '' });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            lastBackgroundImageUrl = sharedBg;
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            addSystemMessage(`${blocks.length}ê°œ ì‘ì—…ì´ ë™ì‹œì— ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } else {
            addSystemMessage('ìƒì„±ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
        } else {
        const contents = buildContents(prompt, isModify, isAdd, selectedIdx, multiCount);
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }, generationConfig: { temperature: 0.4, maxOutputTokens: 16384 } }) });
        const data = await res.json();
        if (!res.ok) throw new Error(parseGeminiError(data, 'API ìš”ì²­ ì‹¤íŒ¨'));

        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const row1 = designRows[0] || [];
        const safeBg = (url) => url || GEMINI_IMAGE_FALLBACK;

        if (isModify && row1.length > 0) {
          const overlayHtml = extractHtmlFromResponse(text);
          if (overlayHtml) {
            const flatBlocks = designRows.flat();
            const idx = Math.min(selectedIdx, flatBlocks.length - 1);
            const modifiedBlock = { bg: flatBlocks[idx].bg, overlay: overlayHtml };
            designRows.push([modifiedBlock]);
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: overlayHtml });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            addSystemMessage('2í–‰ì— ìˆ˜ì •ë³¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            addMessage(text, false);
            addSystemMessage('HTML ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        } else if (isAdd && row1.length > 0) {
          const overlayHtml = extractHtmlFromResponse(text);
          if (overlayHtml) {
            const newBlock = { bg: backgroundImageUrl || row1[0].bg, overlay: overlayHtml };
            designRows[0].push(newBlock);
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: overlayHtml });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            addSystemMessage('1í–‰ì— ì‹œì•ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            addMessage(text, false);
            addSystemMessage('HTML ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        } else {
          const overlayList = extractMultipleHtmlFromResponse(text);
          if (overlayList.length > 0) {
            const blocks = overlayList.slice(0, 5).map(overlay => ({ bg: backgroundImageUrl || GEMINI_IMAGE_FALLBACK, overlay }));
            for (const b of blocks) {
              const ph = b.overlay.match(/\{\{IMAGE_\d+\}\}/g);
              if (ph) for (let i = 0; i < ph.length; i++) {
                try {
                  const imgData = await generateGeminiImage(apiKey, `Create a photorealistic image for Korean ad. [í•„ìˆ˜ ìš”ì²­]: ${prompt}`, aspectRatio);
                  b.overlay = b.overlay.replace(`{{IMAGE_${i + 1}}}`, imgData ? `<img src="${imgData}" alt="" style="max-width:100%;height:auto;">` : '');
                } catch (e) {
                  addSystemMessage(`ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€(${i + 1}) Gemini ìƒì„± ì‹¤íŒ¨: ${e?.message || e}`);
                  b.overlay = b.overlay.replace(`{{IMAGE_${i + 1}}}`, `<img src="${GEMINI_IMAGE_FALLBACK}" alt="ì´ë¯¸ì§€ ì—†ìŒ" style="max-width:100%;height:auto;">`);
                }
              }
            }
            designRows = [blocks];
            chatHistory.push({ role: 'user', text: prompt });
            chatHistory.push({ role: 'model', text: overlayList[0] || text });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
            renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
            addSystemMessage(`1í–‰ì— ${blocks.length}ê°œ ì‹œì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } else {
            const single = extractHtmlFromResponse(text);
            if (single) {
              designRows = [[{ bg: backgroundImageUrl || GEMINI_IMAGE_FALLBACK, overlay: single }]];
              chatHistory.push({ role: 'user', text: prompt });
              chatHistory.push({ role: 'model', text: single });
              renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
              addSystemMessage('ë Œë”ë§ ì™„ë£Œ.');
            } else {
              addMessage(text, false);
              addSystemMessage('HTML ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          }
        }
        }
      } catch (err) {
        addSystemMessage(err.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
      } finally {
        clearInterval(progressInterval);
        hideLoadingBar();
        if (activeMenu === 'image' || activeMenu === 'cardnews' || activeMenu === 'video') {
          saveCanvasHistory();
          renderCanvasHistory();
        }
      }
    }

    function sendDesignPrompt() {
      const p = promptInput.value.trim();
      if (!p && pendingAttachments.length === 0) return;
      promptInput.value = '';
      const attachments = pendingAttachments.slice();
      clearAttachments();
      const withAttachNote = attachments.length
        ? `${p}${p ? '\n\n' : ''}[ì²¨ë¶€íŒŒì¼] ${attachments.map(a => a.name).join(', ')}`
        : p;
      addMessage(withAttachNote, true, attachments);
      sendToGemini(withAttachNote, { attachments }).catch(err => {
        addSystemMessage('ì „ì†¡ ì˜¤ë¥˜: ' + (err?.message || err));
      });
    }

    async function applyCardnewsTone(tone) {
      const slides = designRows?.flat().filter(b => b?.cardnewsSlide) || [];
      if (slides.length === 0) return;
      pushDesignState();
      const apiKey = apiKeyInput.value.trim() || localStorage.getItem(STORAGE_KEY);
      if (!apiKey) { alert('Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const current = slides.map(s => ({ title: s.title, body: s.body })).map(o => JSON.stringify(o)).join('\n');
      addSystemMessage(`í†¤ì•¤ë§¤ë„ˆ '${tone}' ì ìš© ì¤‘...`);
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: 'user', parts: [{ text: `ë‹¤ìŒ ì¹´ë“œë‰´ìŠ¤ ë¬¸êµ¬ë¥¼ '${tone}' í†¤ì•¤ë§¤ë„ˆë¡œ ì¬ì‘ì„±í•´ì£¼ì„¸ìš”. ì¶œë ¥ì€ JSON ë°°ì—´ë§Œ: [{"title":"ì œëª©","body":"ë³¸ë¬¸"}, ...]\n\n${current}` }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error?.message || 'API ì˜¤ë¥˜');
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        text = text.replace(/```json\s*|\s*```/g, '').trim();
        let arr = [];
        try { arr = JSON.parse(text); } catch (_) {}
        if (!Array.isArray(arr) && arr?.slides) arr = arr.slides;
        if (Array.isArray(arr) && arr.length >= slides.length) {
          arr.slice(0, slides.length).forEach((item, i) => {
            if (slides[i] && item) { slides[i].title = item.title ?? slides[i].title; slides[i].body = item.body ?? slides[i].body; }
          });
          saveCanvasHistory();
          renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
          attachCardnewsContentEditable();
          addSystemMessage(`í†¤ì•¤ë§¤ë„ˆ '${tone}' ì ìš© ì™„ë£Œ.`);
        } else { addSystemMessage('ì‘ë‹µ í˜•ì‹ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
      } catch (e) { addSystemMessage('í†¤ì•¤ë§¤ë„ˆ ì ìš© ì‹¤íŒ¨: ' + (e?.message || e)); }
    }

    async function applyCardnewsSummarize() {
      const slides = designRows?.flat().filter(b => b?.cardnewsSlide) || [];
      if (slides.length === 0) return;
      pushDesignState();
      const apiKey = apiKeyInput.value.trim() || localStorage.getItem(STORAGE_KEY);
      if (!apiKey) { alert('Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const current = slides.map(s => ({ title: s.title, body: s.body })).map(o => JSON.stringify(o)).join('\n');
      addSystemMessage('í•µì‹¬ ìš”ì•½ ì¤‘...');
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: 'user', parts: [{ text: `ë‹¤ìŒ ì¹´ë“œë‰´ìŠ¤ ë¬¸êµ¬ë¥¼ ê°€ì¥ ì¤‘ìš”í•œ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹¤ë“¬ì–´ì£¼ì„¸ìš”. ì œëª© 10ì ì´ë‚´, ë³¸ë¬¸ 40ì ì´ë‚´. ì¶œë ¥ì€ JSON ë°°ì—´ë§Œ: [{"title":"ì œëª©","body":"ë³¸ë¬¸"}, ...]\n\n${current}` }] }],
            generationConfig: { temperature: 0.5, maxOutputTokens: 4096 }
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error?.message || 'API ì˜¤ë¥˜');
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        text = text.replace(/```json\s*|\s*```/g, '').trim();
        let arr = [];
        try { arr = JSON.parse(text); } catch (_) {}
        if (!Array.isArray(arr) && arr?.slides) arr = arr.slides;
        if (Array.isArray(arr) && arr.length >= slides.length) {
          arr.slice(0, slides.length).forEach((item, i) => {
            if (slides[i] && item) { slides[i].title = item.title ?? slides[i].title; slides[i].body = item.body ?? slides[i].body; }
          });
          saveCanvasHistory();
          renderHtml(buildRowsDisplayHtml(), buildDownloadHtml());
          attachCardnewsContentEditable();
          addSystemMessage('í•µì‹¬ ìš”ì•½ ì™„ë£Œ.');
        } else { addSystemMessage('ì‘ë‹µ í˜•ì‹ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
      } catch (e) { addSystemMessage('í•µì‹¬ ìš”ì•½ ì‹¤íŒ¨: ' + (e?.message || e)); }
    }

    document.getElementById('cardnews-tone-professional')?.addEventListener('click', () => applyCardnewsTone('ì „ë¬¸ì ì¸'));
    document.getElementById('cardnews-tone-friendly')?.addEventListener('click', () => applyCardnewsTone('ì¹œê·¼í•œ'));
    document.getElementById('cardnews-tone-emotional')?.addEventListener('click', () => applyCardnewsTone('ê°ì„±ì ì¸'));
    document.getElementById('cardnews-summarize')?.addEventListener('click', () => applyCardnewsSummarize());
    document.getElementById('header-rules-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const pop = document.getElementById('header-rules-popover');
      pop?.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      const pop = document.getElementById('header-rules-popover');
      if (pop && !pop.classList.contains('hidden') && !e.target.closest('#header-rules-btn') && !e.target.closest('#header-rules-popover')) pop.classList.add('hidden');
    });
    document.getElementById('header-rules-add-btn')?.addEventListener('click', () => {
      const input = document.getElementById('header-rules-input');
      if (input) { addDesignRule(input.value); input.value = ''; autoResizeRulesInput(input); }
    });
    document.getElementById('header-rules-input')?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); const input = e.target; addDesignRule(input.value); input.value = ''; autoResizeRulesInput(input); }
    });
    document.getElementById('ai-chat-rules-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const pop = document.getElementById('ai-chat-rules-popover');
      pop?.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      const pop = document.getElementById('ai-chat-rules-popover');
      if (pop && !pop.classList.contains('hidden') && !e.target.closest('#ai-chat-rules-btn') && !e.target.closest('#ai-chat-rules-popover')) pop.classList.add('hidden');
    });
    document.getElementById('ai-chat-rules-add-btn')?.addEventListener('click', () => {
      const input = document.getElementById('ai-chat-rules-input');
      if (input && activeMenu === 'chat') { addDesignRule(input.value); input.value = ''; autoResizeRulesInput(input); }
    });
    document.getElementById('ai-chat-rules-input')?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && activeMenu === 'chat') { e.preventDefault(); const input = e.target; addDesignRule(input.value); input.value = ''; autoResizeRulesInput(input); }
    });
    promptInput?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDesignPrompt(); }
    });

    previewIframe.srcdoc = buildRowsDisplayHtml();
    const savedView = localStorage.getItem(LAST_VIEW_KEY) || 'home';
    const lastView = ['home', 'chat', 'image', 'cardnews', 'video', 'shopping'].includes(savedView) ? savedView : 'home';
    switchView(lastView);
    })();
  </script>
</body>
</html>
